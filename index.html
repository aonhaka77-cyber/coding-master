<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MASTER PIECE - ULTIMATE</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        :root { --primary: #4f46e5; --bg: #f3f4f6; --text: #1f2937; --danger: #ef4444; --card: #ffffff; --tag: #dbeafe; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Pretendard', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: var(--text); padding-bottom: 80px; overflow-x: hidden; }
        
        /* Header & Nav */
        header { background: white; border-bottom: 1px solid #e5e7eb; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .header-top { max-width: 1200px; margin: 0 auto; padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; gap: 10px; }
        .logo { font-size: 18px; font-weight: 900; color: var(--primary); cursor: pointer; white-space: nowrap; }
        .search-box { flex-grow: 1; max-width: 400px; }
        .search-inp { width: 100%; padding: 8px 15px; border-radius: 20px; border: 1px solid #ddd; font-size: 16px; outline: none; }
        
        .nav-menu { max-width: 1200px; margin: 0 auto; padding: 0 15px; display: flex; gap: 15px; overflow-x: auto; -ms-overflow-style: none; scrollbar-width: none; }
        .nav-item { padding: 12px 5px; cursor: pointer; font-size: 14px; font-weight: 700; color: #6b7280; white-space: nowrap; border-bottom: 3px solid transparent; }
        .nav-item.active { color: var(--primary); border-bottom-color: var(--primary); }
        
        /* Layout */
        .main-container { max-width: 1200px; margin: 15px auto; padding: 0 10px; display: grid; grid-template-columns: 1fr 300px; gap: 20px; }
        @media (max-width: 900px) { .main-container { grid-template-columns: 1fr; } .sidebar { display: none; } }
        
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Elements */
        .card { background: var(--card); border-radius: 16px; padding: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 15px; }
        .btn { padding: 10px 18px; border: none; border-radius: 10px; cursor: pointer; font-weight: 700; transition: 0.2s; font-size: 13px; }
        .btn-p { background: var(--primary); color: white; }
        .btn-s { background: #f3f4f6; color: #4b5563; }
        .btn-danger { background: #fee2e2; color: var(--danger); }
        
        .item-row { padding: 15px; border-bottom: 1px solid #f3f4f6; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .tag { display: inline-block; padding: 2px 8px; background: var(--tag); color: #1e40af; border-radius: 6px; font-size: 11px; margin-right: 4px; }
        
        /* Modal & Parser */
        .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:2000; align-items:center; justify-content:center; padding: 20px; }
        .modal.active { display: flex; }
        .modal-content { background:white; padding:25px; border-radius:20px; width:100%; max-width:450px; }
        input, textarea { width:100%; padding:12px; margin-top:10px; border:1px solid #ddd; border-radius:10px; font-size: 16px; }
        .namu-content b { font-weight: bold; color: #333; }
        .namu-content blockquote { border-left: 4px solid var(--primary); padding: 5px 10px; background: #f9fafb; margin: 10px 0; }
        .badge { background: red; color: white; font-size: 10px; padding: 2px 5px; border-radius: 10px; position: absolute; top:-5px; right:-5px; border: 1px solid white; }
    </style>
</head>
<body>

<header>
    <div class="header-top">
        <div class="logo" onclick="goHome()">ğŸš€ MASTER PIECE</div>
        <div class="search-box">
            <input type="text" id="searchInput" class="search-inp" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥ í›„ ì—”í„°..." onkeyup="if(event.keyCode==13)handleSearch()">
        </div>
        <div style="display:flex; align-items:center; gap:12px;">
            <div style="position:relative; cursor:pointer;" onclick="toggleNoti()">ğŸ””<span id="notiCount" class="badge" style="display:none;">0</span></div>
            <div id="authArea"><button class="btn btn-p" onclick="openModal('loginModal')">ë¡œê·¸ì¸</button></div>
            <div id="userArea" style="display:none; cursor:pointer;" onclick="showPage('mypage')">
                <span id="welcomeMsg" style="font-weight:bold; font-size:14px;"></span>
            </div>
        </div>
    </div>
    <nav class="nav-menu">
        <div class="nav-item active" id="menu-home" onclick="goHome()">í™ˆ</div>
        <div class="nav-item" id="menu-notice" onclick="showBoard('notice')">ê³µì§€</div>
        <div class="nav-item" id="menu-free" onclick="showBoard('free')">ììœ </div>
        <div class="nav-item" id="menu-qna" onclick="showBoard('qna')">Q&A</div>
        <div class="nav-item" id="menu-inquiry" onclick="showPage('inquiry')">ë¬¸ì˜</div>
        <div class="nav-item" id="menu-admin" onclick="showPage('admin')" style="display:none; color:var(--danger)">ê´€ë¦¬ì ì „ìš©</div>
    </nav>
</header>

<div class="main-container">
    <div class="content-left">
        <div id="page-home" class="page active">
            <div class="card" style="background:var(--primary); color:white;">
                <h2>Welcome Back!</h2>
                <p>ì‹¤ì‹œê°„ ë°ì´í„° ë™ê¸°í™”ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.</p>
            </div>
            <div class="card"><h3>ğŸ”¥ ì¸ê¸° ê²Œì‹œê¸€</h3><div id="home-hot-posts"></div></div>
            <div class="card"><h3>ğŸ†• ìµœì‹  ê²Œì‹œê¸€</h3><div id="home-posts"></div></div>
        </div>

        <div id="page-board" class="page">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h2 id="board-title">ê²Œì‹œíŒ</h2>
                <button class="btn btn-p" onclick="openWriteModal()">ê¸€ì“°ê¸°</button>
            </div>
            <div id="post-list" class="card" style="padding:0;"></div>
        </div>

        <div id="page-detail" class="page">
            <div class="card">
                <div style="display:flex; justify-content:space-between;">
                    <span id="det-board-tag" class="tag"></span>
                    <button class="btn btn-s" style="font-size:11px;" onclick="reportItem('post', state.viewingId)">ğŸš¨ ì‹ ê³ </button>
                </div>
                <h1 id="det-title" style="margin-top:10px;"></h1>
                <p id="det-info" style="color:#888; font-size:12px; margin:10px 0;"></p>
                <hr style="margin:15px 0; border:0; border-top:1px solid #eee;">
                <div id="det-body" class="namu-content" style="line-height:1.7; min-height:100px; white-space:pre-wrap;"></div>
                <div style="margin-top:20px; text-align:center;">
                    <button class="btn btn-s" id="likeBtn" onclick="handleLikeToggle()">â¤ï¸ ì¢‹ì•„ìš” <span id="like-count">0</span></button>
                </div>
                <div style="margin-top:20px; display:flex; justify-content:flex-end; gap:10px;">
                    <button class="btn" id="pinBtn" style="display:none; background:orange; color:white;" onclick="togglePin()">ê³µì§€ë“±ë¡</button>
                    <button class="btn btn-danger" id="delBtn" style="display:none;" onclick="deletePost()">ì‚­ì œ</button>
                </div>
            </div>
            <div class="card">
                <h4>ëŒ“ê¸€ <span id="comm-count" style="color:var(--primary)">0</span></h4>
                <div id="comm-list" style="margin:15px 0;"></div>
                <div style="display:flex; gap:10px;">
                    <input type="text" id="commInp" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..." style="margin-top:0;">
                    <button class="btn btn-p" onclick="saveComment()">ë“±ë¡</button>
                </div>
            </div>
        </div>

        <div id="page-mypage" class="page"><div class="card"><h2 id="my-name"></h2><button class="btn btn-s" onclick="logout()" style="width:100%; margin-top:15px;">ë¡œê·¸ì•„ì›ƒ</button></div><div class="card"><h3>ë‚´ê°€ ì“´ ê¸€</h3><div id="my-posts"></div></div></div>
        <div id="page-inquiry" class="page"><div class="card"><h2>ğŸ“® ìš´ì˜ì§„ ë¬¸ì˜</h2><textarea id="inqInp" rows="4" placeholder="ë¬¸ì˜ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”."></textarea><button class="btn btn-p" style="width:100%; margin-top:10px;" onclick="sendInquiry()">ë¬¸ì˜í•˜ê¸°</button></div><div id="my-inquiry-list"></div></div>
        <div id="page-admin" class="page"><div class="card"><h3>ğŸš¨ ì‹ ê³  ê´€ë¦¬</h3><div id="admin-report-list"></div></div><div class="card"><h3>ğŸ“® ì „ì²´ ë¬¸ì˜</h3><div id="admin-inq-list"></div></div></div>
    </div>

    <div class="sidebar">
        <div class="card"><h4>ğŸ“Š í†µê³„</h4><div id="stats" style="font-size:13px; line-height:2;"></div></div>
    </div>
</div>

<div class="modal" id="loginModal"><div class="modal-content"><h2>ë¡œê·¸ì¸</h2><input type="text" id="l-id" placeholder="ì•„ì´ë””"><input type="password" id="l-pw" placeholder="ë¹„ë°€ë²ˆí˜¸"><button class="btn btn-p" style="width:100%; margin-top:15px;" onclick="handleLogin()">ë¡œê·¸ì¸</button><button class="btn btn-s" style="width:100%; margin-top:8px;" onclick="handleJoin()">íšŒì›ê°€ì…</button><button class="btn" style="width:100%; margin-top:8px;" onclick="closeModal('loginModal')">ì·¨ì†Œ</button></div></div>
<div class="modal" id="writeModal"><div class="modal-content"><h2>ê¸€ì“°ê¸°</h2><input type="text" id="w-title" placeholder="ì œëª©"><textarea id="w-content" rows="10" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”."></textarea><button class="btn btn-p" style="width:100%; margin-top:15px;" onclick="savePost()">ì‘ì„± ì™„ë£Œ</button><button class="btn btn-s" style="width:100%; margin-top:8px;" onclick="closeModal('writeModal')">ì·¨ì†Œ</button></div></div>
<div id="notiBox" class="card" style="display:none; position:fixed; top:65px; right:15px; width:280px; z-index:3000; border:1px solid #ddd;"><div style="display:flex; justify-content:space-between;"><b>ì•Œë¦¼</b><small onclick="clearNotis()" style="cursor:pointer; color:blue;">ì‚­ì œ</small></div><div id="notiList" style="font-size:12px; margin-top:10px;"></div></div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBcxvsiEOyL1lZGVr1UE2gzzZ7HQX5YfbI",
        authDomain: "code-78890.firebaseapp.com",
        projectId: "code-78890",
        storageBucket: "code-78890.firebasestorage.app",
        messagingSenderId: "30317586652",
        appId: "1:30317586652:web:d1e6fa39c319029fb7ac19"
    };
    firebase.initializeApp(firebaseConfig);
    const fdb = firebase.firestore();

    let state = { user: JSON.parse(localStorage.getItem('mp_user')) || null, posts: [], users: [], viewingId: null, currentBoard: 'free', commUnsub: null };

    // ì´ˆê¸°í™”
    async function init() {
        if(state.user) loginUI();
        
        fdb.collection("users").onSnapshot(s => {
            state.users = s.docs.map(d => d.data());
            updateStats();
        });

        fdb.collection("posts").orderBy("id", "desc").onSnapshot(s => {
            state.posts = s.docs.map(d => ({ fId: d.id, ...d.data() }));
            refreshUI();
        });

        setupInquiryListener();
        setupNotiListener();
        setupReportListener();
    }

    function parseNamu(t) {
        if(!t) return '';
        return t.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/--(.*?)--/g, '<del>$1</del>').replace(/> (.*)/g, '<blockquote>$1</blockquote>');
    }

    // ì¸ì¦
    async function handleLogin() {
        const id = document.getElementById('l-id').value, pw = document.getElementById('l-pw').value;
        const found = state.users.find(u => u.id === id && u.pw === pw);
        if(!found) return alert('ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
        state.user = found;
        localStorage.setItem('mp_user', JSON.stringify(state.user));
        location.reload();
    }

    async function handleJoin() {
        const id = document.getElementById('l-id').value, pw = document.getElementById('l-pw').value;
        if(state.users.find(u=>u.id===id)) return alert('ì¤‘ë³µ ì•„ì´ë””');
        await fdb.collection("users").add({ id, pw, role:'member', isBanned:false });
        alert('ê°€ì… ì™„ë£Œ');
    }

    function loginUI() {
        document.getElementById('authArea').style.display = 'none';
        document.getElementById('userArea').style.display = 'block';
        document.getElementById('welcomeMsg').innerText = state.user.id;
        if(state.user.role === 'admin') document.getElementById('menu-admin').style.display = 'block';
    }

    function logout() { localStorage.removeItem('mp_user'); location.reload(); }

    // ê²Œì‹œíŒ & ìƒì„¸
    function showBoard(b) { state.currentBoard = b; document.getElementById('board-title').innerText = b.toUpperCase(); showPage('board'); renderPostList(); }
    
    function renderPostList(custom = null) {
        const target = custom || state.posts.filter(p => p.board === state.currentBoard);
        document.getElementById('post-list').innerHTML = target.map(p => `
            <div class="item-row" onclick="viewPost('${p.fId}')">
                <div><b>${p.isPinned?'ğŸ“Œ':''} ${p.title}</b><br><small>${p.author} | ${p.date}</small></div>
                <div style="color:red; font-size:12px;">â¤ï¸ ${p.likes||0}</div>
            </div>
        `).join('') || '<p style="padding:20px; color:#999;">ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
    }

    function viewPost(fId) { state.viewingId = fId; showPage('detail'); renderDetail(fId); }

    function renderDetail(fId) {
        const p = state.posts.find(x => x.fId === fId);
        if(!p) return;
        document.getElementById('det-board-tag').innerText = p.board;
        document.getElementById('det-title').innerText = p.title;
        document.getElementById('det-info').innerText = `${p.author} | ${p.date}`;
        document.getElementById('det-body').innerHTML = parseNamu(p.content);
        document.getElementById('like-count').innerText = p.likes || 0;
        document.getElementById('delBtn').style.display = (state.user && (state.user.id===p.author || state.user.role==='admin')) ? 'block':'none';
        document.getElementById('pinBtn').style.display = (state.user && state.user.role==='admin') ? 'block':'none';

        if(state.commUnsub) state.commUnsub();
        // ìŠ¤í¬ë¦°ìƒ· ë°ì´í„° êµ¬ì¡° ë°˜ì˜: date(Number), postId(String), text(String), user(String)
        state.commUnsub = fdb.collection("comments").where("postId","==",fId).orderBy("date","asc").onSnapshot(s => {
            const list = s.docs.map(d => ({cid: d.id, ...d.data()}));
            document.getElementById('comm-count').innerText = list.length;
            document.getElementById('comm-list').innerHTML = list.map(c => `
                <div style="padding:10px; background:#f9fafb; margin-bottom:5px; border-radius:8px; font-size:13px;">
                    <b>${c.user}</b>: ${c.text} <span style="float:right; cursor:pointer; color:#ccc;" onclick="reportItem('comment','${c.cid}')">ì‹ ê³ </span>
                </div>
            `).join('');
        });
    }

    async function saveComment() {
        if(!state.user) return alert('ë¡œê·¸ì¸ í•„ìš”');
        const text = document.getElementById('commInp').value;
        if(!text) return;
        // ìŠ¤í¬ë¦°ìƒ· êµ¬ì¡°ì— ë§ì¶° ì €ì¥
        await fdb.collection("comments").add({ postId: state.viewingId, user: state.user.id, text, date: Date.now() });
        document.getElementById('commInp').value = '';
    }

    // ê¸°ëŠ¥ë“¤
    async function savePost() {
        const title = document.getElementById('w-title').value, content = document.getElementById('w-content').value;
        if(!title || !content) return;
        await fdb.collection("posts").add({ board: state.currentBoard, title, content, author: state.user.id, date: new Date().toLocaleDateString(), likes:0, likedBy:[], id:Date.now(), isPinned:false });
        closeModal('writeModal');
    }

    async function handleLikeToggle() {
        const p = state.posts.find(x => x.fId === state.viewingId);
        const ref = fdb.collection("posts").doc(state.viewingId);
        if(p.likedBy.includes(state.user.id)) {
            await ref.update({ likes: firebase.firestore.FieldValue.increment(-1), likedBy: firebase.firestore.FieldValue.arrayRemove(state.user.id) });
        } else {
            await ref.update({ likes: firebase.firestore.FieldValue.increment(1), likedBy: firebase.firestore.FieldValue.arrayUnion(state.user.id) });
        }
    }

    function handleSearch() {
        const q = document.getElementById('searchInput').value;
        const res = state.posts.filter(p => p.title.includes(q) || p.content.includes(q));
        showBoard('ê²€ìƒ‰ê²°ê³¼'); renderPostList(res);
    }

    async function reportItem(type, targetId) {
        const reason = prompt('ì‹ ê³  ì‚¬ìœ ?');
        if(reason) await fdb.collection("reports").add({ type, targetId, reason, reporter: state.user.id, date: new Date().toLocaleString() });
    }

    // ë¦¬ìŠ¤ë„ˆ & ìœ í‹¸
    function setupNotiListener() {
        if(!state.user) return;
        fdb.collection("notis").where("to","==",state.user.id).where("read","==",false).onSnapshot(s => {
            document.getElementById('notiCount').innerText = s.size;
            document.getElementById('notiCount').style.display = s.size>0?'block':'none';
            document.getElementById('notiList').innerHTML = s.docs.map(d => `<div style="padding:5px; border-bottom:1px solid #eee;">${d.data().msg}</div>`).join('');
        });
    }

    function setupInquiryListener() {
        fdb.collection("inq").onSnapshot(s => {
            const all = s.docs.map(d => ({fId: d.id, ...d.data()}));
            if(state.user) {
                const mine = all.filter(i => i.user === state.user.id);
                document.getElementById('my-inquiry-list').innerHTML = mine.map(m => `<div class="card">ì§ˆë¬¸: ${m.content}<br>ë‹µë³€: ${m.reply || 'ëŒ€ê¸°ì¤‘'}</div>`).join('');
            }
            if(state.user?.role === 'admin') {
                document.getElementById('admin-inq-list').innerHTML = all.map(i => `<div class="card">${i.user}: ${i.content}<br><button onclick="replyInq('${i.fId}')">ë‹µë³€</button></div>`).join('');
            }
        });
    }

    async function sendInquiry() {
        const text = document.getElementById('inqInp').value;
        await fdb.collection("inq").add({ user: state.user.id, content: text, date: Date.now(), reply: null });
        document.getElementById('inqInp').value = '';
    }

    function setupReportListener() {
        fdb.collection("reports").onSnapshot(s => {
            if(state.user?.role === 'admin') {
                document.getElementById('admin-report-list').innerHTML = s.docs.map(d => `<div class="card">[${d.data().type}] ì‚¬ìœ : ${d.data().reason}</div>`).join('');
            }
        });
    }

    function refreshUI() {
        renderHome();
        if(document.getElementById('page-board').classList.contains('active')) renderPostList();
    }

    function renderHome() {
        const hot = state.posts.filter(p => p.likes >= 5).slice(0,5);
        document.getElementById('home-hot-posts').innerHTML = hot.map(p => `<div class="item-row" onclick="viewPost('${p.fId}')">${p.title} <b>â¤ï¸ ${p.likes}</b></div>`).join('');
        document.getElementById('home-posts').innerHTML = state.posts.slice(0,5).map(p => `<div class="item-row" onclick="viewPost('${p.fId}')">${p.title}</div>`).join('');
    }

    function showPage(p) {
        document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
        document.getElementById('page-'+p).classList.add('active');
        if(p==='mypage') document.getElementById('my-name').innerText = state.user.id + 'ë‹˜ì˜ ë§ˆì´í˜ì´ì§€';
    }

    function goHome() { state.viewingId = null; showPage('home'); }
    function openModal(id) { document.getElementById(id).classList.add('active'); }
    function closeModal(id) { document.getElementById(id).classList.remove('active'); }
    function openWriteModal() { if(!state.user) return alert('ë¡œê·¸ì¸ í•˜ì„¸ìš”'); openModal('writeModal'); }
    function toggleNoti() { const b = document.getElementById('notiBox'); b.style.display = b.style.display==='none'?'block':'none'; }
    function updateStats() { document.getElementById('stats').innerHTML = `ìœ ì €: ${state.users.length}ëª…<br>ê²Œì‹œê¸€: ${state.posts.length}ê°œ`; }

    window.onload = init;
</script>
</body>
</html>
