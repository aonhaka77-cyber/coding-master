<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MASTER PIECE - TOTAL CONTROL PRO</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        :root { --primary: #4f46e5; --primary-soft: #eef2ff; --bg: #f8fafc; --card: #ffffff; --text: #1e293b; --danger: #ef4444; --admin: #7c3aed; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Pretendard', -apple-system, sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: var(--text); padding-bottom: 60px; line-height: 1.5; }
        
        /* Header & Nav */
        header { background: white; border-bottom: 1px solid #e2e8f0; position: sticky; top: 0; z-index: 1000; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .h-wrap { max-width: 1100px; margin: 0 auto; padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; gap: 15px; }
        .logo { font-size: 20px; font-weight: 800; color: var(--primary); cursor: pointer; letter-spacing: -0.5px; }
        .search-input { width: 100%; padding: 10px 18px; border-radius: 25px; border: 1px solid #e2e8f0; background: #f1f5f9; outline: none; }
        
        .nav-scroller { background: white; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: center; overflow-x: auto; }
        .nav-item { padding: 14px 18px; font-size: 14px; font-weight: 700; color: #64748b; cursor: pointer; white-space: nowrap; border-bottom: 3px solid transparent; }
        .nav-item.active { color: var(--primary); border-bottom-color: var(--primary); }

        /* Layout */
        .main-grid { max-width: 1100px; margin: 20px auto; padding: 0 15px; display: grid; grid-template-columns: 1fr 280px; gap: 25px; }
        @media (max-width: 850px) { .main-grid { grid-template-columns: 1fr; } .sidebar { display: none; } }

        .card { background: var(--card); border-radius: 16px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 20px; border: 1px solid #f1f5f9; }
        .btn { padding: 10px 16px; border-radius: 10px; border: none; font-weight: 700; cursor: pointer; font-size: 13px; transition: 0.2s; }
        .btn-p { background: var(--primary); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-admin { background: var(--admin); color: white; }

        /* Pages */
        .page { display: none; animation: slideUp 0.3s ease-out; }
        .page.active { display: block; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Components */
        .list-item { padding: 15px; border-bottom: 1px solid #f8fafc; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .mention { color: var(--primary); font-weight: bold; background: var(--primary-soft); padding: 2px 4px; border-radius: 4px; }
        .namu-area blockquote { border-left: 5px solid #cbd5e1; padding: 10px 15px; background: #f8fafc; margin: 15px 0; }
        
        /* Modal & Noti */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 2000; align-items: center; justify-content: center; padding: 20px; }
        .modal.active { display: flex; }
        .modal-content { background: white; border-radius: 24px; padding: 30px; width: 100%; max-width: 480px; }
        input, textarea { width: 100%; padding: 12px; margin-top: 10px; border: 1px solid #ddd; border-radius: 10px; }
        .badge { background: var(--danger); color: white; font-size: 10px; padding: 2px 6px; border-radius: 10px; position: absolute; top: -5px; right: -8px; border: 2px solid white; }
        #notiBox { display: none; position: fixed; top: 75px; right: 20px; width: 300px; z-index: 3000; max-height: 400px; overflow-y: auto; }
    </style>
</head>
<body>

<header>
    <div class="h-wrap">
        <div class="logo" onclick="goHome()">MASTER PIECE</div>
        <div style="flex:1; max-width:400px;"><input type="text" id="mainSearch" class="search-input" placeholder="ê²€ìƒ‰..." onkeyup="if(event.keyCode==13)execSearch()"></div>
        <div style="display:flex; gap:15px; align-items:center;">
            <div style="position:relative; cursor:pointer;" onclick="toggleNotiBox()">ğŸ””<span id="notiCount" class="badge" style="display:none;">0</span></div>
            <div id="authBtnArea"><button class="btn btn-p" onclick="openModal('loginModal')">ë¡œê·¸ì¸</button></div>
            <div id="userInfoArea" style="display:none; cursor:pointer;" onclick="showPage('mypage')">
                <span id="userNick" style="font-weight:700; color:var(--primary);"></span>
            </div>
        </div>
    </div>
    <div class="nav-scroller">
        <div class="nav-item active" id="m-home" onclick="goHome()">í™ˆ</div>
        <div class="nav-item" id="m-notice" onclick="showBoard('notice')">ê³µì§€ì‚¬í•­</div>
        <div class="nav-item" id="m-free" onclick="showBoard('free')">ììœ ê²Œì‹œíŒ</div>
        <div class="nav-item" id="m-inquiry" onclick="showPage('inquiry')">1:1ë¬¸ì˜</div>
        <div class="nav-item" id="m-admin" onclick="showPage('admin')" style="display:none; color:var(--danger)">ê´€ë¦¬ë„êµ¬</div>
    </div>
</header>

<div class="main-grid">
    <div class="content-left">
        <div id="page-home" class="page active">
            <div class="card" style="background: linear-gradient(135deg, #4f46e5, #818cf8); color: white;">
                <h2>Welcome, Master Piece ğŸ¨</h2>
                <p>ëª¨ë“  ê¸°ëŠ¥ì´ ë³µêµ¬ë˜ê³  ìš´ì˜ì ê¶Œí•œì´ í†µí•©ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
            </div>
            <div class="card"><h3>ğŸ”¥ ì‹¤ì‹œê°„ ì¸ê¸°ê¸€</h3><div id="hot-posts"></div></div>
            <div class="card"><h3>ğŸ†• ìµœì‹  ê²Œì‹œê¸€</h3><div id="recent-posts"></div></div>
        </div>

        <div id="page-board" class="page">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h2 id="board-title-text">ê²Œì‹œíŒ</h2>
                <button class="btn btn-p" onclick="checkWriteAuth()">âœï¸ ê¸€ì“°ê¸°</button>
            </div>
            <div id="board-list-area" class="card" style="padding:0;"></div>
        </div>

        <div id="page-detail" class="page">
            <div class="card">
                <div style="display:flex; justify-content:space-between;"><span id="det-tag" class="tag"></span><button class="btn btn-danger" style="font-size:10px;" onclick="reportContent('post', state.viewingId)">ğŸš¨ ì‹ ê³ </button></div>
                <h1 id="det-title" style="margin:15px 0;"></h1>
                <div id="det-meta" style="font-size:13px; color:#64748b; margin-bottom:20px;"></div>
                <div id="det-content" class="namu-area" style="white-space:pre-wrap; min-height:100px;"></div>
                <div style="text-align:center; margin:30px 0;"><button class="btn btn-s" onclick="toggleLike()">â¤ï¸ ì¢‹ì•„ìš” <span id="det-likes">0</span></button></div>
                
                <div id="admin-tools" class="card" style="display:none; background:#fef2f2; border:1px dashed var(--danger);">
                    <p style="color:var(--danger); font-weight:800; font-size:12px; margin-bottom:10px;">ğŸ›¡ï¸ ìš´ì˜ì ì ˆëŒ€ ê¶Œí•œ</p>
                    <div style="display:flex; gap:5px; flex-wrap:wrap;">
                        <button class="btn btn-admin" onclick="adminCommand('pin')">ğŸ“Œ ê³µì§€ë“±ë¡/í•´ì œ</button>
                        <button class="btn btn-danger" onclick="adminCommand('delete')">ğŸ—‘ï¸ ê¸€ì‚­ì œ</button>
                        <button class="btn btn-admin" onclick="adminCommand('promote')">ğŸ–ï¸ ìš´ì˜ììŠ¹ê¸‰</button>
                        <button class="btn btn-admin" onclick="adminCommand('mute')">ğŸ”‡ ë®¤íŠ¸</button>
                        <button class="btn btn-admin" onclick="adminCommand('ban')">ğŸš« ì°¨ë‹¨</button>
                        <button class="btn btn-admin" onclick="adminCommand('kick')">ğŸ‘¢ í‚¥(ë¡œê·¸ì•„ì›ƒ)</button>
                        <button class="btn btn-admin" onclick="adminCommand('ipban')">ğŸŒ IPë°´</button>
                    </div>
                </div>
            </div>
            <div class="card">
                <h4>ëŒ“ê¸€ <span id="det-comm-cnt">0</span></h4>
                <div id="comm-container" style="margin:15px 0;"></div>
                <div style="display:flex; gap:10px;"><input type="text" id="commInput" placeholder="@ì•„ì´ë”” ë©˜ì…˜ ê°€ëŠ¥"><button class="btn btn-p" onclick="submitComment()">ë“±ë¡</button></div>
            </div>
        </div>

        <div id="page-mypage" class="page">
            <div class="card" style="text-align:center;">
                <h2 id="my-id-display"></h2>
                <button class="btn btn-danger" onclick="handleLogout()" style="margin-top:15px; width:100%;">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
            <div class="card"><h3>ë‚´ê°€ ì“´ ê¸€</h3><div id="my-posts-list"></div></div>
        </div>

        <div id="page-inquiry" class="page">
            <div class="card"><h3>ğŸ“® ìš´ì˜ì§„ 1:1 ë¬¸ì˜</h3><textarea id="inqText" rows="4" placeholder="ë¬¸ì˜ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea><button class="btn btn-p" style="width:100%; margin-top:10px;" onclick="submitInquiry()">ë¬¸ì˜í•˜ê¸°</button></div>
            <div id="my-inq-status"></div>
        </div>

        <div id="page-admin" class="page">
            <div class="card"><h3>ğŸš¨ ì‹¤ì‹œê°„ ì‹ ê³  ë‚´ì—­</h3><div id="admin-reports"></div></div>
            <div class="card"><h3>ğŸ“§ ê³ ê° ë¬¸ì˜ ë‹µë³€ ê´€ë¦¬</h3><div id="admin-inquiries"></div></div>
        </div>
    </div>

    <div class="sidebar">
        <div class="card"><h4>ğŸ“Š í†µê³„</h4><div id="stat-area" style="font-size:14px; margin-top:10px;">ìœ ì €: <b id="stat-u">-</b>ëª…<br>ê²Œì‹œê¸€: <b id="stat-p">-</b>ê°œ</div></div>
    </div>
</div>

<div id="notiBox" class="card">
    <div style="display:flex; justify-content:space-between; margin-bottom:10px;"><b>ìµœì‹  ì•Œë¦¼</b><small onclick="markAllRead()" style="color:var(--primary); cursor:pointer;">ì „ì²´ ì½ìŒ</small></div>
    <div id="notiList"></div>
</div>

<div class="modal" id="loginModal"><div class="modal-content"><h2>ë¡œê·¸ì¸</h2><input type="text" id="loginId" placeholder="ì•„ì´ë””"><input type="password" id="loginPw" placeholder="ë¹„ë°€ë²ˆí˜¸"><button class="btn btn-p" style="width:100%; margin-top:15px;" onclick="doLogin()">ë¡œê·¸ì¸</button><button class="btn btn-s" style="width:100%; margin-top:10px;" onclick="doJoin()">íšŒì›ê°€ì…</button><p onclick="closeModal('loginModal')" style="text-align:center; cursor:pointer; margin-top:10px; font-size:12px;">ë‹«ê¸°</p></div></div>
<div class="modal" id="writeModal"><div class="modal-content" style="max-width:700px;"><h2>ê¸€ì“°ê¸°</h2><input type="text" id="w-title" placeholder="ì œëª©"><textarea id="w-content" rows="12" placeholder="ë‚´ìš©..."></textarea><button class="btn btn-p" style="width:100%; margin-top:15px;" onclick="savePost()">ì‘ì„± ì™„ë£Œ</button></div></div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBcxvsiEOyL1lZGVr1UE2gzzZ7HQX5YfbI",
        authDomain: "code-78890.firebaseapp.com",
        projectId: "code-78890",
        storageBucket: "code-78890.firebasestorage.app",
        messagingSenderId: "30317586652",
        appId: "1:30317586652:web:d1e6fa39c319029fb7ac19"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let state = { user: JSON.parse(localStorage.getItem('mp_session')) || null, posts: [], viewingId: null, board: 'free' };

    async function init() {
        if(state.user) {
            if(state.user.id === 'ê³„ì†ë°˜ë³µ') state.user.role = 'admin'; // ìš´ì˜ì ê°•ì œê¶Œí•œ
            updateAuthUI();
            setupNotificationListener();
            checkUserStatus();
        }
        
        db.collection("posts").orderBy("id", "desc").onSnapshot(snap => {
            state.posts = snap.docs.map(d => ({ fId: d.id, ...d.data() }));
            renderHome();
            if(document.getElementById('page-board').classList.contains('active')) renderBoardList();
            if(state.viewingId) renderDetail(state.viewingId);
        });

        db.collection("users").onSnapshot(s => { document.getElementById('stat-u').innerText = s.size; });
        db.collection("posts").onSnapshot(s => { document.getElementById('stat-p').innerText = s.size; });
        
        setupInquiryListener();
        if(state.user?.role === 'admin') setupAdminListener();
    }

    // íŒŒì„œ (ë©˜ì…˜ í¬í•¨)
    function namuParser(text) {
        if(!text) return "";
        return text.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/> (.*)/g, '<blockquote>$1</blockquote>').replace(/@([\wê°€-í£]+)/g, '<span class="mention">@$1</span>');
    }

    // ì¸ì¦
    async function doLogin() {
        const id = document.getElementById('loginId').value, pw = document.getElementById('loginPw').value;
        const res = await db.collection("users").where("id","==",id).where("pw","==",pw).get();
        if(res.empty) return alert("ì‹¤íŒ¨");
        const userData = res.docs[0].data();
        if(userData.isBanned) return alert("ì°¨ë‹¨ë¨");
        state.user = userData;
        localStorage.setItem('mp_session', JSON.stringify(state.user));
        location.reload();
    }
    async function doJoin() {
        const id = document.getElementById('loginId').value, pw = document.getElementById('loginPw').value;
        await db.collection("users").add({ id, pw, role:'member', isBanned:false, isMuted:false, status:'active' });
        alert("ê°€ì…ì™„ë£Œ");
    }
    function handleLogout() { localStorage.removeItem('mp_session'); location.reload(); }
    function updateAuthUI() {
        document.getElementById('authBtnArea').style.display = 'none';
        document.getElementById('userInfoArea').style.display = 'block';
        document.getElementById('userNick').innerText = state.user.id + "ë‹˜";
        if(state.user.role === 'admin') document.getElementById('m-admin').style.display = 'block';
    }

    // ìš´ì˜ì ëª…ë ¹ í†µí•© ì²˜ë¦¬
    async function adminCommand(type) {
        const post = state.posts.find(p => p.fId === state.viewingId);
        const targetId = post.author;
        const uSnap = await db.collection("users").where("id","==",targetId).get();
        const uDocId = uSnap.empty ? null : uSnap.docs[0].id;

        if(type === 'pin') await db.collection("posts").doc(state.viewingId).update({ isPinned: !post.isPinned });
        if(type === 'delete') { await db.collection("posts").doc(state.viewingId).delete(); goHome(); }
        if(uDocId) {
            if(type === 'promote') await db.collection("users").doc(uDocId).update({ role: 'admin' });
            if(type === 'mute') await db.collection("users").doc(uDocId).update({ isMuted: true });
            if(type === 'ban') await db.collection("users").doc(uDocId).update({ isBanned: true });
            if(type === 'kick') await db.collection("users").doc(uDocId).update({ status: 'kicked' });
        }
        if(type === 'ipban') alert("IP(127.0.0.1)ê°€ ë¸”ë™ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.");
        alert("ëª…ë ¹ ì™„ë£Œ");
    }

    // ì•Œë¦¼ ë¦¬ìŠ¤ë„ˆ (ë³µêµ¬)
    function setupNotificationListener() {
        db.collection("notis").where("to","==",state.user.id).where("read","==",false).onSnapshot(s => {
            document.getElementById('notiCount').innerText = s.size;
            document.getElementById('notiCount').style.display = s.size > 0 ? 'block' : 'none';
            document.getElementById('notiList').innerHTML = s.docs.map(d => `<div style="padding:10px; border-bottom:1px solid #eee;" onclick="markRead('${d.id}')">${d.data().msg}</div>`).join('') || 'ì•Œë¦¼ ì—†ìŒ';
        });
    }
    async function markRead(id) { await db.collection("notis").doc(id).update({ read: true }); }
    async function markAllRead() { 
        const snap = await db.collection("notis").where("to","==",state.user.id).get();
        const batch = db.batch(); snap.forEach(d => batch.update(d.ref, {read:true})); await batch.commit();
    }

    // 1:1 ë¬¸ì˜ & ë‹µë³€ (ìš´ì˜ì ë‹µë³€ ê¸°ëŠ¥ í†µí•©)
    async function submitInquiry() {
        const text = document.getElementById('inqText').value;
        await db.collection("inquiries").add({ user: state.user.id, content: text, reply: null, date: Date.now() });
        document.getElementById('inqText').value = '';
    }
    function setupInquiryListener() {
        db.collection("inquiries").onSnapshot(s => {
            const all = s.docs.map(d => ({ fId: d.id, ...d.data() }));
            if(state.user) {
                const mine = all.filter(i => i.user === state.user.id);
                document.getElementById('my-inq-status').innerHTML = mine.map(m => `<div class="card">Q: ${m.content}<br><b style="color:blue">A: ${m.reply || 'ëŒ€ê¸°ì¤‘'}</b></div>`).join('');
            }
            if(state.user?.role === 'admin') {
                document.getElementById('admin-inquiries').innerHTML = all.map(i => `
                    <div style="padding:10px; border-bottom:1px solid #eee;">
                        <b>${i.user}</b>: ${i.content}<br>
                        <input type="text" id="rep-${i.fId}" value="${i.reply || ''}">
                        <button class="btn btn-admin" onclick="replyInq('${i.fId}')">ë‹µë³€</button>
                    </div>`).join('');
            }
        });
    }
    async function replyInq(fId) {
        const txt = document.getElementById('rep-'+fId).value;
        await db.collection("inquiries").doc(fId).update({ reply: txt });
        alert("ì „ì†¡ë¨");
    }

    // ë§ˆì´í˜ì´ì§€ ë Œë”ë§ (ë³µêµ¬)
    function renderMyPage() {
        document.getElementById('my-id-display').innerText = state.user.id;
        const mine = state.posts.filter(p => p.author === state.user.id);
        document.getElementById('my-posts-list').innerHTML = mine.map(p => `<div class="list-item" onclick="viewDetail('${p.fId}')">${p.title}</div>`).join('') || 'ê¸€ ì—†ìŒ';
    }

    // ìƒì„¸ ë³´ê¸°
    function renderDetail(fId) {
        const p = state.posts.find(x => x.fId === fId);
        if(!p) return;
        document.getElementById('det-title').innerText = p.title;
        document.getElementById('det-meta').innerText = `${p.author} â€¢ ${p.date}`;
        document.getElementById('det-content').innerHTML = namuParser(p.content);
        document.getElementById('det-likes').innerText = p.likes || 0;
        if(state.user?.role === 'admin') document.getElementById('admin-tools').style.display = 'block';
        
        db.collection("comments").where("postId","==",fId).onSnapshot(s => {
            const cms = s.docs.map(d => d.data()).sort((a,b) => a.date - b.date);
            document.getElementById('det-comm-cnt').innerText = cms.length;
            document.getElementById('comm-container').innerHTML = cms.map(c => `<div style="padding:8px; border-bottom:1px solid #eee;"><b>${c.user}</b>: ${namuParser(c.text)}</div>`).join('');
        });
    }

    async function submitComment() {
        if(state.user.isMuted) return alert("ë®¤íŠ¸ë¨");
        const txt = document.getElementById('commInput').value;
        const post = state.posts.find(x => x.fId === state.viewingId);
        await db.collection("comments").add({ postId: state.viewingId, user: state.user.id, text: txt, date: Date.now() });
        if(post.author !== state.user.id) {
            await db.collection("notis").add({ to: post.author, msg: `ë‚´ ê¸€ì— ëŒ“ê¸€ì´ ë‹¬ë ¸ìŠµë‹ˆë‹¤: ${txt.substring(0,10)}`, read: false, date: Date.now() });
        }
        document.getElementById('commInput').value = '';
    }

    // ìœ í‹¸ë¦¬í‹°
    function goHome() { state.viewingId = null; showPage('home'); }
    function showBoard(b) { state.board = b; showPage('board'); document.getElementById('board-title-text').innerText = b; renderBoardList(); }
    function renderBoardList() {
        const list = state.posts.filter(p => p.board === state.board);
        document.getElementById('board-list-area').innerHTML = list.map(p => `<div class="list-item" onclick="viewDetail('${p.fId}')">${p.isPinned?'ğŸ“Œ':''} ${p.title} <small>${p.author}</small></div>`).join('');
    }
    async function savePost() {
        const title = document.getElementById('w-title').value, content = document.getElementById('w-content').value;
        await db.collection("posts").add({ board: state.board, title, content, author: state.user.id, date: new Date().toLocaleDateString(), likes: 0, likedBy: [], id: Date.now(), isPinned: false });
        closeModal('writeModal');
    }
    function showPage(p) { 
        document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
        document.getElementById('page-'+p).classList.add('active');
        if(p === 'mypage') renderMyPage();
    }
    function checkUserStatus() { db.collection("users").where("id","==",state.user.id).onSnapshot(s => { if(s.docs[0].data().status === 'kicked') logout(); }); }
    function toggleNotiBox() { const n = document.getElementById('notiBox'); n.style.display = n.style.display === 'none' ? 'block' : 'none'; }
    function openModal(id) { document.getElementById(id).classList.add('active'); }
    function closeModal(id) { document.getElementById(id).classList.remove('active'); }
    function renderHome() {
        document.getElementById('hot-posts').innerHTML = state.posts.filter(p => p.likes >= 5).slice(0,3).map(p => `<div class="list-item" onclick="viewDetail('${p.fId}')">${p.title}</div>`).join('');
        document.getElementById('recent-posts').innerHTML = state.posts.slice(0,5).map(p => `<div class="list-item" onclick="viewDetail('${p.fId}')">${p.title}</div>`).join('');
    }

    window.onload = init;
</script>
</body>
</html>
