<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì½”ë”© ë§ˆìŠ¤í„° - íŒŒì´ì–´ë² ì´ìŠ¤ ì—ë””ì…˜</title>
    <style>
        /* --- ë””ìì¸ ì‹œìŠ¤í…œ (ê¸°ì¡´ ìœ ì§€) --- */
        :root { --primary: #667eea; --secondary: #764ba2; --bg: #f8f9fa; --text: #222; --danger: #e74c3c; --accent: #f39c12; --card-bg: #ffffff; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg); color: var(--text); line-height: 1.6; overflow-y: scroll; }
        
        header { background: white; border-bottom: 1px solid #e5e5e5; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .header-top { max-width: 1200px; margin: 0 auto; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; gap: 15px; }
        .logo { font-size: 22px; font-weight: 900; color: var(--primary); cursor: pointer; letter-spacing: -1px; }
        .search-bar { flex: 1; max-width: 400px; }
        .search-bar input { width: 100%; padding: 10px 18px; border-radius: 25px; border: 1px solid #ddd; background: #f1f3f5; font-size: 14px; transition: 0.3s; }
        .search-bar input:focus { background: white; border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2); }

        .nav-menu { max-width: 1200px; margin: 0 auto; padding: 0 20px; display: flex; gap: 25px; overflow-x: auto; }
        .nav-item { padding: 15px 5px; cursor: pointer; font-size: 14px; font-weight: 700; color: #777; border-bottom: 3px solid transparent; white-space: nowrap; transition: 0.2s; }
        .nav-item:hover { color: var(--primary); }
        .nav-item.active { color: var(--primary); border-bottom-color: var(--primary); }

        .main-container { max-width: 1200px; margin: 25px auto; padding: 0 20px; display: grid; grid-template-columns: 1fr 320px; gap: 25px; }
        @media (max-width: 950px) { .main-container { grid-template-columns: 1fr; } }

        .page { display: none; min-height: 600px; }
        .page.active { display: block; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .card { background: var(--card-bg); border-radius: 16px; padding: 25px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 25px; border: 1px solid #eee; }
        .ad-banner { background: linear-gradient(135deg, #222, #444); color: white; border-radius: 16px; padding: 40px; margin-bottom: 25px; position: relative; overflow: hidden; }
        .btn { padding: 11px 22px; border: none; border-radius: 10px; cursor: pointer; font-weight: 700; font-size: 14px; transition: 0.2s; display: inline-flex; align-items: center; justify-content: center; }
        .btn-p { background: var(--primary); color: white; }
        .btn-p:hover { background: var(--secondary); transform: translateY(-1px); }
        .btn-s { background: #f0f2f5; color: #444; }
        .btn-danger { background: var(--danger); color: white; }

        .post-body { font-size: 16px; line-height: 1.8; color: #333; padding: 20px 0; border-top: 1px solid #f0f0f0; }
        .post-body blockquote { border-left: 5px solid var(--primary); background: #f8f9ff; padding: 15px; margin: 15px 0; }
        
        .item-row { padding: 15px; border-bottom: 1px solid #f5f7f9; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: 0.2s; }
        .item-row:hover { background: #fcfdfe; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .modal.active { display: flex; }
        .modal-content { background: white; width: 90%; max-width: 550px; padding: 35px; border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.2); }
        input, textarea { width: 100%; padding: 12px 15px; border: 1px solid #ddd; border-radius: 10px; margin-top: 8px; font-size: 14px; }
        textarea { resize: none; font-family: inherit; }
        .home-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 650px) { .home-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<header>
    <div class="header-top">
        <div class="logo" onclick="goHome()">ğŸš€ CODING MASTER</div>
        <div class="search-bar">
            <input type="text" id="globalSearch" placeholder="ë¬´ì—‡ì„ ì°¾ìœ¼ì‹œë‚˜ìš”?">
        </div>
        <div id="authArea">
            <button class="btn btn-s" id="openLoginBtn" style="margin-right:8px;">ë¡œê·¸ì¸</button>
            <button class="btn btn-p" id="openJoinBtn">íšŒì›ê°€ì…</button>
        </div>
        <div id="userArea" style="display:none; align-items:center; gap:12px;">
            <span id="welcomeMsg" style="font-weight:800; font-size:14px; color:var(--primary);"></span>
            <button class="btn btn-s" id="logoutBtn">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
    </div>
    <nav class="nav-menu" id="mainNav">
        <div class="nav-item active" data-page="home">í™ˆ</div>
        <div class="nav-item" data-board="notice">ê³µì§€ì‚¬í•­</div>
        <div class="nav-item" data-board="free">ììœ ê²Œì‹œíŒ</div>
        <div class="nav-item" data-board="album">ê°¤ëŸ¬ë¦¬</div>
        <div class="nav-item" data-page="admin" id="menu-admin" style="display:none; color:var(--danger)">ğŸ‘‘ ê´€ë¦¬ì½˜ì†”</div>
    </nav>
</header>

<div class="main-container">
    <div class="content-left">
        <div id="page-home" class="page active">
            <div id="ad-container" class="ad-banner"></div>
            <div class="home-grid">
                <div class="card">
                    <h3>ğŸ“¢ ìµœê·¼ ê³µì§€</h3>
                    <div id="home-notice-list" style="margin-top:15px;"></div>
                </div>
                <div class="card">
                    <h3 style="color:var(--accent);">â­ ìš´ì˜ì§„ í”½</h3>
                    <div id="home-pick-list" style="margin-top:15px;"></div>
                </div>
            </div>
            <div class="card">
                <h3>ğŸ†• ìµœê·¼ ì˜¬ë¼ì˜¨ ê¸€</h3>
                <div id="home-free-list" style="margin-top:15px;"></div>
            </div>
        </div>

        <div id="page-board" class="page">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2 id="board-title" style="font-size:24px; font-weight:800;">ê²Œì‹œíŒ</h2>
                <button class="btn btn-p" id="writeBtn">ê¸€ì“°ê¸°</button>
            </div>
            <div id="post-list" class="card" style="padding:10px;"></div>
        </div>

        <div id="page-detail" class="page">
            <div class="card">
                <div id="post-header"></div>
                <div id="post-body" class="post-body"></div>
                <div id="admin-tools" style="display:none; margin-top:25px; padding-top:20px; border-top:2px dashed #eee; gap:10px;">
                    <button class="btn btn-s" id="togglePickBtn">ì¶”ì²œê¸€ í† ê¸€</button>
                    <button class="btn btn-danger" id="deletePostBtn">ê²Œì‹œê¸€ ì‚­ì œ</button>
                </div>
            </div>
            <div class="card">
                <h4>ëŒ“ê¸€ <span id="cmt-count" style="color:var(--primary);">0</span></h4>
                <div id="comment-list" style="margin:20px 0;"></div>
                <div style="display:flex; gap:10px;">
                    <input type="text" id="comment-input" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”...">
                    <button class="btn btn-p" id="addCommentBtn">ë“±ë¡</button>
                </div>
            </div>
            <button class="btn btn-s" onclick="goBackList()">ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
        </div>

        <div id="page-admin" class="page">
            <h2>ğŸ‘‘ ê´€ë¦¬ ì„¼í„°</h2>
            <div class="card">
                <h3>ğŸ“¢ ê´‘ê³  ê´€ë¦¬</h3>
                <div style="display:grid; gap:10px; margin-top:15px;">
                    <input type="text" id="adInpTitle" placeholder="ì œëª©">
                    <input type="text" id="adInpText" placeholder="ë‚´ìš©">
                    <button class="btn btn-p" id="addAdBtn">ë“±ë¡</button>
                </div>
                <div id="admin-ad-list" style="margin-top:20px;"></div>
            </div>
        </div>
    </div>

    <div class="sidebar">
        <div class="card">
            <h4>ğŸ“ˆ í†µê³„</h4>
            <div style="margin-top:10px; font-size:14px; display:grid; gap:8px;">
                <div style="display:flex; justify-content:space-between;"><span>ì „ì²´ ê²Œì‹œê¸€</span><b id="stat-posts">0</b></div>
            </div>
        </div>
        <div class="card" id="myInfoCard" style="display:none; background: #f8f9ff;">
            <h4 id="myName">ì‚¬ìš©ìë‹˜</h4>
            <p id="myRole" style="font-size:12px; color:var(--primary); font-weight:700;"></p>
        </div>
    </div>
</div>

<div class="modal" id="loginModal">
    <div class="modal-content">
        <h2>ë¡œê·¸ì¸</h2>
        <input type="text" id="loginId" placeholder="ë‹‰ë„¤ì„">
        <input type="password" id="loginPw" placeholder="ë¹„ë°€ë²ˆí˜¸">
        <button class="btn btn-p" id="loginSubmit" style="width:100%; margin-top:20px;">ì‹œì‘í•˜ê¸°</button>
        <button class="btn btn-s" onclick="closeModal('loginModal')" style="width:100%; margin-top:10px;">ë‹«ê¸°</button>
    </div>
</div>

<div class="modal" id="joinModal">
    <div class="modal-content">
        <h2>íšŒì›ê°€ì…</h2>
        <input type="text" id="joinId" placeholder="ë‹‰ë„¤ì„">
        <input type="password" id="joinPw" placeholder="ë¹„ë°€ë²ˆí˜¸">
        <button class="btn btn-p" id="joinSubmit" style="width:100%; margin-top:20px;">ê°€ì… ì™„ë£Œ</button>
        <button class="btn btn-s" onclick="closeModal('joinModal')" style="width:100%; margin-top:10px;">ì·¨ì†Œ</button>
    </div>
</div>

<div class="modal" id="writeModal">
    <div class="modal-content" style="max-width:700px;">
        <h2 id="writeModalTitle">ê¸€ ì‘ì„±</h2>
        <input type="text" id="writeTitle" placeholder="ì œëª©">
        <textarea id="writeContent" style="height:350px;" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
        <input type="file" id="fileInput">
        <img id="writeImgPreview" style="display:none; max-width:100%; margin-top:15px; border-radius:12px;">
        <button class="btn btn-p" id="savePostBtn" style="width:100%; margin-top:20px;">ì‘ì„± ì™„ë£Œ</button>
        <button class="btn btn-s" onclick="closeModal('writeModal')" style="width:100%; margin-top:10px;">ì·¨ì†Œ</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, getDoc, query, where, orderBy, limit, doc, deleteDoc, updateDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // âš ï¸ [í•„ë…] ì—¬ê¸° ë³¸ì¸ì˜ Firebase ì„¤ì •ê°’ìœ¼ë¡œ ë°˜ë“œì‹œ êµì²´í•˜ì„¸ìš”!
    const firebaseConfig = {
        apiKey: "AIzaSy...",
        authDomain: "your-project.firebaseapp.com",
        projectId: "your-project-id",
        storageBucket: "your-project.appspot.com",
        messagingSenderId: "...",
        appId: "..."
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ë‚´ë¶€ ìƒíƒœ ê´€ë¦¬
    let state = {
        currentUser: JSON.parse(localStorage.getItem('user')) || null,
        currentBoard: 'free',
        lastBoard: 'free',
        viewingPostId: null,
        tempImg: null
    };

    /* --- ìœ í‹¸ë¦¬í‹°: í˜ì´ì§€ ì „í™˜ --- */
    window.showPage = (pageId) => {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById('page-' + pageId).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        const nav = document.querySelector(`[data-page="${pageId}"]`);
        if (nav) nav.classList.add('active');
        if (pageId === 'home') renderHome();
    };

    window.showBoard = async (boardId) => {
        state.currentBoard = boardId;
        state.lastBoard = boardId;
        showPage('board');
        document.getElementById('board-title').innerText = 
            boardId === 'notice' ? 'ğŸ“¢ ê³µì§€ì‚¬í•­' : (boardId === 'album' ? 'ğŸ–¼ï¸ ê°¤ëŸ¬ë¦¬' : 'ğŸ’¬ ììœ ê²Œì‹œíŒ');
        
        const q = query(collection(db, "posts"), where("board", "==", boardId), orderBy("createdAt", "desc"));
        const snap = await getDocs(q);
        const posts = [];
        snap.forEach(d => posts.push({id: d.id, ...d.data()}));
        renderList(posts);
    };

    /* --- ê¸°ëŠ¥: ê¸€ì“°ê¸° --- */
    document.getElementById('writeBtn').onclick = () => {
        if (!state.currentUser) return alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        openModal('writeModal');
    };

    document.getElementById('savePostBtn').onclick = async () => {
        const t = document.getElementById('writeTitle').value.trim();
        const c = document.getElementById('writeContent').value.trim();
        if(!t || !c) return alert('ë‚´ìš©ì„ ì±„ì›Œì£¼ì„¸ìš”.');

        await addDoc(collection(db, "posts"), {
            title: t, content: c, author: state.currentUser.id,
            board: state.currentBoard, createdAt: Date.now(),
            date: new Date().toLocaleString(), views: 0, isPick: false,
            file: state.tempImg
        });

        alert('ë“±ë¡ ì™„ë£Œ!');
        closeModal('writeModal');
        showBoard(state.currentBoard);
    };

    /* --- ê¸°ëŠ¥: ìƒì„¸ ë³´ê¸° --- */
    window.viewPost = async (id) => {
        const docRef = doc(db, "posts", id);
        const snap = await getDoc(docRef);
        if(!snap.exists()) return;
        const post = snap.data();
        state.viewingPostId = id;

        await updateDoc(docRef, { views: post.views + 1 });

        showPage('detail');
        document.getElementById('post-header').innerHTML = `<h1>${post.isPick?'â­':''} ${post.title}</h1><small>${post.author} | ${post.date}</small>`;
        document.getElementById('post-body').innerHTML = post.content.replace(/\n/g, '<br>') + 
            (post.file ? `<br><img src="${post.file}" style="max-width:100%">` : '');

        // ê´€ë¦¬ì ë„êµ¬
        document.getElementById('admin-tools').style.display = (state.currentUser?.role === 'owner') ? 'flex' : 'none';
        renderComments(id);
    };

    /* --- ê¸°ëŠ¥: ëŒ“ê¸€ --- */
    document.getElementById('addCommentBtn').onclick = async () => {
        const inp = document.getElementById('comment-input');
        if(!state.currentUser || !inp.value.trim()) return;
        
        await addDoc(collection(db, "comments"), {
            postId: state.viewingPostId,
            author: state.currentUser.id,
            text: inp.value,
            createdAt: Date.now()
        });
        inp.value = '';
        renderComments(state.viewingPostId);
    };

    async function renderComments(postId) {
        const q = query(collection(db, "comments"), where("postId", "==", postId), orderBy("createdAt", "asc"));
        const snap = await getDocs(q);
        const list = document.getElementById('comment-list');
        let html = '';
        snap.forEach(d => {
            const c = d.data();
            html += `<div style="background:#f1f1f1; padding:10px; border-radius:8px; margin-bottom:5px;"><b>${c.author}</b>: ${c.text}</div>`;
        });
        list.innerHTML = html || 'ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.';
    }

    /* --- ê¸°ëŠ¥: ë¡œê·¸ì¸/ê°€ì… --- */
    document.getElementById('joinSubmit').onclick = async () => {
        const id = document.getElementById('joinId').value.trim();
        const pw = document.getElementById('joinPw').value.trim();
        await addDoc(collection(db, "users"), { id, pw, role: 'member' });
        alert('ê°€ì… ì™„ë£Œ! ë¡œê·¸ì¸í•˜ì„¸ìš”.');
        closeModal('joinModal');
    };

    document.getElementById('loginSubmit').onclick = async () => {
        const id = document.getElementById('loginId').value.trim();
        const pw = document.getElementById('loginPw').value.trim();
        const q = query(collection(db, "users"), where("id", "==", id), where("pw", "==", pw));
        const snap = await getDocs(q);
        if(snap.empty) return alert('ì •ë³´ê°€ í‹€ë¦½ë‹ˆë‹¤.');
        
        state.currentUser = { id, role: snap.docs[0].data().role };
        localStorage.setItem('user', JSON.stringify(state.currentUser));
        updateUI();
        closeModal('loginModal');
    };

    /* --- í™ˆ ë Œë”ë§ --- */
    async function renderHome() {
        // ìµœê·¼ê¸€ 5ê°œ
        const q = query(collection(db, "posts"), orderBy("createdAt", "desc"), limit(5));
        const snap = await getDocs(q);
        let html = '';
        snap.forEach(d => {
            const p = d.data();
            html += `<div class="item-row" onclick="viewPost('${d.id}')"><span>${p.title}</span><small>${p.author}</small></div>`;
        });
        document.getElementById('home-free-list').innerHTML = html;
    }

    /* --- ê¸°íƒ€ ì´ˆê¸°í™” --- */
    function updateUI() {
        if(state.currentUser) {
            document.getElementById('authArea').style.display = 'none';
            document.getElementById('userArea').style.display = 'flex';
            document.getElementById('welcomeMsg').innerText = state.currentUser.id + 'ë‹˜';
            document.getElementById('myInfoCard').style.display = 'block';
            document.getElementById('myName').innerText = state.currentUser.id;
            document.getElementById('myRole').innerText = state.currentUser.role;
            if(state.currentUser.role === 'owner') document.getElementById('menu-admin').style.display = 'block';
        } else {
            document.getElementById('authArea').style.display = 'flex';
            document.getElementById('userArea').style.display = 'none';
        }
    }

    function renderList(posts) {
        const list = document.getElementById('post-list');
        list.innerHTML = posts.map(p => `
            <div class="item-row" onclick="viewPost('${p.id}')">
                <div><b>${p.title}</b><br><small>${p.author}</small></div>
                <div>ğŸ‘ï¸ ${p.views}</div>
            </div>
        `).join('') || 'ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.';
    }

    // íŒŒì¼ ë¯¸ë¦¬ë³´ê¸°
    document.getElementById('fileInput').onchange = (e) => {
        const reader = new FileReader();
        reader.onload = () => {
            state.tempImg = reader.result;
            document.getElementById('writeImgPreview').src = reader.result;
            document.getElementById('writeImgPreview').style.display = 'block';
        };
        reader.readAsDataURL(e.target.files[0]);
    };

    // ì „ì—­ í•¨ìˆ˜ ë“±ë¡
    window.openModal = (id) => document.getElementById(id).classList.add('active');
    window.closeModal = (id) => document.getElementById(id).classList.remove('active');
    window.goHome = () => showPage('home');
    window.goBackList = () => showBoard(state.lastBoard);

    document.getElementById('openLoginBtn').onclick = () => openModal('loginModal');
    document.getElementById('openJoinBtn').onclick = () => openModal('joinModal');
    document.getElementById('logoutBtn').onclick = () => { state.currentUser = null; localStorage.removeItem('user'); location.reload(); };

    // ë©”ë‰´ í´ë¦­ ì´ë²¤íŠ¸
    document.querySelectorAll('.nav-item').forEach(item => {
        item.onclick = () => {
            if(item.dataset.page) showPage(item.dataset.page);
            if(item.dataset.board) showBoard(item.dataset.board);
        };
    });

    updateUI();
    renderHome();
</script>
</body>
</html>
