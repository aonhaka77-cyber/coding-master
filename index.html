<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì½”ë”© ë§ˆìŠ¤í„° - ë°ì´í„°ë² ì´ìŠ¤ ì—ë””ì…˜</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        /* --- ë””ìì¸ ì‹œìŠ¤í…œ (ê¸°ì¡´ ìœ ì§€) --- */
        :root { --primary: #667eea; --secondary: #764ba2; --bg: #f8f9fa; --text: #222; --danger: #e74c3c; --accent: #f39c12; --card-bg: #ffffff; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg); color: var(--text); line-height: 1.6; overflow-y: scroll; }
        header { background: white; border-bottom: 1px solid #e5e5e5; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .header-top { max-width: 1200px; margin: 0 auto; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; gap: 15px; }
        .logo { font-size: 22px; font-weight: 900; color: var(--primary); cursor: pointer; letter-spacing: -1px; }
        .search-bar { flex: 1; max-width: 400px; }
        .search-bar input { width: 100%; padding: 10px 18px; border-radius: 25px; border: 1px solid #ddd; background: #f1f3f5; font-size: 14px; transition: 0.3s; }
        .nav-menu { max-width: 1200px; margin: 0 auto; padding: 0 20px; display: flex; gap: 25px; overflow-x: auto; }
        .nav-item { padding: 15px 5px; cursor: pointer; font-size: 14px; font-weight: 700; color: #777; border-bottom: 3px solid transparent; white-space: nowrap; }
        .nav-item.active { color: var(--primary); border-bottom-color: var(--primary); }
        .main-container { max-width: 1200px; margin: 25px auto; padding: 0 20px; display: grid; grid-template-columns: 1fr 320px; gap: 25px; }
        @media (max-width: 950px) { .main-container { grid-template-columns: 1fr; } }
        .page { display: none; min-height: 600px; }
        .page.active { display: block; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .card { background: var(--card-bg); border-radius: 16px; padding: 25px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 25px; border: 1px solid #eee; }
        .ad-banner { background: linear-gradient(135deg, #222, #444); color: white; border-radius: 16px; padding: 40px; margin-bottom: 25px; }
        .btn { padding: 11px 22px; border: none; border-radius: 10px; cursor: pointer; font-weight: 700; font-size: 14px; display: inline-flex; align-items: center; justify-content: center; }
        .btn-p { background: var(--primary); color: white; }
        .btn-s { background: #f0f2f5; color: #444; }
        .btn-danger { background: var(--danger); color: white; }
        .item-row { padding: 15px; border-bottom: 1px solid #f5f7f9; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .modal.active { display: flex; }
        .modal-content { background: white; width: 90%; max-width: 550px; padding: 35px; border-radius: 20px; }
        input, textarea { width: 100%; padding: 12px 15px; border: 1px solid #ddd; border-radius: 10px; margin-top: 8px; }
    </style>
</head>
<body>

<header>
    <div class="header-top">
        <div class="logo" onclick="goHome()">ğŸš€ CODING MASTER</div>
        <div class="search-bar"><input type="text" id="globalSearch" placeholder="ê²€ìƒ‰ í›„ ì—”í„°ë¥¼ ëˆ„ë¥´ì„¸ìš”..." onkeypress="if(event.keyCode==13) handleSearch()"></div>
        <div id="authArea">
            <button class="btn btn-s" onclick="openModal('loginModal')">ë¡œê·¸ì¸</button>
            <button class="btn btn-p" onclick="openModal('joinModal')">íšŒì›ê°€ì…</button>
        </div>
        <div id="userArea" style="display:none; align-items:center; gap:12px;">
            <span id="welcomeMsg" style="font-weight:800; color:var(--primary);"></span>
            <button class="btn btn-s" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
    </div>
    <nav class="nav-menu">
        <div class="nav-item active" id="menu-home" onclick="goHome()">í™ˆ</div>
        <div class="nav-item" id="menu-notice" onclick="showBoard('notice')">ê³µì§€ì‚¬í•­</div>
        <div class="nav-item" id="menu-free" onclick="showBoard('free')">ììœ ê²Œì‹œíŒ</div>
        <div class="nav-item" id="menu-album" onclick="showBoard('album')">ê°¤ëŸ¬ë¦¬</div>
        <div class="nav-item" id="menu-admin" onclick="showPage('admin')" style="display:none; color:var(--danger)">ğŸ‘‘ ê´€ë¦¬ì½˜ì†”</div>
    </nav>
</header>

<div class="main-container">
    <div class="content-left">
        <div id="page-home" class="page active">
            <div id="ad-container" class="ad-banner"></div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                <div class="card"><h3>ğŸ“¢ ìµœê·¼ ê³µì§€</h3><div id="home-notice-list"></div></div>
                <div class="card"><h3>â­ ìš´ì˜ì§„ í”½</h3><div id="home-pick-list"></div></div>
            </div>
            <div class="card"><h3>ğŸ†• ìµœê·¼ ì˜¬ë¼ì˜¨ ê¸€</h3><div id="home-free-list"></div></div>
        </div>

        <div id="page-board" class="page">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2 id="board-title">ê²Œì‹œíŒ</h2>
                <button class="btn btn-p" onclick="openWriteModal()">ê¸€ì“°ê¸°</button>
            </div>
            <div id="post-list" class="card"></div>
        </div>

        <div id="page-detail" class="page">
            <div class="card">
                <div id="post-header"></div>
                <div id="post-body" style="padding:20px 0; border-top:1px solid #eee;"></div>
                <div id="admin-tools" style="display:none; gap:10px; margin-top:20px;">
                    <button class="btn btn-s" onclick="togglePick()">â­ ì¶”ì²œ í† ê¸€</button>
                    <button class="btn btn-danger" onclick="deletePost()">ğŸ—‘ï¸ ì‚­ì œ</button>
                </div>
            </div>
            <div class="card">
                <h4>ëŒ“ê¸€ <span id="cmt-count" style="color:var(--primary);">0</span></h4>
                <div id="comment-list" style="margin:20px 0;"></div>
                <div style="display:flex; gap:10px;">
                    <input type="text" id="comment-input" placeholder="ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”...">
                    <button class="btn btn-p" onclick="addComment()">ë“±ë¡</button>
                </div>
            </div>
            <button class="btn btn-s" onclick="goBackList()">ëª©ë¡ìœ¼ë¡œ</button>
        </div>

        <div id="page-admin" class="page">
            <h2>ğŸ‘‘ ê´€ë¦¬ì ì„¼í„°</h2>
            <div class="card">
                <h3>ğŸ“¢ ë°°ë„ˆ ê´€ë¦¬</h3>
                <input type="text" id="adInpTitle" placeholder="ì œëª©"><input type="text" id="adInpText" placeholder="ë‚´ìš©">
                <button class="btn btn-p" onclick="addAd()" style="margin-top:10px;">ê´‘ê³  ì—…ë°ì´íŠ¸</button>
            </div>
        </div>
    </div>

    <div class="sidebar">
        <div class="card">
            <h4>ğŸ“ˆ í†µê³„</h4>
            <p>ì „ì²´ ê²Œì‹œê¸€: <b id="stat-posts">0</b></p>
        </div>
    </div>
</div>

<div class="modal" id="loginModal"><div class="modal-content"><h2>ë¡œê·¸ì¸</h2><input type="text" id="loginId" placeholder="ë‹‰ë„¤ì„"><input type="password" id="loginPw" placeholder="ë¹„ë°€ë²ˆí˜¸"><button class="btn btn-p" style="width:100%; margin-top:20px;" onclick="handleLogin()">ì‹œì‘</button><button class="btn btn-s" style="width:100%; margin-top:10px;" onclick="closeModal('loginModal')">ë‹«ê¸°</button></div></div>
<div class="modal" id="joinModal"><div class="modal-content"><h2>íšŒì›ê°€ì…</h2><input type="text" id="joinId" placeholder="ë‹‰ë„¤ì„"><input type="password" id="joinPw" placeholder="ë¹„ë°€ë²ˆí˜¸"><button class="btn btn-p" style="width:100%; margin-top:20px;" onclick="handleJoin()">ê°€ì…</button><button class="btn btn-s" style="width:100%; margin-top:10px;" onclick="closeModal('joinModal')">ë‹«ê¸°</button></div></div>
<div class="modal" id="writeModal"><div class="modal-content" style="max-width:700px;"><h2>ê¸€ ì‘ì„±</h2><input type="text" id="writeTitle" placeholder="ì œëª©"><textarea id="writeContent" style="height:300px;" placeholder="ë‚´ìš©"></textarea><input type="file" onchange="handleFilePreview()" id="fileInput"><img id="writeImgPreview" style="display:none; max-width:100%; margin-top:10px;"><button class="btn btn-p" style="width:100%; margin-top:20px;" onclick="handleSavePost()">ë“±ë¡</button></div></div>

<script>
    // 1. Firebase ì„¤ì • (ì œê³µí•´ì£¼ì‹  API í‚¤ ì ìš©)
    const firebaseConfig = {
        apiKey: "AIzaSyBcxvsiEOyL1lZGVr1UE2gzzZ7HQX5YfbI",
        authDomain: "code-78890.firebaseapp.com",
        projectId: "code-78890",
        storageBucket: "code-78890.firebasestorage.app",
        messagingSenderId: "30317586652",
        appId: "1:30317586652:web:d1e6fa39c319029fb7ac19"
    };
    firebase.initializeApp(firebaseConfig);
    const fdb = firebase.firestore();

    // 2. ìƒíƒœ ê´€ë¦¬
    let state = {
        posts: [],
        currentUser: JSON.parse(localStorage.getItem('cm_user')) || null,
        currentBoard: 'home',
        viewingPostId: null,
        tempImg: null
    };

    // 3. ì´ˆê¸°í™” ë° ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ
    function init() {
        updateAuthUI();
        
        // ê²Œì‹œê¸€ ì‹¤ì‹œê°„ ê°ì‹œ
        fdb.collection("posts").orderBy("createdAt", "desc").onSnapshot((snapshot) => {
            state.posts = snapshot.docs.map(doc => ({ firebaseId: doc.id, ...doc.data() }));
            refreshCurrentUI();
            updateStats();
        });

        // ê´‘ê³  ì‹¤ì‹œê°„ ê°ì‹œ (DB ì €ì¥ ë°©ì‹)
        fdb.collection("settings").doc("ads").onSnapshot((doc) => {
            if(doc.exists()) {
                const data = doc.data();
                document.getElementById('ad-container').innerHTML = `<h2>${data.title}</h2><p>${data.text}</p>`;
            }
        });
    }

    function refreshCurrentUI() {
        if (state.currentBoard === 'home') renderHome();
        else renderPostList();
        
        if (state.viewingPostId) {
            const post = state.posts.find(p => p.id === state.viewingPostId);
            if(post) renderDetail(post);
        }
    }

    // 4. ê²Œì‹œíŒ ë¡œì§
    function showPage(pageId) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById('page-' + pageId).classList.add('active');
        state.currentBoard = pageId;
    }

    function goHome() { showPage('home'); renderHome(); }

    function showBoard(boardId) {
        state.currentBoard = boardId;
        showPage('board');
        document.getElementById('board-title').innerText = boardId.toUpperCase();
        renderPostList();
    }

    function renderHome() {
        const notices = state.posts.filter(p => p.board === 'notice').slice(0, 5);
        const picks = state.posts.filter(p => p.isPick).slice(0, 5);
        const frees = state.posts.filter(p => p.board === 'free').slice(0, 5);

        const mapper = p => `<div class="item-row" onclick="viewPost(${p.id})"><span>${p.title}</span><small>${p.author}</small></div>`;
        document.getElementById('home-notice-list').innerHTML = notices.map(mapper).join('') || 'ì—†ìŒ';
        document.getElementById('home-pick-list').innerHTML = picks.map(mapper).join('') || 'ì—†ìŒ';
        document.getElementById('home-free-list').innerHTML = frees.map(mapper).join('') || 'ì—†ìŒ';
    }

    function renderPostList() {
        const list = state.posts.filter(p => p.board === state.currentBoard);
        document.getElementById('post-list').innerHTML = list.map(p => `
            <div class="item-row" onclick="viewPost(${p.id})">
                <div><b>${p.isPick?'â­ ':''}${p.title}</b><br><small>${p.author} | ${p.date}</small></div>
                <div>ğŸ‘ï¸ ${p.views || 0}</div>
            </div>
        `).join('') || 'ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.';
    }

    // 5. ê¸€ ìƒì„¸ ë° ì‘ì„±
    async function viewPost(id) {
        const post = state.posts.find(p => p.id === id);
        if(!post) return;
        state.viewingPostId = id;
        showPage('detail');
        fdb.collection("posts").doc(post.firebaseId).update({ views: (post.views || 0) + 1 });
        renderDetail(post);
    }

    function renderDetail(post) {
        document.getElementById('post-header').innerHTML = `<h1>${post.title}</h1><small>${post.author} | ${post.date}</small>`;
        document.getElementById('post-body').innerHTML = post.content.replace(/\n/g, '<br>') + (post.file ? `<br><img src="${post.file}" style="max-width:100%">` : '');
        
        const isAdmin = state.currentUser && (state.currentUser.role === 'owner' || state.currentUser.id === post.author);
        document.getElementById('admin-tools').style.display = isAdmin ? 'flex' : 'none';
        
        // ëŒ“ê¸€ ì‹¤ì‹œê°„
        fdb.collection("comments").where("postId", "==", post.id).orderBy("createdAt", "asc").onSnapshot(snap => {
            const cmts = snap.docs.map(d => d.data());
            document.getElementById('cmt-count').innerText = cmts.length;
            document.getElementById('comment-list').innerHTML = cmts.map(c => `
                <div style="background:#f1f1f1; padding:10px; border-radius:8px; margin-bottom:5px;">
                    <b>${c.author}</b>: ${c.text}
                </div>
            `).join('');
        });
    }

    function openWriteModal() {
        if(!state.currentUser) return alert('ë¡œê·¸ì¸ í•˜ì„¸ìš”.');
        openModal('writeModal');
    }

    async function handleSavePost() {
        const t = document.getElementById('writeTitle').value;
        const c = document.getElementById('writeContent').value;
        if(!t || !c) return alert('ë‚´ìš© ë¶€ì¡±');

        await fdb.collection("posts").add({
            id: Date.now(),
            board: state.currentBoard === 'home' ? 'free' : state.currentBoard,
            title: t, content: c, author: state.currentUser.id,
            date: new Date().toLocaleString(),
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            views: 0, isPick: false, file: state.tempImg
        });
        closeModal('writeModal');
    }

    async function addComment() {
        const inp = document.getElementById('comment-input');
        if(!state.currentUser || !inp.value) return;
        await fdb.collection("comments").add({
            postId: state.viewingPostId,
            author: state.currentUser.id,
            text: inp.value,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        inp.value = '';
    }

    // 6. íšŒì› ê´€ë¦¬ (Firestore ê¸°ë°˜)
    async function handleJoin() {
        const id = document.getElementById('joinId').value;
        const pw = document.getElementById('joinPw').value;
        const check = await fdb.collection("users").doc(id).get();
        if(check.exists()) return alert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ë‹‰ë„¤ì„ì…ë‹ˆë‹¤.');
        
        await fdb.collection("users").doc(id).set({ id, pw, role: 'member' });
        alert('ê°€ì… ì™„ë£Œ!'); closeModal('joinModal');
    }

    async function handleLogin() {
        const id = document.getElementById('loginId').value;
        const pw = document.getElementById('loginPw').value;
        const doc = await fdb.collection("users").doc(id).get();
        if(!doc.exists() || doc.data().pw !== pw) return alert('ì •ë³´ ë¶ˆì¼ì¹˜');
        
        state.currentUser = doc.data();
        localStorage.setItem('cm_user', JSON.stringify(state.currentUser));
        updateAuthUI(); closeModal('loginModal');
    }

    function logout() {
        state.currentUser = null;
        localStorage.removeItem('cm_user');
        location.reload();
    }

    // 7. ìœ í‹¸ë¦¬í‹°
    function updateAuthUI() {
        const auth = document.getElementById('authArea');
        const user = document.getElementById('userArea');
        if(state.currentUser) {
            auth.style.display = 'none'; user.style.display = 'flex';
            document.getElementById('welcomeMsg').innerText = state.currentUser.id + 'ë‹˜';
            if(state.currentUser.role === 'owner') document.getElementById('menu-admin').style.display = 'block';
        }
    }

    function updateStats() {
        document.getElementById('stat-posts').innerText = state.posts.length;
    }

    function handleFilePreview() {
        const file = document.getElementById('fileInput').files[0];
        const reader = new FileReader();
        reader.onloadend = () => { state.tempImg = reader.result; document.getElementById('writeImgPreview').src = reader.result; document.getElementById('writeImgPreview').style.display='block'; };
        if(file) reader.readAsDataURL(file);
    }

    async function addAd() {
        const title = document.getElementById('adInpTitle').value;
        const text = document.getElementById('adInpText').value;
        await fdb.collection("settings").doc("ads").set({ title, text });
        alert('ê´‘ê³  ì—…ë°ì´íŠ¸ ì™„ë£Œ');
    }

    async function deletePost() {
        if(!confirm('ì‚­ì œ?')) return;
        const post = state.posts.find(p => p.id === state.viewingPostId);
        await fdb.collection("posts").doc(post.firebaseId).delete();
        goHome();
    }

    async function togglePick() {
        const post = state.posts.find(p => p.id === state.viewingPostId);
        await fdb.collection("posts").doc(post.firebaseId).update({ isPick: !post.isPick });
    }

    function openModal(id) { document.getElementById(id).classList.add('active'); }
    function closeModal(id) { document.getElementById(id).classList.remove('active'); }
    function goBackList() { showBoard(state.currentBoard); state.viewingPostId = null; }

    window.onload = init;
</script>

</body>
</html>
