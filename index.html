<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MASTER PIECE - ULTIMATE</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        :root { --primary: #4f46e5; --bg: #f3f4f6; --text: #1f2937; --danger: #ef4444; --card: #ffffff; --tag: #dbeafe; --pinned: #fffbeb; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Pretendard', -apple-system, sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: var(--text); padding-bottom: 80px; line-height: 1.5; }
        
        /* Layout */
        header { background: white; border-bottom: 1px solid #e5e7eb; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .header-top { max-width: 1200px; margin: 0 auto; padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; gap: 10px; }
        .logo { font-size: 18px; font-weight: 900; color: var(--primary); cursor: pointer; white-space: nowrap; }
        .search-box { flex-grow: 1; max-width: 400px; position: relative; }
        .search-inp { width: 100%; padding: 8px 15px; border-radius: 20px; border: 1px solid #ddd; font-size: 14px; outline: none; }
        
        .nav-menu { max-width: 1200px; margin: 0 auto; padding: 0 15px; display: flex; gap: 15px; overflow-x: auto; border-top: 1px solid #f3f4f6; -ms-overflow-style: none; scrollbar-width: none; }
        .nav-menu::-webkit-scrollbar { display: none; }
        .nav-item { padding: 12px 5px; cursor: pointer; font-size: 14px; font-weight: 700; color: #6b7280; white-space: nowrap; border-bottom: 3px solid transparent; transition: 0.2s; }
        .nav-item.active { color: var(--primary); border-bottom-color: var(--primary); }

        .main-container { max-width: 1200px; margin: 15px auto; padding: 0 15px; display: grid; grid-template-columns: 1fr 300px; gap: 20px; }
        @media (max-width: 900px) { .main-container { grid-template-columns: 1fr; margin-top: 10px; } .sidebar { display: none; } }

        /* UI Elements */
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .card { background: var(--card); border-radius: 16px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 15px; }
        .btn { padding: 10px 18px; border: none; border-radius: 10px; cursor: pointer; font-weight: 700; transition: 0.2s; font-size: 13px; display: inline-flex; align-items: center; justify-content: center; }
        .btn-p { background: var(--primary); color: white; }
        .btn-s { background: #f3f4f6; color: #4b5563; }
        .btn-danger { background: #fee2e2; color: var(--danger); }
        .btn-active { background: #fee2e2; color: var(--danger); }
        
        .item-row { padding: 15px; border-bottom: 1px solid #f3f4f6; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: background 0.2s; }
        .item-row:hover { background: #f9fafb; }
        .tag { display: inline-block; padding: 2px 8px; background: var(--tag); color: #1e40af; border-radius: 6px; font-size: 11px; margin-right: 4px; }
        
        /* Modals */
        .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:2000; align-items:center; justify-content:center; padding: 15px; }
        .modal.active { display: flex; }
        .modal-content { background:white; padding:25px; border-radius:20px; width:100%; max-width:450px; max-height: 90vh; overflow-y: auto; }
        input, textarea { width:100%; padding:12px; margin-top:10px; border:1px solid #ddd; border-radius:10px; font-size: 16px !important; } /* 16px prevents iOS zoom */
        
        /* Content Styling */
        .namu-content { word-break: break-all; }
        .namu-content b { font-weight: bold; color: #000; }
        .namu-content blockquote { border-left: 4px solid var(--primary); padding: 5px 15px; background: #f8fafc; margin: 10px 0; color: #4b5563; }
        .badge { background: var(--danger); color: white; font-size: 10px; padding: 2px 6px; border-radius: 10px; position: absolute; top:-5px; right:-5px; border: 2px solid white; }
    </style>
</head>
<body>

<header>
    <div class="header-top">
        <div class="logo" onclick="goHome()">ğŸš€ MASTER PIECE</div>
        <div class="search-box">
            <input type="text" id="searchInput" class="search-inp" placeholder="í†µí•© ê²€ìƒ‰..." onkeyup="if(event.keyCode==13)handleSearch()">
        </div>
        <div style="display:flex; align-items:center; gap:12px;">
            <div style="position:relative; cursor:pointer; font-size: 20px;" onclick="toggleNoti()">ğŸ””<span id="notiCount" class="badge" style="display:none;">0</span></div>
            <div id="authArea"><button class="btn btn-p" onclick="openModal('loginModal')">ë¡œê·¸ì¸</button></div>
            <div id="userArea" style="display:none; cursor:pointer;" onclick="showPage('mypage')">
                <span id="welcomeMsg" style="font-weight:bold; font-size: 14px;"></span>
            </div>
        </div>
    </div>
    <nav class="nav-menu">
        <div class="nav-item active" id="menu-home" onclick="goHome()">í™ˆ</div>
        <div class="nav-item" id="menu-notice" onclick="showBoard('notice')">ê³µì§€</div>
        <div class="nav-item" id="menu-free" onclick="showBoard('free')">ììœ </div>
        <div class="nav-item" id="menu-qna" onclick="showBoard('qna')">Q&A</div>
        <div class="nav-item" id="menu-inquiry" onclick="showPage('inquiry')">ë¬¸ì˜</div>
        <div class="nav-item" id="menu-admin" onclick="showPage('admin')" style="display:none; color:var(--danger)">ê´€ë¦¬</div>
    </nav>
</header>

<div class="main-container">
    <div class="content-left">
        <div id="page-home" class="page active">
            <div class="card" style="background:var(--primary); color:white;">
                <h2 style="font-size: 20px;">í™˜ì˜í•©ë‹ˆë‹¤!</h2>
                <p style="font-size: 13px; opacity: 0.9;">ì¢‹ì•„ìš” 50ê°œ ë‹¬ì„± ì‹œ ì¸ê¸°ê¸€ë¡œ ìë™ ë“±ë¡ë©ë‹ˆë‹¤.</p>
            </div>
            <div class="card"><h3>ğŸ”¥ ì¸ê¸° ê²Œì‹œê¸€</h3><div id="home-hot-posts"></div></div>
            <div class="card"><h3>ğŸ†• ìµœì‹ ê¸€</h3><div id="home-posts"></div></div>
        </div>

        <div id="page-board" class="page">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h2 id="board-title">ê²Œì‹œíŒ</h2>
                <button class="btn btn-p" onclick="openWriteModal()">ê¸€ì“°ê¸°</button>
            </div>
            <div id="post-list" class="card" style="padding:0; overflow: hidden;"></div>
        </div>

        <div id="page-detail" class="page">
            <div class="card">
                <span id="det-board-tag" class="tag"></span>
                <h1 id="det-title" style="margin-top:10px; font-size: 22px;"></h1>
                <p id="det-info" style="color:#888; font-size:12px; margin:10px 0;"></p>
                <hr style="border:0; border-top:1px solid #eee; margin:15px 0;">
                <div id="det-body" class="namu-content" style="line-height:1.7; min-height:150px; white-space:pre-wrap;"></div>
                
                <div style="margin-top:20px; display:flex; gap:10px; justify-content:center; flex-wrap: wrap;">
                    <button class="btn btn-s" id="likeBtn" onclick="handleLikeToggle()">â¤ï¸ ì¢‹ì•„ìš” <span id="like-count">0</span></button>
                    <button class="btn btn-danger" onclick="reportContent('post', state.viewingId)">ğŸš¨ ì‹ ê³ </button>
                </div>
                
                <div style="margin-top:20px; display:flex; justify-content:flex-end; gap:10px;">
                    <button class="btn btn-p" id="pinBtn" style="display:none; background:orange;" onclick="togglePin()">ê³µì§€ë“±ë¡</button>
                    <button class="btn btn-danger" id="delBtn" style="display:none; background: #dc2626; color:white;" onclick="deletePost()">ì‚­ì œ</button>
                </div>
            </div>
            <div class="card">
                <h4>ëŒ“ê¸€ <span id="comm-count" style="color:var(--primary);">0</span></h4>
                <div id="comm-list" style="margin:15px 0;"></div>
                <div style="display:flex; gap:10px;">
                    <input type="text" id="commInp" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..." style="margin-top:0;">
                    <button class="btn btn-p" onclick="saveComment()">ë“±ë¡</button>
                </div>
            </div>
        </div>

        <div id="page-mypage" class="page">
            <div class="card">
                <h2 id="my-name">ë§ˆì´í˜ì´ì§€</h2>
                <button class="btn btn-s" style="margin-top:10px;" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
            <div class="card"><h3>ë‚´ê°€ ì“´ ê¸€</h3><div id="my-posts"></div></div>
        </div>

        <div id="page-inquiry" class="page">
            <div class="card">
                <h2>ğŸ“® ìš´ì˜ì§„ ë¬¸ì˜</h2>
                <textarea id="inqInp" rows="4" placeholder="ë¬¸ì˜ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”."></textarea>
                <button class="btn btn-p" style="width:100%; margin-top:10px;" onclick="sendInquiry()">ë¬¸ì˜í•˜ê¸°</button>
            </div>
            <div id="my-inquiry-list"></div>
        </div>

        <div id="page-admin" class="page">
            <div class="card"><h3>âš ï¸ ì‹ ê³  ë‚´ì—­</h3><div id="admin-report-list"></div></div>
            <div class="card"><h3>íšŒì› ê´€ë¦¬</h3><div id="admin-user-list"></div></div>
            <div class="card"><h3>ì „ì²´ ë¬¸ì˜</h3><div id="admin-inq-list"></div></div>
        </div>
    </div>

    <div class="sidebar">
        <div class="card">
            <h4>ğŸ“Š í†µê³„</h4>
            <div id="stats" style="font-size:13px; margin-top:10px;">ë¡œë”©ì¤‘...</div>
        </div>
    </div>
</div>

<div class="modal" id="loginModal">
    <div class="modal-content">
        <h2 style="margin-bottom:10px;">ë¡œê·¸ì¸ / ê°€ì…</h2>
        <input type="text" id="l-id" placeholder="ì•„ì´ë””">
        <input type="password" id="l-pw" placeholder="ë¹„ë°€ë²ˆí˜¸">
        <button class="btn btn-p" style="width:100%; margin-top:15px;" onclick="handleLogin()">ë¡œê·¸ì¸</button>
        <button class="btn btn-s" style="width:100%; margin-top:8px;" onclick="handleJoin()">íšŒì›ê°€ì…</button>
        <button class="btn" style="width:100%; margin-top:8px;" onclick="closeModal('loginModal')">ì·¨ì†Œ</button>
    </div>
</div>

<div class="modal" id="writeModal">
    <div class="modal-content">
        <h2>ìƒˆ ê¸€ ì‘ì„±</h2>
        <input type="text" id="w-title" placeholder="ì œëª©">
        <input type="text" id="w-tag" placeholder="íƒœê·¸ (ì‰¼í‘œ êµ¬ë¶„)">
        <div style="margin-top:12px;"><small>ì´ë¯¸ì§€ ì²¨ë¶€:</small> <input type="file" id="w-file" accept="image/*" style="font-size:12px; border:none; padding:5px;"></div>
        <textarea id="w-content" rows="10" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”. (**êµµê²Œ**, --ì·¨ì†Œ-- ì§€ì›)"></textarea>
        <button class="btn btn-p" style="width:100%; margin-top:15px;" onclick="savePost()">ì‘ì„±ì™„ë£Œ</button>
        <button class="btn btn-s" style="width:100%; margin-top:8px;" onclick="closeModal('writeModal')">ì·¨ì†Œ</button>
    </div>
</div>

<div id="notiBox" class="card" style="display:none; position:fixed; top:70px; right:20px; width:280px; z-index:3000; border:1px solid #ddd; max-height: 400px; overflow-y: auto;">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <b>ìµœê·¼ ì•Œë¦¼</b>
        <small style="cursor:pointer; color:var(--primary);" onclick="clearNotis()">ì§€ìš°ê¸°</small>
    </div>
    <div id="notiList" style="font-size:13px;"></div>
</div>

<script>
    // 1. Firebase ì„¤ì • (ì œê³µí•´ì£¼ì‹  ì„¤ì • ìœ ì§€)
    const firebaseConfig = {
        apiKey: "AIzaSyBcxvsiEOyL1lZGVr1UE2gzzZ7HQX5YfbI",
        authDomain: "code-78890.firebaseapp.com",
        projectId: "code-78890",
        storageBucket: "code-78890.firebasestorage.app",
        messagingSenderId: "30317586652",
        appId: "1:30317586652:web:d1e6fa39c319029fb7ac19"
    };
    firebase.initializeApp(firebaseConfig);
    const fdb = firebase.firestore();

    let state = { users:[], posts:[], user:null, viewingId:null, currentBoard:'free', commUnsub: null };

    async function init() {
        // [ìˆ˜ì •] ë¡œê·¸ì¸ ìœ ì§€ ì²´í¬
        const savedUser = localStorage.getItem('masterPiece_user');
        if(savedUser) {
            state.user = JSON.parse(savedUser);
            loginUI();
        }

        // ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆë“¤
        fdb.collection("users").onSnapshot(s => {
            state.users = s.docs.map(d => ({fId: d.id, ...d.data()}));
            if(state.user) {
                const updated = state.users.find(u => u.id === state.user.id);
                if(updated) {
                    state.user = updated;
                    localStorage.setItem('masterPiece_user', JSON.stringify(updated));
                    if(updated.isBanned) logout();
                }
            }
            updateStats();
        });

        fdb.collection("posts").orderBy("id", "desc").onSnapshot(s => {
            state.posts = s.docs.map(d => ({fId: d.id, ...d.data()}));
            refreshUI();
        });

        setupInquiryListener();
        setupNotiListener();
        setupReportListener();
    }

    function refreshUI() {
        renderHome();
        if(document.getElementById('page-board').classList.contains('active')) renderPostList();
        if(state.viewingId) renderDetail(state.viewingId);
    }

    // 2. ë‚˜ë¬´ìœ„í‚¤ íŒŒì„œ
    function parseNamu(text) {
        if(!text) return '';
        let t = text.replace(/'''(.*?)'''/g, '<b>$1</b>').replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
        t = t.replace(/--(.*?)--/g, '<del>$1</del>');
        t = t.replace(/\[\[(http.*?)\]\]/g, '<a href="$1" target="_blank" style="color:var(--primary)">ë§í¬</a>');
        t = t.replace(/> (.*)/g, '<blockquote>$1</blockquote>');
        t = t.replace(/\[ì´ë¯¸ì§€:(.*?)\]/g, '<img src="$1" style="max-width:100%; border-radius:12px; margin: 10px 0; display:block;">');
        return t;
    }

    // 3. ì¸ì¦ ì‹œìŠ¤í…œ
    async function handleLogin() {
        const id = document.getElementById('l-id').value;
        const pw = document.getElementById('l-pw').value;
        
        if(id === 'ê³„ì†ë°˜ë³µ' && pw === 'akdhs') {
            state.user = { id:'ê³„ì†ë°˜ë³µ', role:'admin' };
        } else {
            const found = state.users.find(u => u.id === id && u.pw === pw);
            if(!found) return alert('ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
            if(found.isBanned) return alert('ì°¨ë‹¨ëœ ê³„ì •ì…ë‹ˆë‹¤.');
            state.user = found;
        }
        
        localStorage.setItem('masterPiece_user', JSON.stringify(state.user));
        loginUI();
        closeModal('loginModal');
        location.reload(); // ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì¬ì„¤ì •ì„ ìœ„í•´ ê¶Œì¥
    }

    async function handleJoin() {
        const id = document.getElementById('l-id').value;
        const pw = document.getElementById('l-pw').value;
        if(!id || !pw) return alert('ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        if(state.users.find(u=>u.id===id)) return alert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì•„ì´ë””ì…ë‹ˆë‹¤.');
        
        await fdb.collection("users").add({ id, pw, role:'member', isMuted:false, isBanned:false });
        alert('ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
    }

    function loginUI() {
        if(!state.user) return;
        document.getElementById('authArea').style.display = 'none';
        document.getElementById('userArea').style.display = 'block';
        document.getElementById('welcomeMsg').innerText = `${state.user.id} ë‹˜`;
        if(state.user.role === 'admin') document.getElementById('menu-admin').style.display = 'block';
    }

    function logout() {
        localStorage.removeItem('masterPiece_user');
        location.reload();
    }

    // 4. ê²Œì‹œíŒ ê¸°ëŠ¥
    function showBoard(b) {
        state.currentBoard = b;
        state.viewingId = null;
        document.getElementById('board-title').innerText = b.toUpperCase();
        showPage('board');
        renderPostList();
    }

    function renderPostList(customList = null) {
        const target = customList || state.posts.filter(p => p.board === state.currentBoard);
        document.getElementById('post-list').innerHTML = target.map(p => `
            <div class="item-row" onclick="viewPost('${p.fId}')">
                <div>
                    <div style="display:flex; align-items:center;">
                        ${p.isPinned?'<span style="margin-right:5px;">ğŸ“Œ</span>':''}
                        <span style="font-weight:700;">${p.title}</span>
                    </div>
                    <small style="color:#888;">${p.author} Â· ${p.date}</small>
                </div>
                <div style="color:var(--danger); font-size:13px; font-weight:700;">â¤ï¸ ${p.likes||0}</div>
            </div>
        `).join('') || '<p style="padding:40px; text-align:center; color:#888;">ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
    }

    function renderHome() {
        const hot = state.posts.filter(p => (p.likes||0) >= 50).slice(0,5);
        document.getElementById('home-hot-posts').innerHTML = hot.map(p => `
            <div class="item-row" onclick="viewPost('${p.fId}')">
                <span style="font-weight:600;">${p.title}</span>
                <b style="color:var(--danger);">â¤ï¸ ${p.likes}</b>
            </div>
        `).join('') || '<p style="font-size:12px; padding:20px; color:#888;">ì•„ì§ ì¸ê¸° ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        
        document.getElementById('home-posts').innerHTML = state.posts.slice(0,5).map(p => `
            <div class="item-row" onclick="viewPost('${p.fId}')">
                <span>${p.title}</span>
                <small style="color:#888;">${p.author}</small>
            </div>
        `).join('');
    }

    // 5. ê²Œì‹œê¸€ ìƒì„¸ ë° ëŒ“ê¸€ [ìˆ˜ì •ë¨]
    async function viewPost(fId) {
        state.viewingId = fId;
        showPage('detail');
        renderDetail(fId);
    }

    function renderDetail(fId) {
        const p = state.posts.find(x => x.fId === fId);
        if(!p) return;

        document.getElementById('det-board-tag').innerText = p.board;
        document.getElementById('det-title').innerText = p.title;
        document.getElementById('det-info').innerText = `${p.author} | ${p.date}`;
        document.getElementById('det-body').innerHTML = parseNamu(p.content);
        document.getElementById('like-count').innerText = p.likes || 0;

        const isLiked = state.user && p.likedBy && p.likedBy.includes(state.user.id);
        document.getElementById('likeBtn').className = isLiked ? 'btn btn-active' : 'btn btn-s';

        document.getElementById('delBtn').style.display = (state.user && (state.user.id === p.author || state.user.role === 'admin')) ? 'block' : 'none';
        document.getElementById('pinBtn').style.display = (state.user && state.user.role === 'admin') ? 'block' : 'none';

        // ëŒ“ê¸€ ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì—°ê²°
        if(state.commUnsub) state.commUnsub();
        state.commUnsub = fdb.collection("comments")
            .where("postId","==",fId)
            .orderBy("timestamp", "asc")
            .onSnapshot(s => {
                const list = s.docs.map(d => ({fId: d.id, ...d.data()}));
                document.getElementById('comm-count').innerText = list.length;
                document.getElementById('comm-list').innerHTML = list.map(c => `
                    <div style="padding:10px; background:#f9fafb; margin-bottom:8px; border-radius:10px; font-size:13px; position:relative;">
                        <div style="display:flex; justify-content:space-between;">
                            <b>${c.user}</b>
                            <span style="color:#bbb; cursor:pointer;" onclick="reportContent('comment', '${c.fId}')">ì‹ ê³ </span>
                        </div>
                        <div style="margin-top:4px;">${c.text}</div>
                    </div>
                `).join('');
            });
    }

    async function handleLikeToggle() {
        if(!state.user) return alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        const p = state.posts.find(x => x.fId === state.viewingId);
        const ref = fdb.collection("posts").doc(state.viewingId);
        const isLiked = p.likedBy && p.likedBy.includes(state.user.id);

        if(isLiked) {
            await ref.update({ likes: firebase.firestore.FieldValue.increment(-1), likedBy: firebase.firestore.FieldValue.arrayRemove(state.user.id) });
        } else {
            await ref.update({ likes: firebase.firestore.FieldValue.increment(1), likedBy: firebase.firestore.FieldValue.arrayUnion(state.user.id) });
        }
    }

    async function saveComment() {
        if(!state.user) return alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        if(state.user.isMuted) return alert('í˜„ì¬ ì°¨ë‹¨ë˜ì–´ ëŒ“ê¸€ì„ ì“¸ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        const text = document.getElementById('commInp').value;
        if(!text.trim()) return;

        await fdb.collection("comments").add({ 
            postId: state.viewingId, 
            user: state.user.id, 
            text, 
            timestamp: firebase.firestore.FieldValue.serverTimestamp() 
        });
        
        document.getElementById('commInp').value = '';
        
        const post = state.posts.find(p => p.fId === state.viewingId);
        if(post.author !== state.user.id) {
            await fdb.collection("notis").add({ 
                to: post.author, 
                msg: `ë‚´ ê¸€ì— ëŒ“ê¸€ì´ ë‹¬ë ¸ìŠµë‹ˆë‹¤: ${text.substring(0,10)}...`, 
                read: false,
                date: new Date().getTime()
            });
        }
    }

    // 6. ê¸€ì“°ê¸°
    async function savePost() {
        if(!state.user) return alert('ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.');
        const title = document.getElementById('w-title').value;
        const content = document.getElementById('w-content').value;
        const tagInp = document.getElementById('w-tag').value;
        const file = document.getElementById('w-file').files[0];

        if(!title.trim() || !content.trim()) return alert('ì œëª©ê³¼ ë‚´ìš©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');

        if(file) {
            const reader = new FileReader();
            reader.onload = async (e) => {
                const imgData = `\n[ì´ë¯¸ì§€:${e.target.result}]`;
                await pushPost(title, content + imgData, tagInp);
            };
            reader.readAsDataURL(file);
        } else {
            await pushPost(title, content, tagInp);
        }
    }

    async function pushPost(t, c, tags) {
        await fdb.collection("posts").add({
            id: Date.now(), board: state.currentBoard, title: t, content: c, author: state.user.id,
            date: new Date().toLocaleDateString(), likes:0, likedBy:[], isPinned: false, tags: tags.split(',')
        });
        closeModal('writeModal');
        document.getElementById('w-title').value = '';
        document.getElementById('w-content').value = '';
    }

    // 7. ì‹ ê³  ê¸°ëŠ¥ [ì¶”ê°€ë¨]
    async function reportContent(type, id) {
        if(!state.user) return alert('ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.');
        const reason = prompt('ì‹ ê³  ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš” (ë¶€ì ì ˆí•œ í™ë³´, ìš•ì„¤, ë„ë°° ë“±)');
        if(!reason) return;

        await fdb.collection("reports").add({
            type, targetId: id, reporter: state.user.id, reason, date: new Date().toLocaleString(), status: 'pending'
        });
        alert('ì‹ ê³ ê°€ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤. ìš´ì˜ì§„ì´ ê²€í† í•˜ê² ìŠµë‹ˆë‹¤.');
    }

    function setupReportListener() {
        fdb.collection("reports").onSnapshot(s => {
            if(state.user && state.user.role === 'admin') {
                const reports = s.docs.map(d => ({fId: d.id, ...d.data()}));
                document.getElementById('admin-report-list').innerHTML = reports.map(r => `
                    <div style="padding:10px; border-bottom:1px solid #eee; font-size:13px;">
                        [${r.type}] ì‚¬ìœ : ${r.reason} (ì‹ ê³ ì: ${r.reporter})
                        <button class="btn btn-danger" style="padding:2px 5px; font-size:10px;" onclick="deleteReport('${r.fId}')">ì²˜ë¦¬ì™„ë£Œ</button>
                    </div>
                `).join('') || 'ì‹ ê³  ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.';
            }
        });
    }

    async function deleteReport(fid) {
        if(confirm('ì‹ ê³  ì²˜ë¦¬ë¥¼ ì™„ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) await fdb.collection("reports").doc(fid).delete();
    }

    // 8. ê¸°íƒ€ ìœ í‹¸ë¦¬í‹°
    function handleSearch() {
        const q = document.getElementById('searchInput').value;
        if(!q.trim()) return;
        const res = state.posts.filter(p => p.title.includes(q) || p.content.includes(q));
        showBoard('ê²€ìƒ‰ ê²°ê³¼');
        renderPostList(res);
    }

    async function sendInquiry() {
        const text = document.getElementById('inqInp').value;
        if(!state.user || !text.trim()) return alert('ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        await fdb.collection("inq").add({ user: state.user.id, content: text, date: new Date(), reply: null });
        alert('ë¬¸ì˜ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
        document.getElementById('inqInp').value = '';
    }

    function setupInquiryListener() {
        fdb.collection("inq").orderBy("date", "desc").onSnapshot(s => {
            const all = s.docs.map(d => ({fId: d.id, ...d.data()}));
            if(state.user) {
                const mine = all.filter(i => i.user === state.user.id);
                document.getElementById('my-inquiry-list').innerHTML = mine.map(i => `
                    <div class="card" style="padding:15px; font-size:13px;">
                        <b>Q: ${i.content}</b>
                        <div style="margin-top:10px; color:var(--primary);">${i.reply ? 'A: ' + i.reply : 'ë‹µë³€ ëŒ€ê¸°ì¤‘ì…ë‹ˆë‹¤.'}</div>
                    </div>
                `).join('');
            }
            if(state.user && state.user.role === 'admin') {
                document.getElementById('admin-inq-list').innerHTML = all.map(i => `
                    <div class="card" style="font-size:13px;">
                        ${i.user}: ${i.content}<br>
                        <input id="ans-${i.fId}" placeholder="ë‹µë³€ ì…ë ¥" style="width:70%; font-size:12px;">
                        <button class="btn btn-p" style="padding:5px;" onclick="replyInq('${i.fId}')">ë‹µë³€</button>
                    </div>
                `).join('');
            }
        });
    }

    async function replyInq(fid) {
        const ans = document.getElementById('ans-'+fid).value;
        await fdb.collection("inq").doc(fid).update({ reply: ans });
    }

    function setupNotiListener() {
        if(!state.user) return;
        fdb.collection("notis")
           .where("to","==",state.user.id)
           .where("read","==",false)
           .onSnapshot(s => {
                const list = s.docs.map(d => ({fId: d.id, ...d.data()}));
                document.getElementById('notiCount').innerText = list.length;
                document.getElementById('notiCount').style.display = list.length > 0 ? 'block' : 'none';
                document.getElementById('notiList').innerHTML = list.map(n => `
                    <div style="padding:10px; border-bottom:1px solid #eee; background:#fffbeb;">
                        ${n.msg}
                    </div>
                `).join('') || '<p style="padding:10px; color:#888;">ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        });
    }

    async function clearNotis() {
        const s = await fdb.collection("notis").where("to","==",state.user.id).get();
        s.docs.forEach(d => d.ref.delete());
    }

    async function togglePin() {
        const p = state.posts.find(x => x.fId === state.viewingId);
        await fdb.collection("posts").doc(state.viewingId).update({ isPinned: !p.isPinned });
    }

    async function deletePost() {
        if(confirm('ì •ë§ë¡œ ì´ ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) { 
            await fdb.collection("posts").doc(state.viewingId).delete(); 
            goHome(); 
        }
    }

    function showPage(p) {
        document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
        document.getElementById('page-'+p).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        if(document.getElementById('menu-'+p)) document.getElementById('menu-'+p).classList.add('active');
        if(p==='admin') renderAdmin();
        window.scrollTo(0,0);
    }

    function renderAdmin() {
        document.getElementById('admin-user-list').innerHTML = state.users.map(u => `
            <div style="padding:10px; border-bottom:1px solid #eee; font-size:13px; display:flex; justify-content:space-between; align-items:center;">
                <span>${u.id} (${u.role})</span>
                <div>
                    <button class="btn btn-s" style="padding:5px;" onclick="admAct('${u.fId}', 'isMuted', ${!u.isMuted})">${u.isMuted?'ì–¸ë®¤íŠ¸':'ë®¤íŠ¸'}</button>
                    <button class="btn btn-danger" style="padding:5px;" onclick="admAct('${u.fId}', 'isBanned', ${!u.isBanned})">${u.isBanned?'ì–¸ë°´':'ë°´'}</button>
                </div>
            </div>
        `).join('');
    }

    async function admAct(fid, field, val) { await fdb.collection("users").doc(fid).update({ [field]: val }); }
    function goHome() { state.viewingId = null; showPage('home'); }
    function openModal(id) { document.getElementById(id).classList.add('active'); }
    function closeModal(id) { document.getElementById(id).classList.remove('active'); }
    function openWriteModal() { if(!state.user) return alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.'); openModal('writeModal'); }
    function toggleNoti() { const n = document.getElementById('notiBox'); n.style.display = n.style.display==='none'?'block':'none'; }
    function updateStats() { document.getElementById('stats').innerText = `ì „ì²´ ìœ ì €: ${state.users.length} | ì „ì²´ ê²Œì‹œê¸€: ${state.posts.length}`; }

    window.onload = init;
</script>

</body>
</html>
