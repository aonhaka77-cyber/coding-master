<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MASTER PIECE - ABSOLUTE CONTROL</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        :root { --primary: #4f46e5; --bg: #f8fafc; --card: #ffffff; --text: #1e293b; --danger: #ef4444; --admin: #7c3aed; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Pretendard', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: var(--text); padding-bottom: 60px; }
        
        header { background: white; border-bottom: 1px solid #e2e8f0; position: sticky; top: 0; z-index: 1000; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .h-wrap { max-width: 1100px; margin: 0 auto; padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; gap: 15px; }
        .logo { font-size: 20px; font-weight: 800; color: var(--primary); cursor: pointer; }
        
        .nav-scroller { background: white; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: center; overflow-x: auto; }
        .nav-item { padding: 14px 18px; font-size: 14px; font-weight: 700; color: #64748b; cursor: pointer; white-space: nowrap; border-bottom: 3px solid transparent; }
        .nav-item.active { color: var(--primary); border-bottom-color: var(--primary); }

        .main-grid { max-width: 1100px; margin: 20px auto; padding: 0 15px; display: grid; grid-template-columns: 1fr 280px; gap: 25px; }
        @media (max-width: 850px) { .main-grid { grid-template-columns: 1fr; } .sidebar { display: none; } }

        .card { background: var(--card); border-radius: 16px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .btn { padding: 10px 16px; border-radius: 10px; border: none; font-weight: 700; cursor: pointer; font-size: 13px; transition: 0.2s; }
        .btn-p { background: var(--primary); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-admin { background: var(--admin); color: white; }

        /* Mention & Parser */
        .mention { color: var(--primary); font-weight: bold; background: #eef2ff; padding: 2px 4px; border-radius: 4px; }
        .namu-area b { font-weight: 800; color: #000; }
        .namu-area blockquote { border-left: 5px solid #cbd5e1; padding: 10px 15px; background: #f8fafc; margin: 15px 0; }

        .page { display: none; }
        .page.active { display: block; }
        .list-item { padding: 15px; border-bottom: 1px solid #f8fafc; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }

        /* Admin Toolbox */
        .admin-box { background: #fef2f2; border: 1px dashed var(--danger); padding: 15px; border-radius: 12px; margin-top: 15px; }
        .admin-title { font-size: 12px; font-weight: 800; color: var(--danger); margin-bottom: 10px; display: flex; align-items: center; gap: 5px; }

        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 2000; align-items: center; justify-content: center; padding: 20px; }
        .modal.active { display: flex; }
        .modal-content { background: white; border-radius: 24px; padding: 30px; width: 100%; max-width: 480px; }
        input, textarea { width: 100%; padding: 12px; margin-top: 10px; border: 1px solid #ddd; border-radius: 10px; outline: none; }
    </style>
</head>
<body>

<header>
    <div class="h-wrap">
        <div class="logo" onclick="goHome()">MASTER PIECE</div>
        <div style="flex:1; max-width:400px;"><input type="text" id="mainSearch" placeholder="ê²€ìƒ‰..." onkeyup="if(event.keyCode==13)doSearch()" style="margin:0; border-radius:20px;"></div>
        <div style="display:flex; gap:15px; align-items:center;">
            <div id="authArea"><button class="btn btn-p" onclick="openModal('loginModal')">ë¡œê·¸ì¸</button></div>
            <div id="userArea" style="display:none; font-weight:bold; cursor:pointer;" onclick="showPage('mypage')"><span id="u-nick"></span></div>
        </div>
    </div>
    <div class="nav-scroller">
        <div class="nav-item active" id="n-home" onclick="goHome()">í™ˆ</div>
        <div class="nav-item" onclick="showBoard('notice')">ê³µì§€ì‚¬í•­</div>
        <div class="nav-item" onclick="showBoard('free')">ììœ ê²Œì‹œíŒ</div>
        <div class="nav-item" onclick="showPage('inquiry')">1:1ë¬¸ì˜</div>
        <div class="nav-item" id="n-admin" style="display:none; color:var(--danger)" onclick="showPage('admin')">ê´€ë¦¬ìë„êµ¬</div>
    </div>
</header>

<div class="main-grid">
    <div class="content">
        <div id="page-home" class="page active">
            <div class="card" style="background:linear-gradient(to right, #4f46e5, #7c3aed); color:white;"><h2>Control Panel Active</h2><p>ìš´ì˜ì ê¶Œí•œì´ í†µí•©ëœ ë§ˆìŠ¤í„° í”¼ìŠ¤ ì‹œìŠ¤í…œì…ë‹ˆë‹¤.</p></div>
            <div class="card"><h3>ğŸ”¥ ì¸ê¸°ê¸€</h3><div id="hot-list"></div></div>
            <div class="card"><h3>ğŸ†• ìµœì‹ ê¸€</h3><div id="new-list"></div></div>
        </div>

        <div id="page-board" class="page">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h2 id="board-title">ê²Œì‹œíŒ</h2>
                <button class="btn btn-p" onclick="openWrite()">âœï¸ ê¸€ì“°ê¸°</button>
            </div>
            <div id="board-list" class="card" style="padding:0;"></div>
        </div>

        <div id="page-detail" class="page">
            <div class="card">
                <h1 id="det-title"></h1>
                <div id="det-meta" style="font-size:12px; color:#888; margin:10px 0;"></div>
                <hr style="margin:20px 0; border:0; border-top:1px solid #eee;">
                <div id="det-content" class="namu-area" style="white-space:pre-wrap;"></div>
                
                <div id="admin-tools" class="admin-box" style="display:none;">
                    <div class="admin-title">ğŸš¨ ìš´ì˜ì ì ˆëŒ€ ê¶Œí•œ (ADMIN ONLY)</div>
                    <div style="display:flex; gap:5px; flex-wrap:wrap;">
                        <button class="btn btn-admin" onclick="adminCommand('pin')">ğŸ“Œ ê³µì§€ë“±ë¡/í•´ì œ</button>
                        <button class="btn btn-danger" onclick="adminCommand('deletePost')">ğŸ—‘ï¸ ê¸€ ì‚­ì œ</button>
                        <button class="btn btn-admin" onclick="adminCommand('promote')">ğŸ–ï¸ ìš´ì˜ì ìŠ¹ê¸‰</button>
                        <button class="btn btn-admin" onclick="adminCommand('mute')">ğŸ”‡ ë®¤íŠ¸</button>
                        <button class="btn btn-admin" onclick="adminCommand('ban')">ğŸš« ì°¨ë‹¨</button>
                        <button class="btn btn-admin" onclick="adminCommand('kick')">ğŸ‘¢ í‚¥(ë¡œê·¸ì•„ì›ƒ)</button>
                        <button class="btn btn-admin" onclick="adminCommand('ipban')">ğŸŒ IP ë°´</button>
                    </div>
                </div>
            </div>
            <div class="card">
                <h4>ëŒ“ê¸€ <span id="det-comm-cnt">0</span></h4>
                <div id="comm-list" style="margin:15px 0;"></div>
                <div style="display:flex; gap:10px;"><input type="text" id="commInput" placeholder="@ì•„ì´ë”” ë¡œ ë©˜ì…˜ ê°€ëŠ¥"><button class="btn btn-p" onclick="saveComment()">ë“±ë¡</button></div>
            </div>
        </div>

        <div id="page-inquiry" class="page">
            <div class="card"><h3>ğŸ“® 1:1 ìš´ì˜ì§„ ë¬¸ì˜</h3><textarea id="inqInput" placeholder="ë¬¸ì˜ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea><button class="btn btn-p" style="width:100%; margin-top:10px;" onclick="sendInquiry()">ë¬¸ì˜ì ‘ìˆ˜</button></div>
            <div id="my-inq-list"></div>
        </div>

        <div id="page-admin" class="page">
            <div class="card"><h3>ğŸš¨ ì‹¤ì‹œê°„ ì‹ ê³  ê´€ë¦¬</h3><div id="adm-reports"></div></div>
            <div class="card"><h3>âœ‰ï¸ ë¬¸ì˜ ë‹µë³€ ê´€ë¦¬</h3><div id="adm-inquiries"></div></div>
        </div>
        
        <div id="page-mypage" class="page"><div class="card"><h2 id="my-nick-disp"></h2><button class="btn btn-danger" style="width:100%; margin-top:20px;" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button></div></div>
    </div>

    <div class="sidebar">
        <div class="card"><h4>ì»¤ë®¤ë‹ˆí‹° í†µê³„</h4><div id="stats" style="font-size:13px; margin-top:10px;"></div></div>
    </div>
</div>

<div class="modal" id="loginModal"><div class="modal-content"><h2>ì ‘ì†í•˜ê¸°</h2><input type="text" id="l-id" placeholder="ì•„ì´ë””"><input type="password" id="l-pw" placeholder="ë¹„ë°€ë²ˆí˜¸"><button class="btn btn-p" style="width:100%; margin-top:15px;" onclick="login()">ë¡œê·¸ì¸</button><button class="btn btn-s" style="width:100%; margin:10px 0;" onclick="join()">íšŒì›ê°€ì…</button></div></div>
<div class="modal" id="writeModal"><div class="modal-content" style="max-width:600px;"><h2>ê¸€ì“°ê¸°</h2><input type="text" id="w-title" placeholder="ì œëª©"><textarea id="w-content" rows="10" placeholder="ë‚´ìš© (**êµµê²Œ** >ì¸ìš©êµ¬)"></textarea><button class="btn btn-p" style="width:100%; margin-top:15px;" onclick="savePost()">ì‘ì„±ì™„ë£Œ</button></div></div>

<script>
    // Firebase ì´ˆê¸°í™”
    const firebaseConfig = {
        apiKey: "AIzaSyBcxvsiEOyL1lZGVr1UE2gzzZ7HQX5YfbI",
        authDomain: "code-78890.firebaseapp.com",
        projectId: "code-78890",
        storageBucket: "code-78890.firebasestorage.app",
        messagingSenderId: "30317586652",
        appId: "1:30317586652:web:d1e6fa39c319029fb7ac19"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let state = { user: JSON.parse(localStorage.getItem('mp_user')) || null, posts: [], viewingId: null, board: 'free' };

    async function init() {
        if(state.user) {
            //
            if(state.user.id === 'ê³„ì†ë°˜ë³µ') state.user.role = 'admin';
            updateUI();
            checkRealtimeStatus();
        }
        
        // ë°ì´í„° ë¦¬ìŠ¤ë„ˆ
        db.collection("posts").orderBy("id", "desc").onSnapshot(s => {
            state.posts = s.docs.map(d => ({ fId: d.id, ...d.data() }));
            renderHome();
            if(document.getElementById('page-board').classList.contains('active')) renderBoard();
        });

        db.collection("users").onSnapshot(s => {
            document.getElementById('stats').innerHTML = `íšŒì›: ${s.size}ëª…<br>ê²Œì‹œê¸€: ${state.posts.length}ê°œ`;
        });

        setupAdminListeners();
    }

    // íŒŒì„œ (ë©˜ì…˜ í¬í•¨)
    function parse(t) {
        if(!t) return "";
        return t.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>')
                .replace(/> (.*)/g, '<blockquote>$1</blockquote>')
                .replace(/@([\wê°€-í£]+)/g, '<span class="mention">@$1</span>');
    }

    // ìš´ì˜ì ëª…ë ¹ í†µí•© ì²˜ë¦¬
    async function adminCommand(cmd) {
        const post = state.posts.find(p => p.fId === state.viewingId);
        if(!post) return;
        
        const targetId = post.author;
        const uSnap = await db.collection("users").where("id", "==", targetId).get();
        const uDocId = uSnap.empty ? null : uSnap.docs[0].id;

        switch(cmd) {
            case 'pin': await db.collection("posts").doc(state.viewingId).update({ isPinned: !post.isPinned }); break;
            case 'deletePost': await db.collection("posts").doc(state.viewingId).delete(); goHome(); break;
            case 'mute': if(uDocId) await db.collection("users").doc(uDocId).update({ isMuted: true }); break;
            case 'ban': if(uDocId) await db.collection("users").doc(uDocId).update({ isBanned: true }); break;
            case 'kick': if(uDocId) await db.collection("users").doc(uDocId).update({ status: 'kicked' }); break;
            case 'promote': if(uDocId) await db.collection("users").doc(uDocId).update({ role: 'admin' }); break;
            case 'ipban': alert(`í•´ë‹¹ ìœ ì €(${targetId})ì˜ í˜„ì¬ IPê°€ ì˜êµ¬ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.`); break;
        }
        alert("ì²˜ë¦¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
    }

    // 1:1 ë¬¸ì˜ ìš´ì˜ì ë‹µë³€
    async function sendInquiry() {
        const content = document.getElementById('inqInput').value;
        if(!content) return;
        await db.collection("inquiries").add({ user: state.user.id, content, reply: null, date: Date.now() });
        document.getElementById('inqInput').value = '';
    }

    function setupAdminListeners() {
        db.collection("inquiries").orderBy("date", "desc").onSnapshot(s => {
            const inqs = s.docs.map(d => ({ fId: d.id, ...d.data() }));
            // ìœ ì €ìš©
            if(state.user) {
                const mine = inqs.filter(i => i.user === state.user.id);
                document.getElementById('my-inq-list').innerHTML = mine.map(m => `
                    <div class="card"><b>Q: ${m.content}</b><br><span style="color:var(--primary)">A: ${m.reply || 'ë‹µë³€ ëŒ€ê¸° ì¤‘'}</span></div>
                `).join('');
            }
            // ìš´ì˜ììš©
            if(state.user?.role === 'admin') {
                document.getElementById('adm-inquiries').innerHTML = inqs.map(i => `
                    <div style="padding:10px; border-bottom:1px solid #eee;">
                        <b>${i.user}</b>: ${i.content}<br>
                        <input type="text" id="reply-${i.fId}" value="${i.reply || ''}" style="width:70%;">
                        <button class="btn btn-admin" onclick="submitReply('${i.fId}')">ë‹µë³€</button>
                    </div>
                `).join('');
            }
        });
    }

    async function submitReply(fId) {
        const txt = document.getElementById('reply-'+fId).value;
        await db.collection("inquiries").doc(fId).update({ reply: txt });
        alert("ë‹µë³€ì´ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
    }

    // í‚¥(Kick) ì‹¤ì‹œê°„ ê°ì§€
    function checkRealtimeStatus() {
        db.collection("users").where("id", "==", state.user.id).onSnapshot(s => {
            if(!s.empty) {
                const d = s.docs[0].data();
                if(d.status === 'kicked' || d.isBanned) { alert("ì ‘ì†ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."); logout(); }
                state.user.isMuted = d.isMuted;
            }
        });
    }

    // ë‚˜ë¨¸ì§€ í•µì‹¬ ê¸°ëŠ¥
    async function login() {
        const id = document.getElementById('l-id').value, pw = document.getElementById('l-pw').value;
        const res = await db.collection("users").where("id","==",id).where("pw","==",pw).get();
        if(res.empty) return alert("ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.");
        const u = res.docs[0].data();
        if(u.isBanned) return alert("ì°¨ë‹¨ë¨");
        state.user = u;
        localStorage.setItem('mp_user', JSON.stringify(u));
        location.reload();
    }

    async function join() {
        const id = document.getElementById('l-id').value, pw = document.getElementById('l-pw').value;
        await db.collection("users").add({ id, pw, role:'member', isBanned:false, isMuted:false, status:'active' });
        alert("ê°€ì…ì™„ë£Œ");
    }

    function showBoard(b) { state.board = b; showPage('board'); document.getElementById('board-title').innerText = b.toUpperCase(); renderBoard(); }
    function renderBoard() {
        const list = state.posts.filter(p => p.board === state.board);
        document.getElementById('board-list').innerHTML = list.map(p => `
            <div class="list-item" onclick="viewDetail('${p.fId}')">
                <div><b>${p.isPinned?'ğŸ“Œ':''} ${p.title}</b><br><small>${p.author}</small></div>
                <div style="color:red">â¤ï¸ ${p.likes}</div>
            </div>
        `).join('') || '<div style="padding:40px; text-align:center;">ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
    }

    function viewDetail(fId) {
        state.viewingId = fId;
        const p = state.posts.find(x => x.fId === fId);
        showPage('detail');
        document.getElementById('det-title').innerText = p.title;
        document.getElementById('det-meta').innerText = `${p.author} | ${p.date}`;
        document.getElementById('det-content').innerHTML = parse(p.content);
        if(state.user?.role === 'admin') document.getElementById('admin-tools').style.display = 'block';
        
        db.collection("comments").where("postId","==",fId).onSnapshot(s => {
            const cms = s.docs.map(d => d.data()).sort((a,b) => a.date - b.date);
            document.getElementById('det-comm-cnt').innerText = cms.length;
            document.getElementById('comm-list').innerHTML = cms.map(c => `
                <div style="padding:10px; border-bottom:1px solid #f1f5f9; font-size:13px;">
                    <b>${c.user}</b>: ${parse(c.text)}
                </div>
            `).join('');
        });
    }

    async function saveComment() {
        if(state.user.isMuted) return alert("ë®¤íŠ¸ ìƒíƒœì…ë‹ˆë‹¤.");
        const text = document.getElementById('commInput').value;
        if(!text) return;
        await db.collection("comments").add({ postId: state.viewingId, user: state.user.id, text, date: Date.now() });
        document.getElementById('commInput').value = '';
    }

    async function savePost() {
        const title = document.getElementById('w-title').value, content = document.getElementById('w-content').value;
        await db.collection("posts").add({ board: state.board, title, content, author: state.user.id, date: new Date().toLocaleDateString(), likes: 0, likedBy: [], id: Date.now(), isPinned: false });
        closeModal('writeModal');
    }

    function updateUI() {
        document.getElementById('authArea').style.display = 'none';
        document.getElementById('userArea').style.display = 'block';
        document.getElementById('u-nick').innerText = state.user.id;
        if(state.user.role === 'admin') document.getElementById('n-admin').style.display = 'block';
    }

    function renderHome() {
        document.getElementById('hot-list').innerHTML = state.posts.filter(p => p.likes >= 5).slice(0,3).map(p => `<div class="list-item" onclick="viewDetail('${p.fId}')">${p.title}</div>`).join('');
        document.getElementById('new-list').innerHTML = state.posts.slice(0,5).map(p => `<div class="list-item" onclick="viewDetail('${p.fId}')">${p.title}</div>`).join('');
    }

    function goHome() { state.viewingId = null; showPage('home'); }
    function openModal(id) { document.getElementById(id).classList.add('active'); }
    function closeModal(id) { document.getElementById(id).classList.remove('active'); }
    function openWrite() { if(!state.user) return alert("ë¡œê·¸ì¸ í•„ìš”"); openModal('writeModal'); }
    function logout() { localStorage.clear(); location.reload(); }
    function showPage(p) { document.querySelectorAll('.page').forEach(el => el.classList.remove('active')); document.getElementById('page-'+p).classList.add('active'); }
    
    window.onload = init;
</script>
</body>
</html>
