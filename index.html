<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coding Master | Developer Community</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">

    <style>
        :root { --primary: #4f46e5; --primary-hover: #4338ca; --bg: #f1f5f9; }
        body { background: var(--bg); font-family: 'Pretendard', sans-serif; color: #1e293b; }
        .navbar { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border-bottom: 1px solid #e2e8f0; }
        .sidebar-link { border-radius: 8px; margin-bottom: 5px; transition: all 0.2s; cursor: pointer; font-weight: 500; text-decoration: none; color: inherit; display: block; padding: 10px 15px; }
        .sidebar-link:hover { background-color: #e2e8f0; color: var(--primary); }
        .sidebar-link.active { background-color: var(--primary) !important; color: white !important; }
        .card { border: none; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); transition: transform 0.2s; }
        .post-card:hover { transform: translateY(-3px); }
        .badge-notice { background: #fee2e2; color: #ef4444; }
        .badge-qna { background: #fef3c7; color: #d97706; }
        .badge-free { background: #e0f2fe; color: #0ea5e9; }
        .empty-state { text-align: center; padding: 40px; color: #94a3b8; }
        pre { background: #f8fafc; padding: 15px; border-radius: 8px; white-space: pre-wrap; font-family: 'Courier New', Courier, monospace; }
        .noti-badge { position: absolute; top: -5px; right: -5px; font-size: 0.65rem; }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg sticky-top mb-4">
        <div class="container">
            <a class="navbar-brand fw-bold text-primary" onclick="showPage('home')" style="cursor:pointer">ğŸš€ Coding Master</a>
            <div class="d-flex align-items-center">
                <div id="auth-zone" class="me-3"></div>
                <div class="position-relative" onclick="showPage('noti')" style="cursor:pointer">
                    <span style="font-size: 1.4rem;">ğŸ””</span>
                    <span id="noti-count" class="badge rounded-pill bg-danger noti-badge" style="display:none">0</span>
                </div>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="row">
            <div class="col-md-3 mb-4">
                <div class="card p-3 shadow-sm">
                    <div class="list-group list-group-flush">
                        <small class="text-muted px-3 mb-2">ê²Œì‹œíŒ</small>
                        <a class="sidebar-link active" id="menu-all" onclick="filterCategory('all')">ğŸ  ì „ì²´ ê²Œì‹œê¸€</a>
                        <a class="sidebar-link" id="menu-notice" onclick="filterCategory('notice')">ğŸ“¢ ê³µì§€ì‚¬í•­</a>
                        <a class="sidebar-link" id="menu-free" onclick="filterCategory('free')">ğŸŒ± ììœ ê²Œì‹œíŒ</a>
                        <a class="sidebar-link" id="menu-qna" onclick="filterCategory('qna')">â“ Q&A / ê±´ì˜</a>
                        <hr>
                        <a class="sidebar-link" onclick="showPage('write')">âœï¸ ìƒˆ ê¸€ ì‘ì„±</a>
                        <a class="sidebar-link" onclick="showPage('inquiry')">ğŸ’¬ 1:1 ë¬¸ì˜</a>
                        <div id="admin-menu" style="display:none">
                            <hr>
                            <small class="text-danger px-3 mb-2 fw-bold">ADMIN ONLY</small>
                            <a class="sidebar-link text-danger" onclick="showPage('admin')">âš™ï¸ ê´€ë¦¬ì ì„¼í„°</a>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-9">
                <div id="page-home" class="page-content">
                    <h4 class="fw-bold mb-4" id="board-title">ìµœì‹  ì»¤ë®¤ë‹ˆí‹° ê¸€</h4>
                    <div id="post-list" class="row g-4"></div>
                </div>

                <div id="page-write" class="page-content" style="display:none">
                    <div class="card p-4">
                        <h4 class="fw-bold mb-4">âœï¸ ì§€ì‹ ê³µìœ í•˜ê¸°</h4>
                        <select id="postCategory" class="form-select mb-3 border-0 shadow-sm" style="background:#f8fafc;">
                            <option value="free">ììœ ê²Œì‹œíŒ</option>
                            <option value="qna">Q&A (ì§ˆë¬¸/ê±´ì˜)</option>
                            <option value="notice" id="opt-notice" style="display:none">ê³µì§€ì‚¬í•­ (ìš´ì˜ì ì „ìš©)</option>
                        </select>
                        <input id="postTitle" class="form-control mb-3 p-3 border-0 shadow-sm" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" style="background:#f8fafc;">
                        <textarea id="postContent" class="form-control mb-3 p-3 border-0 shadow-sm" rows="10" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..." style="background:#f8fafc;"></textarea>
                        <div class="mb-4">
                            <label class="form-label small fw-bold text-muted">ğŸ“ íŒŒì¼ ì²¨ë¶€ (ì„ íƒ)</label>
                            <input type="file" id="postFile" class="form-control border-0 shadow-sm" style="background:#f8fafc;">
                        </div>
                        <button id="uploadBtn" class="btn btn-primary w-100 fw-bold p-3" onclick="uploadPost()">ê²Œì‹œë¬¼ ë“±ë¡í•˜ê¸°</button>
                    </div>
                </div>

                <div id="page-view" class="page-content" style="display:none">
                    <div class="card p-4 mb-4">
                        <div id="post-detail"></div>
                        <hr class="my-4">
                        <h5 class="fw-bold mb-3">ëŒ“ê¸€ <span id="comment-total" class="text-primary">0</span></h5>
                        <div id="comment-list" class="mb-4"></div>
                        <div class="input-group shadow-sm">
                            <input id="commInput" class="form-control border-0 p-3" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•´ ë³´ì„¸ìš”...">
                            <button class="btn btn-primary px-4" onclick="addComment()">ë“±ë¡</button>
                        </div>
                    </div>
                </div>

                <div id="page-admin" class="page-content" style="display:none">
                    <h4 class="fw-bold mb-4 text-danger">âš™ï¸ ê´€ë¦¬ì ì„¼í„° (1:1 ë¬¸ì˜ ê´€ë¦¬)</h4>
                    <div id="admin-inquiry-list"></div>
                </div>

                <div id="page-noti" class="page-content" style="display:none">
                    <h4 class="fw-bold mb-4">ğŸ”” ì•Œë¦¼ ì„¼í„°</h4>
                    <div id="noti-list"></div>
                </div>

                <div id="page-inquiry" class="page-content" style="display:none">
                    <div class="card p-4 mb-4">
                        <h4 class="fw-bold">ğŸ’¬ 1:1 ë¬¸ì˜í•˜ê¸°</h4>
                        <textarea id="inqInput" class="form-control mb-3 border-0 shadow-sm" style="background:#f8fafc;" rows="3" placeholder="ê´€ë¦¬ìì—ê²Œ ê¶ê¸ˆí•œ ì ì„ ë‚¨ê²¨ì£¼ì„¸ìš”."></textarea>
                        <button class="btn btn-dark w-100" onclick="sendInquiry()">ë¬¸ì˜ ì ‘ìˆ˜</button>
                    </div>
                    <h5 class="fw-bold mb-3">ë‚´ ë¬¸ì˜ ë‚´ì—­</h5>
                    <div id="my-inq-list"></div>
                </div>

                <div id="page-auth" class="page-content" style="display:none">
                    <div class="card p-4 mx-auto" style="max-width: 400px;">
                        <h3 class="fw-bold text-center mb-4">ë¡œê·¸ì¸</h3>
                        <input id="authEmail" class="form-control mb-3" placeholder="ì´ë©”ì¼">
                        <input id="authPassword" type="password" class="form-control mb-3" placeholder="ë¹„ë°€ë²ˆí˜¸">
                        <button class="btn btn-primary w-100 mb-2" onclick="handleLogin()">ë¡œê·¸ì¸</button>
                        <button class="btn btn-outline-secondary w-100" onclick="handleSignUp()">íšŒì›ê°€ì…</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 1. Firebase ì„¤ì • (ë³¸ì¸ì˜ ì„¤ì •ê°’ í™•ì¸)
        const firebaseConfig = {
            apiKey: "AIzaSyBcxvsiEOyL1lZGVr1UE2gzzZ7HQX5YfbI",
            authDomain: "code-78890.firebaseapp.com",
            projectId: "code-78890",
            storageBucket: "code-78890.appspot.com",
            messagingSenderId: "33834164177",
            appId: "1:33834164177:web:866380c541434386266f81"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        // 2. ì „ì—­ ìƒíƒœ
        let state = { user: null, posts: [], currentCat: 'all', viewingId: null };

        // 3. ì¸ì¦ ë¡œì§ (ì´ë¯¸ì§€ ê¸°ë°˜ role ì²´í¬ ì¶”ê°€)
        auth.onAuthStateChanged(async (user) => {
            const authZone = document.getElementById('auth-zone');
            if (user) {
                const userDoc = await db.collection("users").doc(user.uid).get();
                const userData = userDoc.exists ? userDoc.data() : { role: 'member', id: user.email.split('@')[0] };
                
                state.user = { uid: user.uid, ...userData };
                
                authZone.innerHTML = `
                    <span class="me-2 fw-bold">${state.user.role === 'admin' ? 'ğŸ›¡ï¸ ' : ''}${state.user.id}ë‹˜</span>
                    <button class="btn btn-sm btn-outline-danger border-0" onclick="auth.signOut()">ë¡œê·¸ì•„ì›ƒ</button>
                `;
                
                if(state.user.role === 'admin') {
                    document.getElementById('admin-menu').style.display = 'block';
                    document.getElementById('opt-notice').style.display = 'block';
                }
                loadNotis();
            } else {
                state.user = null;
                authZone.innerHTML = `<button class="btn btn-sm btn-primary" onclick="showPage('auth')">ë¡œê·¸ì¸</button>`;
                document.getElementById('admin-menu').style.display = 'none';
                document.getElementById('opt-notice').style.display = 'none';
            }
        });

        // 4. í˜ì´ì§€ ë° í•„í„° ë¡œì§
        function showPage(pageId) {
            document.querySelectorAll('.page-content').forEach(p => p.style.display = 'none');
            document.getElementById('page-' + pageId).style.display = 'block';
            if(pageId === 'admin') loadAdminInquiries();
            if(pageId === 'inquiry' && state.user) loadMyInquiries();
            window.scrollTo(0,0);
        }

        function filterCategory(cat) {
            state.currentCat = cat;
            document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
            document.getElementById('menu-' + cat).classList.add('active');
            renderPosts();
            showPage('home');
        }

        // 5. ê²Œì‹œê¸€ CRUD (íŒŒì¼ ì—…ë¡œë“œ í¬í•¨)
        async function uploadPost() {
            if(!state.user) return alert("ë¡œê·¸ì¸í•˜ì„¸ìš”.");
            const title = document.getElementById('postTitle').value;
            const content = document.getElementById('postContent').value;
            const category = document.getElementById('postCategory').value;
            const file = document.getElementById('postFile').files[0];
            const btn = document.getElementById('uploadBtn');

            if(!title || !content) return alert("ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.");
            btn.disabled = true; btn.innerText = "ì—…ë¡œë“œ ì¤‘...";

            try {
                let fileUrl = null;
                let fileName = null;
                if(file) {
                    const ref = storage.ref(`posts/${Date.now()}_${file.name}`);
                    await ref.put(file);
                    fileUrl = await ref.getDownloadURL();
                    fileName = file.name;
                }

                await db.collection("posts").add({
                    title, content, category, fileUrl, fileName,
                    authorId: state.user.id, authorUid: state.user.uid,
                    date: Date.now(), likes: 0, likedBy: []
                });
                location.reload();
            } catch(e) { alert(e.message); btn.disabled = false; }
        }

        function loadData() {
            db.collection("posts").orderBy("date", "desc").onSnapshot(snap => {
                state.posts = snap.docs.map(d => ({ fId: d.id, ...d.data() }));
                renderPosts();
                if(state.viewingId) renderDetail();
            });
        }

        function renderPosts() {
            const list = document.getElementById('post-list');
            const filtered = state.currentCat === 'all' ? state.posts : state.posts.filter(p => p.category === state.currentCat);
            
            if(filtered.length === 0) {
                list.innerHTML = '<div class="empty-state">ê¸€ì´ ì—†ìŠµë‹ˆë‹¤. ì²« ê¸€ì„ ë‚¨ê²¨ë³´ì„¸ìš”!</div>'; return;
            }

            list.innerHTML = filtered.map(p => `
                <div class="col-md-6">
                    <div class="card h-100 p-4 post-card border-0 shadow-sm" onclick="viewPost('${p.fId}')" style="cursor:pointer">
                        <div class="mb-2">
                            <span class="badge badge-${p.category || 'free'}">${p.category === 'notice' ? 'ğŸ“¢ ê³µì§€' : p.category === 'qna' ? 'â“ Q&A' : 'ğŸŒ± ììœ '}</span>
                        </div>
                        <h5 class="fw-bold mb-2 text-truncate">${p.title}</h5>
                        <p class="text-muted small text-truncate-2" style="height:3rem">${p.content.substring(0,80)}</p>
                        <div class="d-flex justify-content-between align-items-center mt-3 pt-3 border-top">
                            <span class="small fw-bold">ğŸ‘¤ ${p.authorId}</span>
                            <span class="text-danger small">â¤ï¸ ${p.likes || 0} ${p.fileUrl ? 'ğŸ“' : ''}</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function viewPost(id) {
            state.viewingId = id; showPage('view'); renderDetail(); loadComments(id);
        }

        function renderDetail() {
            const p = state.posts.find(x => x.fId === state.viewingId);
            if(!p) return;
            const isLiked = p.likedBy?.includes(state.user?.uid);
            
            document.getElementById('post-detail').innerHTML = `
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <h2 class="fw-bold">${p.title}</h2>
                    ${(p.authorUid === state.user?.uid || state.user?.role === 'admin') ? `<button class="btn btn-sm btn-outline-danger" onclick="deletePost('${p.fId}')">ì‚­ì œ</button>` : ''}
                </div>
                <div class="mb-4 text-muted small"><b>${p.authorId}</b> | ${new Date(p.date).toLocaleString()}</div>
                <div class="mb-4" style="line-height:1.8; white-space:pre-wrap;">${p.content}</div>
                ${p.fileUrl ? `
                    <div class="p-3 bg-light rounded d-flex justify-content-between align-items-center mb-4">
                        <span class="small">ğŸ“ ì²¨ë¶€íŒŒì¼: ${p.fileName}</span>
                        <a href="${p.fileUrl}" target="_blank" class="btn btn-sm btn-dark">ë‹¤ìš´ë¡œë“œ</a>
                    </div>
                ` : ''}
                <button class="btn ${isLiked ? 'btn-danger' : 'btn-outline-danger'} px-4" onclick="handleLike()">â¤ï¸ ì¢‹ì•„ìš” ${p.likes || 0}</button>
            `;
        }

        async function deletePost(id) {
            if(confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { await db.collection("posts").doc(id).delete(); showPage('home'); }
        }

        // 6. ê´€ë¦¬ì ì „ìš© ë¬¸ì˜ ë‹µë³€ ê¸°ëŠ¥
        async function loadAdminInquiries() {
            const snap = await db.collection("inquiries").orderBy("date", "desc").get();
            const list = document.getElementById('admin-inquiry-list');
            list.innerHTML = snap.docs.map(d => {
                const data = d.data();
                return `
                    <div class="card p-3 mb-3 border-0 shadow-sm">
                        <div class="small text-muted mb-2">ì‘ì„±ì: ${data.userId} | ${new Date(data.date).toLocaleDateString()}</div>
                        <div class="fw-bold mb-3">Q: ${data.content}</div>
                        ${data.answer ? `<div class="p-2 bg-light text-primary rounded small">A: ${data.answer}</div>` : `
                            <div class="input-group">
                                <input id="ans-${d.id}" class="form-control" placeholder="ë‹µë³€ ì…ë ¥...">
                                <button class="btn btn-primary" onclick="answerInquiry('${d.id}', '${data.userUid}')">ë‹µë³€</button>
                            </div>
                        `}
                    </div>
                `;
            }).join('');
        }

        async function answerInquiry(id, userUid) {
            const ans = document.getElementById(`ans-${id}`).value;
            if(!ans) return;
            await db.collection("inquiries").doc(id).update({ answer: ans });
            sendNoti(userUid, `ğŸ’¬ ë¬¸ì˜í•˜ì‹  ë‚´ìš©ì— ë‹µë³€ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            loadAdminInquiries();
        }

        // 7. ê¸°íƒ€ ê¸°ëŠ¥ (ì¢‹ì•„ìš”, ëŒ“ê¸€, ì•Œë¦¼, 1:1ë¬¸ì˜) - ê¸°ì¡´ ì½”ë“œ ìœ ì§€ ë° ì—°ë™
        async function handleLike() {
            if(!state.user) return alert("ë¡œê·¸ì¸í•˜ì„¸ìš”.");
            const p = state.posts.find(x => x.fId === state.viewingId);
            const ref = db.collection("posts").doc(state.viewingId);
            if(p.likedBy?.includes(state.user.uid)) {
                await ref.update({ likes: firebase.firestore.FieldValue.increment(-1), likedBy: firebase.firestore.FieldValue.arrayRemove(state.user.uid) });
            } else {
                await ref.update({ likes: firebase.firestore.FieldValue.increment(1), likedBy: firebase.firestore.FieldValue.arrayUnion(state.user.uid) });
                if(p.authorUid !== state.user.uid) sendNoti(p.authorUid, `â¤ï¸ '${p.title}' ê¸€ì— ì¢‹ì•„ìš”ê°€ ë‹¬ë ¸ìŠµë‹ˆë‹¤!`);
            }
        }

        async function addComment() {
            const val = document.getElementById('commInput').value;
            if(!val || !state.user) return;
            const p = state.posts.find(x => x.fId === state.viewingId);
            await db.collection("comments").add({ postId: state.viewingId, author: state.user.id, text: val, date: Date.now() });
            document.getElementById('commInput').value = '';
            if(p.authorUid !== state.user.uid) sendNoti(p.authorUid, `ğŸ’¬ '${p.title}' ê¸€ì— ëŒ“ê¸€ì´ ë‹¬ë ¸ìŠµë‹ˆë‹¤.`);
        }

        function loadComments(postId) {
            db.collection("comments").where("postId", "==", postId).orderBy("date", "asc").onSnapshot(snap => {
                document.getElementById('comment-total').innerText = snap.size;
                document.getElementById('comment-list').innerHTML = snap.docs.map(d => `
                    <div class="p-3 mb-2 rounded bg-light small">
                        <div class="d-flex justify-content-between mb-1"><span class="fw-bold text-primary">${d.data().author}</span></div>
                        <div>${d.data().text}</div>
                    </div>
                `).join('');
            });
        }

        async function sendNoti(to, msg) { await db.collection("notis").add({ to, msg, read: false, date: Date.now() }); }
        
        function loadNotis() {
            db.collection("notis").where("to", "==", state.user.uid).orderBy("date", "desc").onSnapshot(snap => {
                const unread = snap.docs.filter(d => !d.data().read).length;
                document.getElementById('noti-count').innerText = unread;
                document.getElementById('noti-count').style.display = unread > 0 ? 'block' : 'none';
                document.getElementById('noti-list').innerHTML = snap.docs.map(d => `
                    <div class="card p-3 mb-2 ${d.data().read ? 'opacity-50' : 'border-primary'}" onclick="db.collection('notis').doc('${d.id}').update({read:true})">
                        ${d.data().msg}
                    </div>
                `).join('');
            });
        }

        async function sendInquiry() {
            const txt = document.getElementById('inqInput').value;
            if(!txt || !state.user) return;
            await db.collection("inquiries").add({ userUid: state.user.uid, userId: state.user.id, content: txt, answer: null, date: Date.now() });
            alert("ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤."); document.getElementById('inqInput').value = '';
        }

        function loadMyInquiries() {
            db.collection("inquiries").where("userUid", "==", state.user.uid).orderBy("date", "desc").onSnapshot(snap => {
                document.getElementById('my-inq-list').innerHTML = snap.docs.map(d => `
                    <div class="card p-3 mb-2 border-0 shadow-sm">
                        <div class="fw-bold">Q: ${d.data().content}</div>
                        <div class="mt-2 small ${d.data().answer ? 'text-primary' : 'text-muted'}">${d.data().answer ? 'A: ' + d.data().answer : 'ë‹µë³€ ëŒ€ê¸° ì¤‘'}</div>
                    </div>
                `).join('');
            });
        }

        async function handleLogin() {
            try { await auth.signInWithEmailAndPassword(document.getElementById('authEmail').value, document.getElementById('authPassword').value); showPage('home'); } catch(e) { alert("ë¡œê·¸ì¸ ì‹¤íŒ¨"); }
        }
        
        async function handleSignUp() {
            const email = document.getElementById('authEmail').value;
            const pw = document.getElementById('authPassword').value;
            try {
                const cred = await auth.createUserWithEmailAndPassword(email, pw);
                await db.collection("users").doc(cred.user.uid).set({
                    id: email.split('@')[0], role: 'member', date: Date.now()
                });
                alert("ê°€ì… ì™„ë£Œ!"); showPage('home');
            } catch(e) { alert(e.message); }
        }

        // ì‹¤í–‰
        loadData();
    </script>
</body>
</html>
