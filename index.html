<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coding Master | Developer Community</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">

    <style>
        :root { 
            --primary: #4f46e5; 
            --primary-hover: #4338ca;
            --bg: #f1f5f9; 
            --card-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        
        body { background: var(--bg); font-family: 'Pretendard', sans-serif; color: #1e293b; }
        
        /* Layout */
        .navbar { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border-bottom: 1px solid #e2e8f0; }
        .sidebar-link { 
            border-radius: 8px; 
            margin-bottom: 5px; 
            transition: all 0.2s; 
            cursor: pointer;
            font-weight: 500;
        }
        .sidebar-link:hover { background-color: #e2e8f0; color: var(--primary); }
        .sidebar-link.active { background-color: var(--primary) !important; color: white !important; }

        /* Components */
        .card { border: none; border-radius: 16px; box-shadow: var(--card-shadow); transition: transform 0.2s; }
        .post-card:hover { transform: translateY(-5px); }
        .btn-primary { background: var(--primary); border: none; padding: 0.6rem 1.2rem; border-radius: 10px; }
        .btn-primary:hover { background: var(--primary-hover); }
        
        .noti-badge { 
            position: absolute; top: -5px; right: -5px; 
            font-size: 0.65rem; padding: 0.35em 0.65em;
        }

        .comment-item { background: #f8fafc; border-radius: 12px; padding: 12px; margin-bottom: 10px; }
        .empty-state { text-align: center; padding: 40px; color: #94a3b8; }
        
        pre { background: #f8fafc; padding: 15px; border-radius: 8px; white-space: pre-wrap; }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg sticky-top mb-4">
        <div class="container">
            <a class="navbar-brand fw-bold text-primary" onclick="showPage('home')" style="cursor:pointer">
                ğŸš€ Coding Master
            </a>
            <div class="d-flex align-items-center">
                <div id="auth-zone" class="me-3"></div>
                <div class="position-relative" onclick="showPage('noti')" style="cursor:pointer">
                    <span style="font-size: 1.4rem;">ğŸ””</span>
                    <span id="noti-count" class="badge rounded-pill bg-danger noti-badge" style="display:none">0</span>
                </div>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="row">
            <div class="col-md-3 mb-4">
                <div class="card p-3 shadow-sm">
                    <div class="list-group list-group-flush">
                        <a class="list-group-item list-group-item-action sidebar-link border-0 active" id="menu-home" onclick="showPage('home')">ğŸ  ì „ì²´ ê²Œì‹œê¸€</a>
                        <a class="list-group-item list-group-item-action sidebar-link border-0" id="menu-write" onclick="showPage('write')">âœï¸ ìƒˆ ê¸€ ì‘ì„±</a>
                        <a class="list-group-item list-group-item-action sidebar-link border-0" id="menu-inquiry" onclick="showPage('inquiry')">ğŸ’¬ 1:1 ë¬¸ì˜</a>
                    </div>
                </div>
            </div>

            <div class="col-md-9">
                <div id="page-home" class="page-content">
                    <h4 class="fw-bold mb-4">ìµœì‹  ì»¤ë®¤ë‹ˆí‹° ê¸€</h4>
                    <div id="post-list" class="row g-4">
                        <div class="empty-state">ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>
                    </div>
                </div>

                <div id="page-write" class="page-content" style="display:none">
                    <div class="card p-4">
                        <h4 class="fw-bold mb-4">âœï¸ ë©‹ì§„ ì§€ì‹ì„ ê³µìœ í•´ì£¼ì„¸ìš”</h4>
                        <input id="postTitle" class="form-control mb-3 p-3 shadow-sm border-0" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" style="background: #f8fafc;">
                        <textarea id="postContent" class="form-control mb-3 p-3 shadow-sm border-0" rows="12" placeholder="ì½”ë“œë‚˜ ì§€ì‹ì„ ììœ ë¡­ê²Œ ì‘ì„±í•˜ì„¸ìš”..." style="background: #f8fafc;"></textarea>
                        <button class="btn btn-primary w-100 fw-bold" onclick="uploadPost()">ê²Œì‹œë¬¼ ë“±ë¡í•˜ê¸°</button>
                    </div>
                </div>

                <div id="page-view" class="page-content" style="display:none">
                    <div class="card p-4 mb-4">
                        <div id="post-detail"></div>
                        <hr class="my-4">
                        <h5 class="fw-bold mb-3">ëŒ“ê¸€ <span id="comment-total" class="text-primary">0</span></h5>
                        <div id="comment-list" class="mb-4"></div>
                        <div class="input-group shadow-sm">
                            <input id="commInput" class="form-control border-0 p-3" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•´ ë³´ì„¸ìš”...">
                            <button class="btn btn-primary px-4" onclick="addComment()">ë“±ë¡</button>
                        </div>
                    </div>
                </div>

                <div id="page-noti" class="page-content" style="display:none">
                    <h4 class="fw-bold mb-4">ğŸ”” ì•Œë¦¼ ì„¼í„°</h4>
                    <div id="noti-list"></div>
                </div>

                <div id="page-inquiry" class="page-content" style="display:none">
                    <div class="card p-4 mb-4">
                        <h4 class="fw-bold">ğŸ’¬ 1:1 ë¬¸ì˜í•˜ê¸°</h4>
                        <p class="text-muted small mb-3">ê´€ë¦¬ìê°€ í™•ì¸ í›„ ë¹ ë¥¸ ì‹œì¼ ë‚´ì— ë‹µë³€ ë“œë¦½ë‹ˆë‹¤.</p>
                        <textarea id="inqInput" class="form-control mb-3 border-0 shadow-sm" style="background: #f8fafc;" rows="3" placeholder="ê¶ê¸ˆí•œ ë‚´ìš©ì„ ë‚¨ê²¨ì£¼ì„¸ìš”."></textarea>
                        <button class="btn btn-dark w-100" onclick="sendInquiry()">ë¬¸ì˜ ì ‘ìˆ˜</button>
                    </div>
                    <h5 class="fw-bold mb-3">ë‚´ ë¬¸ì˜ ë‚´ì—­</h5>
                    <div id="my-inq-list"></div>
                </div>

                <div id="page-auth" class="page-content" style="display:none">
                    <div class="card p-4 mx-auto" style="max-width: 450px;">
                        <div class="text-center mb-4">
                            <h3 class="fw-bold">ë°˜ê°€ì›Œìš”! ğŸ‘‹</h3>
                            <p class="text-muted">ì½”ë”© ë§ˆìŠ¤í„° ì»¤ë®¤ë‹ˆí‹°ì— ë¡œê·¸ì¸í•˜ì„¸ìš”</p>
                        </div>
                        <div class="mb-3">
                            <label class="form-label small fw-bold">ì´ë©”ì¼ ì£¼ì†Œ</label>
                            <input id="authEmail" class="form-control p-2" placeholder="name@example.com">
                        </div>
                        <div class="mb-4">
                            <label class="form-label small fw-bold">ë¹„ë°€ë²ˆí˜¸</label>
                            <input id="authPassword" type="password" class="form-control p-2" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                        </div>
                        <button class="btn btn-primary w-100 mb-3 fw-bold" onclick="handleLogin()">ë¡œê·¸ì¸</button>
                        <button class="btn btn-outline-secondary w-100 border-0 shadow-sm" onclick="handleSignUp()">ì´ë©”ì¼ë¡œ íšŒì›ê°€ì…</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 1. Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyBcxvsiEOyL1lZGVr1UE2gzzZ7HQX5YfbI",
            authDomain: "code-78890.firebaseapp.com",
            projectId: "code-78890",
            storageBucket: "code-78890.appspot.com",
            messagingSenderId: "33834164177",
            appId: "1:33834164177:web:866380c541434386266f81"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // 2. Global State
        let state = {
            user: null,
            posts: [],
            viewingId: null
        };

        // 3. UI logic
        function showPage(pageId) {
            window.scrollTo(0, 0);
            document.querySelectorAll('.page-content').forEach(p => p.style.display = 'none');
            document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
            
            document.getElementById('page-' + pageId).style.display = 'block';
            const menuBtn = document.getElementById('menu-' + pageId);
            if(menuBtn) menuBtn.classList.add('active');

            if(pageId === 'inquiry' && state.user) loadMyInquiries();
        }

        // 4. Authentication
        auth.onAuthStateChanged(user => {
            const authZone = document.getElementById('auth-zone');
            if (user) {
                state.user = { uid: user.uid, id: user.email.split('@')[0] };
                authZone.innerHTML = `
                    <div class="dropdown d-inline">
                        <span class="me-2 fw-bold text-dark">${state.user.id}ë‹˜</span>
                        <button class="btn btn-sm btn-outline-danger border-0" onclick="auth.signOut()">ë¡œê·¸ì•„ì›ƒ</button>
                    </div>
                `;
                loadNotis();
            } else {
                state.user = null;
                authZone.innerHTML = `<button class="btn btn-sm btn-primary fw-bold" onclick="showPage('auth')">ë¡œê·¸ì¸</button>`;
            }
        });

        async function handleSignUp() {
            const email = document.getElementById('authEmail').value;
            const pw = document.getElementById('authPassword').value;
            if(!email || !pw) return alert("ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            try {
                await auth.createUserWithEmailAndPassword(email, pw);
                alert("ê°€ì…ì„ ì¶•í•˜í•©ë‹ˆë‹¤!");
                showPage('home');
            } catch(e) { alert(e.message); }
        }

        async function handleLogin() {
            const email = document.getElementById('authEmail').value;
            const pw = document.getElementById('authPassword').value;
            try {
                await auth.signInWithEmailAndPassword(email, pw);
                showPage('home');
            } catch(e) { alert("ë¡œê·¸ì¸ ì •ë³´ë¥¼ í™•ì¸í•˜ì„¸ìš”."); }
        }

        // 5. Post CRUD
        function loadData() {
            db.collection("posts").orderBy("date", "asc").onSnapshot(snap => {
                state.posts = snap.docs.map(d => ({ fId: d.id, ...d.data() }));
                renderPosts();
                // ìƒì„¸í˜ì´ì§€ ë³´ê³  ìˆì„ ê²½ìš° ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸
                if(state.viewingId) renderDetail();
            });
        }

        function renderPosts() {
            const list = document.getElementById('post-list');
            if(state.posts.length === 0) {
                list.innerHTML = '<div class="empty-state">ì²« ë²ˆì§¸ ê²Œì‹œê¸€ì˜ ì£¼ì¸ê³µì´ ë˜ì–´ë³´ì„¸ìš”!</div>';
                return;
            }
            list.innerHTML = state.posts.map(p => `
                <div class="col-md-6">
                    <div class="card h-100 p-4 post-card shadow-sm border-0" onclick="viewPost('${p.fId}')" style="cursor:pointer">
                        <div class="mb-2"><span class="badge bg-soft-primary text-primary" style="background:#eef2ff">Tech</span></div>
                        <h5 class="fw-bold mb-2 text-truncate">${p.title}</h5>
                        <p class="text-muted small text-truncate-2 mb-3" style="display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; height: 3rem;">
                            ${p.content}
                        </p>
                        <div class="d-flex justify-content-between align-items-center mt-auto pt-3 border-top">
                            <div class="small fw-bold text-secondary">ğŸ‘¤ ${p.authorId}</div>
                            <div class="text-danger small fw-bold">â¤ï¸ ${p.likes || 0}</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function uploadPost() {
            if(!state.user) return alert("ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.");
            const title = document.getElementById('postTitle').value;
            const content = document.getElementById('postContent').value;
            if(!title || !content) return alert("ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");

            await db.collection("posts").add({
                title, content,
                authorId: state.user.id,
                authorUid: state.user.uid,
                date: Date.now(),
                likes: 0,
                likedBy: []
            });
            document.getElementById('postTitle').value = '';
            document.getElementById('postContent').value = '';
            showPage('home');
        }

        function viewPost(id) {
            state.viewingId = id;
            renderDetail();
            loadComments(id);
            showPage('view');
        }

        function renderDetail() {
            const p = state.posts.find(x => x.fId === state.viewingId);
            if(!p) return;
            const isLiked = p.likedBy?.includes(state.user?.uid);
            
            document.getElementById('post-detail').innerHTML = `
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <h2 class="fw-bold m-0">${p.title}</h2>
                    ${p.authorUid === state.user?.uid ? `<button class="btn btn-sm btn-outline-secondary border-0" onclick="deletePost('${p.fId}')">ì‚­ì œ</button>` : ''}
                </div>
                <div class="d-flex align-items-center mb-4 text-muted small">
                    <span class="badge bg-dark me-2">ì‘ì„±ì</span> <b>${p.authorId}</b>
                    <span class="mx-2">|</span>
                    <span>${new Date(p.date).toLocaleString()}</span>
                </div>
                <div class="bg-white rounded mb-4" style="font-size: 1.1rem; line-height: 1.8;">
                    ${p.content.replace(/\n/g, '<br>')}
                </div>
                <button class="btn ${isLiked ? 'btn-danger' : 'btn-outline-danger'} px-4 py-2 fw-bold" onclick="handleLike()">
                    â¤ï¸ ì¢‹ì•„ìš” ${p.likes || 0}
                </button>
            `;
        }

        async function deletePost(id) {
            if(confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                await db.collection("posts").doc(id).delete();
                showPage('home');
            }
        }

        // 6. Interaction Logic
        async function handleLike() {
            if(!state.user) return alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
            const p = state.posts.find(x => x.fId === state.viewingId);
            const ref = db.collection("posts").doc(state.viewingId);
            
            if(p.likedBy?.includes(state.user.uid)) {
                await ref.update({ 
                    likes: firebase.firestore.FieldValue.increment(-1), 
                    likedBy: firebase.firestore.FieldValue.arrayRemove(state.user.uid) 
                });
            } else {
                await ref.update({ 
                    likes: firebase.firestore.FieldValue.increment(1), 
                    likedBy: firebase.firestore.FieldValue.arrayUnion(state.user.uid) 
                });
                if(p.authorUid && p.authorUid !== state.user.uid) {
                    sendNoti(p.authorUid, `ğŸ‘‹ ë‚´ ê¸€ '${p.title}'ì— ìƒˆë¡œìš´ ì‘ì›ì´ ë„ì°©í–ˆìŠµë‹ˆë‹¤!`);
                }
            }
        }

        async function addComment() {
            const val = document.getElementById('commInput').value;
            if(!val || !state.user) return alert("ë¡œê·¸ì¸ ë° ëŒ“ê¸€ ë‚´ìš©ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.");
            const p = state.posts.find(x => x.fId === state.viewingId);

            await db.collection("comments").add({
                postId: state.viewingId,
                author: state.user.id,
                authorUid: state.user.uid,
                text: val,
                date: Date.now()
            });
            document.getElementById('commInput').value = '';
            if(p.authorUid && p.authorUid !== state.user.uid) {
                sendNoti(p.authorUid, `ğŸ’¬ '${p.title}' ê¸€ì— ìƒˆë¡œìš´ ëŒ“ê¸€ì´ ë‹¬ë ¸ìŠµë‹ˆë‹¤.`);
            }
        }

        function loadComments(postId) {
            db.collection("comments").where("postId", "==", postId).orderBy("date", "asc").onSnapshot(snap => {
                document.getElementById('comment-total').innerText = snap.size;
                document.getElementById('comment-list').innerHTML = snap.docs.map(d => `
                    <div class="comment-item">
                        <div class="d-flex justify-content-between mb-1">
                            <span class="fw-bold small text-primary">${d.data().author}</span>
                            <span class="text-muted" style="font-size:0.75rem">${new Date(d.data().date).toLocaleDateString()}</span>
                        </div>
                        <div class="text-dark">${d.data().text}</div>
                    </div>
                `).join('');
                if(snap.empty) document.getElementById('comment-list').innerHTML = '<p class="text-muted small">ì²« ëŒ“ê¸€ì„ ë‚¨ê²¨ë³´ì„¸ìš”!</p>';
            });
        }

        // 7. Notification & Inquiry
        async function sendNoti(toUid, msg) {
            if(!toUid) return;
            await db.collection("notis").add({
                to: toUid, msg: msg, read: false, date: Date.now()
            });
        }

        function loadNotis() {
            if(!state.user) return;
            db.collection("notis").where("to", "==", state.user.uid).orderBy("date", "desc").onSnapshot(snap => {
                const unread = snap.docs.filter(d => !d.data().read).length;
                const badge = document.getElementById('noti-count');
                badge.innerText = unread;
                badge.style.display = unread > 0 ? 'block' : 'none';

                document.getElementById('noti-list').innerHTML = snap.docs.map(d => `
                    <div class="card p-3 mb-2 ${d.data().read ? 'opacity-50' : 'border-primary shadow-sm'}" onclick="markRead('${d.id}')" style="cursor:pointer">
                        <div class="d-flex align-items-center">
                            <div class="me-3">${d.data().read ? 'âœ”ï¸' : 'âœ‰ï¸'}</div>
                            <div>${d.data().msg}</div>
                        </div>
                    </div>
                `).join('');
                if(snap.empty) document.getElementById('noti-list').innerHTML = '<div class="empty-state">ë„ì°©í•œ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
            });
        }

        async function markRead(id) {
            await db.collection("notis").doc(id).update({ read: true });
        }

        async function sendInquiry() {
            const txt = document.getElementById('inqInput').value;
            if(!txt || !state.user) return alert("ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.");
            await db.collection("inquiries").add({
                userUid: state.user.uid,
                userId: state.user.id,
                content: txt,
                answer: null,
                date: Date.now()
            });
            alert("ì†Œì¤‘í•œ ì˜ê²¬ì´ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.");
            document.getElementById('inqInput').value = '';
        }

        function loadMyInquiries() {
            db.collection("inquiries").where("userUid", "==", state.user.uid).orderBy("date", "desc").onSnapshot(snap => {
                document.getElementById('my-inq-list').innerHTML = snap.docs.map(d => `
                    <div class="card p-3 mb-2 border-0 shadow-sm">
                        <div class="fw-bold mb-2">Q: ${d.data().content}</div>
                        ${d.data().answer ? `<div class="p-2 rounded bg-light text-primary">A: ${d.data().answer}</div>` : '<div class="badge bg-light text-muted w-25">ë‹µë³€ ëŒ€ê¸° ì¤‘</div>'}
                    </div>
                `).join('');
                if(snap.empty) document.getElementById('my-inq-list').innerHTML = '<p class="text-muted small">ë¬¸ì˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            });
        }

        // ì´ˆê¸° ì‹¤í–‰
        loadData();
    </script>
</body>
</html>

