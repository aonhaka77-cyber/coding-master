<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì½”ë”© ë§ˆìŠ¤í„° - ë²„ê·¸ ìˆ˜ì • ì™„ë£ŒíŒ</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        :root { --primary: #667eea; --secondary: #764ba2; --bg: #f8f9fa; --text: #222; --danger: #e74c3c; --accent: #f39c12; --card-bg: #ffffff; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Pretendard', sans-serif; background: var(--bg); color: var(--text); line-height: 1.6; }
        
        header { background: white; border-bottom: 1px solid #e5e5e5; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .header-top { max-width: 1200px; margin: 0 auto; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; gap: 15px; }
        .logo { font-size: 22px; font-weight: 900; color: var(--primary); cursor: pointer; }
        .search-bar { flex: 1; max-width: 400px; }
        .search-bar input { width: 100%; padding: 10px 18px; border-radius: 25px; border: 1px solid #ddd; background: #f1f3f5; outline: none; }

        .nav-menu { max-width: 1200px; margin: 0 auto; padding: 0 20px; display: flex; gap: 20px; }
        .nav-item { padding: 15px 5px; cursor: pointer; font-size: 14px; font-weight: 700; color: #777; border-bottom: 3px solid transparent; }
        .nav-item.active { color: var(--primary); border-bottom-color: var(--primary); }

        .main-container { max-width: 1200px; margin: 25px auto; padding: 0 20px; display: grid; grid-template-columns: 1fr 320px; gap: 25px; }
        @media (max-width: 950px) { .main-container { grid-template-columns: 1fr; } }

        .page { display: none; }
        .page.active { display: block; }
        .card { background: var(--card-bg); border-radius: 16px; padding: 25px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 25px; }
        
        .ad-banner { background: linear-gradient(135deg, #222, #444); color: white; border-radius: 16px; padding: 30px; margin-bottom: 25px; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 700; transition: 0.2s; }
        .btn-p { background: var(--primary); color: white; }
        .btn-s { background: #eee; color: #444; }

        .item-row { padding: 12px; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; cursor: pointer; }
        .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:2000; align-items:center; justify-content:center; }
        .modal.active { display: flex; }
        .modal-content { background:white; padding:30px; border-radius:20px; width:90%; max-width:500px; }
        input, textarea { width:100%; padding:10px; margin-top:10px; border:1px solid #ddd; border-radius:8px; }
    </style>
</head>
<body>

<header>
    <div class="header-top">
        <div class="logo" onclick="goHome()">ğŸš€ CODING MASTER</div>
        <div class="search-bar">
            <input type="text" id="globalSearch" placeholder="ê²€ìƒ‰ í›„ ì—”í„°ë¥¼ ëˆ„ë¥´ì„¸ìš”" onkeypress="handleSearch(event)">
        </div>
        <div id="authArea">
            <button class="btn btn-s" onclick="openModal('loginModal')">ë¡œê·¸ì¸</button>
            <button class="btn btn-p" onclick="openModal('joinModal')">íšŒì›ê°€ì…</button>
        </div>
        <div id="userArea" style="display:none; align-items:center; gap:10px;">
            <span id="welcomeMsg" style="font-weight:bold; color:var(--primary);"></span>
            <button class="btn btn-s" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
    </div>
    <nav class="nav-menu">
        <div class="nav-item active" id="menu-home" onclick="goHome()">í™ˆ</div>
        <div class="nav-item" id="menu-notice" onclick="showBoard('notice')">ê³µì§€ì‚¬í•­</div>
        <div class="nav-item" id="menu-free" onclick="showBoard('free')">ììœ ê²Œì‹œíŒ</div>
        <div class="nav-item" id="menu-admin" onclick="showPage('admin')" style="display:none; color:var(--danger)">ğŸ‘‘ ê´€ë¦¬</div>
    </nav>
</header>

<div class="main-container">
    <div class="content-left">
        <div id="page-home" class="page active">
            <div id="ad-container" class="ad-banner">
                <h3>í™˜ì˜í•©ë‹ˆë‹¤!</h3>
                <p>ë¡œë”© ì¤‘...</p>
            </div>
            <div class="card">
                <h3>ğŸ†• ìµœì‹  ê²Œì‹œê¸€</h3>
                <div id="home-posts" style="margin-top:15px;"></div>
            </div>
        </div>

        <div id="page-board" class="page">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                <h2 id="board-title">ê²Œì‹œíŒ</h2>
                <button class="btn btn-p" onclick="openWriteModal()">ê¸€ì“°ê¸°</button>
            </div>
            <div id="post-list" class="card"></div>
        </div>

        <div id="page-detail" class="page">
            <div class="card">
                <div id="post-header"></div>
                <hr style="margin:15px 0; border:0; border-top:1px solid #eee;">
                <div id="post-body"></div>
                <div id="admin-tools" style="display:none; margin-top:20px;">
                    <button class="btn btn-s" onclick="deletePost()" style="background:var(--danger); color:white;">ì‚­ì œ</button>
                </div>
            </div>
            <button class="btn btn-s" onclick="goBackList()">ëª©ë¡ìœ¼ë¡œ</button>
        </div>
    </div>

    <div class="sidebar">
        <div class="card">
            <h4>ğŸ“Š í†µê³„</h4>
            <div style="margin-top:10px;">
                <p>ê²Œì‹œê¸€: <b id="stat-posts">0</b></p>
                <p>íšŒì›ìˆ˜: <b id="stat-users">0</b></p>
            </div>
        </div>
    </div>
</div>

<div class="modal" id="loginModal">
    <div class="modal-content">
        <h2>ë¡œê·¸ì¸</h2>
        <input type="text" id="loginId" placeholder="ì•„ì´ë””">
        <input type="password" id="loginPw" placeholder="ë¹„ë°€ë²ˆí˜¸">
        <button class="btn btn-p" style="width:100%; margin-top:15px;" onclick="handleLogin()">ë¡œê·¸ì¸</button>
        <button class="btn btn-s" style="width:100%; margin-top:10px;" onclick="closeModal('loginModal')">ë‹«ê¸°</button>
    </div>
</div>

<div class="modal" id="joinModal">
    <div class="modal-content">
        <h2>íšŒì›ê°€ì…</h2>
        <input type="text" id="joinId" placeholder="ì•„ì´ë””">
        <input type="password" id="joinPw" placeholder="ë¹„ë°€ë²ˆí˜¸">
        <button class="btn btn-p" style="width:100%; margin-top:15px;" onclick="handleJoin()">ê°€ì…ì™„ë£Œ</button>
        <button class="btn btn-s" style="width:100%; margin-top:10px;" onclick="closeModal('joinModal')">ì·¨ì†Œ</button>
    </div>
</div>

<div class="modal" id="writeModal">
    <div class="modal-content">
        <h2>ê¸€ ì‘ì„±</h2>
        <input type="text" id="writeTitle" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”">
        <textarea id="writeContent" rows="8" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
        <input type="file" id="fileInput" onchange="handleFilePreview()" style="border:none;">
        <img id="writeImgPreview" style="display:none; max-width:100%; margin-top:10px; border-radius:10px;">
        <button class="btn btn-p" style="width:100%; margin-top:15px;" onclick="handleSavePost()">ì‘ì„± ì™„ë£Œ</button>
        <button class="btn btn-s" style="width:100%; margin-top:10px;" onclick="closeModal('writeModal')">ì·¨ì†Œ</button>
    </div>
</div>

<script>
    // 1. Firebase ì„¤ì • (ìœ ì§€)
    const firebaseConfig = {
        apiKey: "AIzaSyBcxvsiEOyL1lZGVr1UE2gzzZ7HQX5YfbI",
        authDomain: "code-78890.firebaseapp.com",
        projectId: "code-78890",
        storageBucket: "code-78890.firebasestorage.app",
        messagingSenderId: "30317586652",
        appId: "1:30317586652:web:d1e6fa39c319029fb7ac19"
    };
    firebase.initializeApp(firebaseConfig);
    const fdb = firebase.firestore();

    let db = {
        users: [], posts: [], 
        currentBoard: 'free', currentUser: null,
        viewingPostId: null, tempImg: null
    };

    // 2. ì´ˆê¸°í™” (ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ)
    function init() {
        // ìœ ì € ê°ì‹œ
        fdb.collection("users").onSnapshot(s => {
            db.users = s.docs.map(d => ({fId: d.id, ...d.data()}));
            document.getElementById('stat-users').innerText = db.users.length;
        });

        // ê²Œì‹œê¸€ ê°ì‹œ
        fdb.collection("posts").orderBy("id", "desc").onSnapshot(s => {
            db.posts = s.docs.map(d => ({fId: d.id, ...d.data()}));
            renderHome();
            renderPostList();
            document.getElementById('stat-posts').innerText = db.posts.length;
        });

        // ê´‘ê³  ê°ì‹œ (ê°„ë‹¨íˆ í•˜ë‚˜ë§Œ ê°€ì ¸ì˜´)
        fdb.collection("ads").limit(1).onSnapshot(s => {
            if(!s.empty) {
                const ad = s.docs[0].data();
                document.getElementById('ad-container').innerHTML = `<h3>${ad.title}</h3><p>${ad.text}</p>`;
            }
        });
    }

    // 3. í˜ì´ì§€ ì „í™˜ ë° ë Œë”ë§
    function showPage(pageId) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById('page-' + pageId).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    }

    function goHome() { 
        showPage('home'); 
        document.getElementById('menu-home').classList.add('active');
    }

    function showBoard(boardId) {
        db.currentBoard = boardId;
        showPage('board');
        document.getElementById('menu-' + boardId).classList.add('active');
        document.getElementById('board-title').innerText = boardId === 'notice' ? 'ğŸ“¢ ê³µì§€ì‚¬í•­' : 'ğŸ’¬ ììœ ê²Œì‹œíŒ';
        renderPostList();
    }

    function renderHome() {
        const recent = db.posts.slice(0, 5);
        document.getElementById('home-posts').innerHTML = recent.map(p => `
            <div class="item-row" onclick="viewPost(${p.id})">
                <span>${p.title}</span>
                <small style="color:#aaa;">${p.author}</small>
            </div>
        `).join('') || 'ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.';
    }

    function renderPostList() {
        const filtered = db.posts.filter(p => p.board === db.currentBoard);
        document.getElementById('post-list').innerHTML = filtered.map(p => `
            <div class="item-row" onclick="viewPost(${p.id})">
                <div><b>${p.title}</b><br><small>${p.author} | ${p.date}</small></div>
                <div style="color:var(--primary)">ğŸ‘ï¸ ${p.views || 0}</div>
            </div>
        `).join('') || '<p style="padding:20px; text-align:center;">ì‘ì„±ëœ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
    }

    // 4. ê¸°ëŠ¥ ë¡œì§ (ë¡œê·¸ì¸, ê¸€ì“°ê¸° ë“±)
    function handleLogin() {
        const id = document.getElementById('loginId').value;
        const pw = document.getElementById('loginPw').value;
        const user = db.users.find(u => u.id === id && u.pw === pw);

        if (user) {
            db.currentUser = user;
            updateAuthUI();
            closeModal('loginModal');
            alert(user.id + 'ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤!');
        } else {
            alert('ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë¦½ë‹ˆë‹¤.');
        }
    }

    function handleJoin() {
        const id = document.getElementById('joinId').value;
        const pw = document.getElementById('joinPw').value;
        if(!id || !pw) return alert('ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.');
        if(db.users.find(u => u.id === id)) return alert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì•„ì´ë””ì…ë‹ˆë‹¤.');

        fdb.collection("users").add({ id, pw, role: 'member' })
            .then(() => { alert('ê°€ì… ì™„ë£Œ! ë¡œê·¸ì¸ í•´ì£¼ì„¸ìš”.'); closeModal('joinModal'); });
    }

    function updateAuthUI() {
        if(db.currentUser) {
            document.getElementById('authArea').style.display = 'none';
            document.getElementById('userArea').style.display = 'flex';
            document.getElementById('welcomeMsg').innerText = db.currentUser.id + 'ë‹˜';
            if(db.currentUser.role === 'owner') document.getElementById('menu-admin').style.display = 'block';
        } else {
            document.getElementById('authArea').style.display = 'flex';
            document.getElementById('userArea').style.display = 'none';
            document.getElementById('menu-admin').style.display = 'none';
        }
    }

    function logout() {
        db.currentUser = null;
        updateAuthUI();
        goHome();
    }

    function openWriteModal() {
        if(!db.currentUser) return alert('ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.');
        openModal('writeModal');
    }

    function handleSavePost() {
        const title = document.getElementById('writeTitle').value;
        const content = document.getElementById('writeContent').value;
        if(!title || !content) return alert('ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.');

        const newPost = {
            id: Date.now(),
            board: db.currentBoard,
            title: title,
            content: content,
            author: db.currentUser.id,
            date: new Date().toLocaleDateString(),
            views: 0,
            file: db.tempImg
        };

        fdb.collection("posts").add(newPost).then(() => {
            closeModal('writeModal');
            // ì…ë ¥ì°½ ì´ˆê¸°í™”
            document.getElementById('writeTitle').value = '';
            document.getElementById('writeContent').value = '';
            document.getElementById('writeImgPreview').style.display = 'none';
            db.tempImg = null;
        });
    }

    function viewPost(id) {
        const post = db.posts.find(p => p.id === id);
        if(!post) return;
        db.viewingPostId = id;
        showPage('detail');
        
        document.getElementById('post-header').innerHTML = `<h2>${post.title}</h2><small>${post.author} | ${post.date}</small>`;
        let contentHtml = `<p>${post.content.replace(/\n/g, '<br>')}</p>`;
        if(post.file) contentHtml += `<img src="${post.file}" style="max-width:100%; margin-top:20px; border-radius:10px;">`;
        document.getElementById('post-body').innerHTML = contentHtml;

        // ì¡°íšŒìˆ˜ ì¦ê°€
        fdb.collection("posts").doc(post.fId).update({ views: (post.views || 0) + 1 });
        
        // ê´€ë¦¬ì ë„êµ¬
        const isAdmin = db.currentUser && (db.currentUser.role === 'owner' || db.currentUser.id === post.author);
        document.getElementById('admin-tools').style.display = isAdmin ? 'block' : 'none';
    }

    function deletePost() {
        if(!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        const post = db.posts.find(p => p.id === db.viewingPostId);
        fdb.collection("posts").doc(post.fId).delete().then(() => goBackList());
    }

    function handleSearch(e) {
        if(e.key === 'Enter') {
            const query = e.target.value.toLowerCase();
            const results = db.posts.filter(p => p.title.toLowerCase().includes(query));
            db.currentBoard = 'search';
            showPage('board');
            document.getElementById('board-title').innerText = 'ğŸ” ê²€ìƒ‰ ê²°ê³¼';
            document.getElementById('post-list').innerHTML = results.map(p => `
                <div class="item-row" onclick="viewPost(${p.id})">
                    <span>${p.title}</span><small>${p.author}</small>
                </div>
            `).join('') || 'ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.';
        }
    }

    // ìœ í‹¸ë¦¬í‹°
    function openModal(id) { document.getElementById(id).classList.add('active'); }
    function closeModal(id) { document.getElementById(id).classList.remove('active'); }
    function goBackList() { showBoard(db.currentBoard); }
    function handleFilePreview() {
        const file = document.getElementById('fileInput').files[0];
        const reader = new FileReader();
        reader.onloadend = () => {
            db.tempImg = reader.result;
            document.getElementById('writeImgPreview').src = reader.result;
            document.getElementById('writeImgPreview').style.display = 'block';
        };
        if(file) reader.readAsDataURL(file);
    }

    window.onload = init;
</script>
</body>
</html>
