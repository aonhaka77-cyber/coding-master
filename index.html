<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coding Master - Community</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root { --primary: #6366f1; --bg: #f8fafc; }
        body { background: var(--bg); font-family: 'Pretendard', sans-serif; }
        .navbar { background: white; border-bottom: 1px solid #e2e8f0; sticky-top; }
        .card { border: none; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); transition: 0.2s; }
        .card:hover { transform: translateY(-2px); }
        .nav-link { cursor: pointer; font-weight: 500; color: #64748b; }
        .nav-link.active { color: var(--primary); border-bottom: 2px solid var(--primary); }
        .btn-primary { background: var(--primary); border: none; }
        .noti-badge { position: absolute; top: 0; right: 0; transform: translate(50%, -50%); }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg sticky-top mb-4">
        <div class="container">
            <a class="navbar-brand fw-bold text-primary" onclick="showPage('home')">Coding Master</a>
            <div class="d-flex align-items-center">
                <div id="auth-zone" class="me-3">
                    </div>
                <div class="position-relative me-3" onclick="showPage('noti')" style="cursor:pointer">
                    ğŸ”” <span id="noti-count" class="badge rounded-pill bg-danger noti-badge" style="display:none">0</span>
                </div>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="row">
            <div class="col-md-3 mb-4">
                <div class="list-group shadow-sm">
                    <a class="list-group-item list-group-item-action border-0" onclick="showPage('home')">ğŸ  ì „ì²´ ê²Œì‹œê¸€</a>
                    <a class="list-group-item list-group-item-action border-0" onclick="showPage('write')">âœï¸ ê¸€ì“°ê¸°</a>
                    <a class="list-group-item list-group-item-action border-0" onclick="showPage('inquiry')">ğŸ’¬ 1:1 ë¬¸ì˜</a>
                </div>
            </div>

            <div class="col-md-9">
                <div id="page-home" class="page-content">
                    <div id="post-list" class="row g-4">
                        </div>
                </div>

                <div id="page-write" class="page-content" style="display:none">
                    <div class="card p-4">
                        <h4 class="mb-4">ìƒˆ ê¸€ ì‘ì„±</h4>
                        <input id="postTitle" class="form-control mb-3" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”">
                        <textarea id="postContent" class="form-control mb-3" rows="10" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                        <button class="btn btn-primary w-100" onclick="uploadPost()">ê²Œì‹œí•˜ê¸°</button>
                    </div>
                </div>

                <div id="page-view" class="page-content" style="display:none">
                    <div id="post-detail" class="mb-4"></div>
                    <hr>
                    <h5>ëŒ“ê¸€</h5>
                    <div id="comment-list" class="mb-3"></div>
                    <div class="input-group">
                        <input id="commInput" class="form-control" placeholder="ëŒ“ê¸€ì„ ë‚¨ê²¨ë³´ì„¸ìš”">
                        <button class="btn btn-outline-primary" onclick="addComment()">ë“±ë¡</button>
                    </div>
                </div>

                <div id="page-noti" class="page-content" style="display:none">
                    <h4 class="mb-4">ìµœê·¼ ì•Œë¦¼</h4>
                    <div id="noti-list"></div>
                </div>

                <div id="page-inquiry" class="page-content" style="display:none">
                    <div class="card p-4 mb-4">
                        <h4>1:1 ë¬¸ì˜í•˜ê¸°</h4>
                        <textarea id="inqInput" class="form-control mb-2" placeholder="ê¶ê¸ˆí•œ ì ì„ ë‚¨ê²¨ì£¼ì„¸ìš”."></textarea>
                        <button class="btn btn-dark" onclick="sendInquiry()">ë¬¸ì˜ ì œì¶œ</button>
                    </div>
                    <h5>ë‚´ ë¬¸ì˜ ë‚´ì—­</h5>
                    <div id="my-inq-list"></div>
                </div>

                <div id="page-auth" class="page-content" style="display:none">
                    <div class="card p-4 mx-auto" style="max-width: 400px;">
                        <h4 id="auth-title">ë¡œê·¸ì¸</h4>
                        <input id="authEmail" class="form-control mb-2" placeholder="ì´ë©”ì¼">
                        <input id="authPassword" type="password" class="form-control mb-3" placeholder="ë¹„ë°€ë²ˆí˜¸">
                        <div id="auth-btns">
                            <button class="btn btn-primary w-100 mb-2" onclick="handleLogin()">ë¡œê·¸ì¸</button>
                            <button class="btn btn-outline-secondary w-100" onclick="handleSignUp()">íšŒì›ê°€ì…</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 1. Firebase ì„¤ì • (ë³¸ì¸ì˜ ê°’ìœ¼ë¡œ êµì²´í•˜ì„¸ìš”)
        const firebaseConfig = {
            apiKey: "AIzaSyBcxvsiEOyL1lZGVr1UE2gzzZ7HQX5YfbI",
            authDomain: "code-78890.firebaseapp.com",
            projectId: "code-78890",
            storageBucket: "code-78890.appspot.com",
            messagingSenderId: "33834164177",
            appId: "1:33834164177:web:866380c541434386266f81"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // 2. ìƒíƒœ ê´€ë¦¬
        let state = {
            user: null,
            posts: [],
            viewingId: null
        };

        // 3. í˜ì´ì§€ ì „í™˜
        function showPage(pageId) {
            document.querySelectorAll('.page-content').forEach(p => p.style.display = 'none');
            document.getElementById('page-' + pageId).style.display = 'block';
            if(pageId === 'inquiry' && state.user) loadMyInquiries();
        }

        // 4. ì¸ì¦ ë¡œì§
        auth.onAuthStateChanged(user => {
            if (user) {
                state.user = { uid: user.uid, id: user.email.split('@')[0] };
                document.getElementById('auth-zone').innerHTML = `
                    <span class="me-2 fw-bold">${state.user.id}ë‹˜</span>
                    <button class="btn btn-sm btn-light" onclick="auth.signOut()">ë¡œê·¸ì•„ì›ƒ</button>
                `;
                loadNotis();
                loadMyInquiries();
            } else {
                state.user = null;
                document.getElementById('auth-zone').innerHTML = `
                    <button class="btn btn-sm btn-primary" onclick="showPage('auth')">ë¡œê·¸ì¸</button>
                `;
            }
        });

        async function handleSignUp() {
            const email = document.getElementById('authEmail').value;
            const pw = document.getElementById('authPassword').value;
            try {
                await auth.createUserWithEmailAndPassword(email, pw);
                alert("íšŒì›ê°€ì… ì„±ê³µ!");
                showPage('home');
            } catch(e) { alert(e.message); }
        }

        async function handleLogin() {
            const email = document.getElementById('authEmail').value;
            const pw = document.getElementById('authPassword').value;
            try {
                await auth.signInWithEmailAndPassword(email, pw);
                showPage('home');
            } catch(e) { alert("ë¡œê·¸ì¸ ì‹¤íŒ¨: " + e.message); }
        }

        // 5. ê²Œì‹œê¸€ ë¡œì§
        function loadData() {
            db.collection("posts").orderBy("date", "desc").onSnapshot(snap => {
                state.posts = snap.docs.map(d => ({ fId: d.id, ...d.data() }));
                renderPosts();
            });
        }

        function renderPosts() {
            document.getElementById('post-list').innerHTML = state.posts.map(p => `
                <div class="col-md-6">
                    <div class="card h-100 p-3" onclick="viewPost('${p.fId}')" style="cursor:pointer">
                        <h5 class="fw-bold">${p.title}</h5>
                        <p class="text-muted text-truncate">${p.content}</p>
                        <div class="d-flex justify-content-between align-items-center mt-auto">
                            <span class="badge bg-light text-dark">ğŸ‘¤ ${p.authorId || 'ìµëª…'}</span>
                            <span class="text-primary">â¤ï¸ ${p.likes || 0}</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function uploadPost() {
            if(!state.user) return alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
            const title = document.getElementById('postTitle').value;
            const content = document.getElementById('postContent').value;
            if(!title || !content) return alert("ë‚´ìš©ì„ ì±„ì›Œì£¼ì„¸ìš”.");

            await db.collection("posts").add({
                title, content,
                authorId: state.user.id,
                authorUid: state.user.uid,
                date: Date.now(),
                likes: 0,
                likedBy: []
            });
            showPage('home');
        }

        function viewPost(id) {
            state.viewingId = id;
            const p = state.posts.find(x => x.fId === id);
            document.getElementById('post-detail').innerHTML = `
                <h2 class="fw-bold">${p.title}</h2>
                <p class="text-muted">ì‘ì„±ì: ${p.authorId} | ${new Date(p.date).toLocaleString()}</p>
                <div class="bg-white p-4 rounded shadow-sm mb-3" style="min-height:200px">${p.content.replace(/\n/g, '<br>')}</div>
                <button class="btn ${p.likedBy?.includes(state.user?.uid) ? 'btn-danger' : 'btn-outline-danger'}" onclick="handleLike()">
                    â¤ï¸ ì¢‹ì•„ìš” ${p.likes || 0}
                </button>
            `;
            loadComments(id);
            showPage('view');
        }

        // 6. ì¢‹ì•„ìš” & ì•Œë¦¼ ë¡œì§ (ì—ëŸ¬ ìˆ˜ì •ë¨)
        async function handleLike() {
            if(!state.user) return alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
            const p = state.posts.find(x => x.fId === state.viewingId);
            const ref = db.collection("posts").doc(state.viewingId);
            
            if(p.likedBy?.includes(state.user.uid)) {
                await ref.update({ 
                    likes: firebase.firestore.FieldValue.increment(-1), 
                    likedBy: firebase.firestore.FieldValue.arrayRemove(state.user.uid) 
                });
            } else {
                await ref.update({ 
                    likes: firebase.firestore.FieldValue.increment(1), 
                    likedBy: firebase.firestore.FieldValue.arrayUnion(state.user.uid) 
                });
                // ì˜›ë‚  ê¸€(authorUid ì—†ìŒ) ë°©ì–´ ì½”ë“œ
                if(p.authorUid && p.authorUid !== state.user.uid) {
                    sendNoti(p.authorUid, `ë‚´ ê¸€ '${p.title}'ì— ì¢‹ì•„ìš”ê°€ ë‹¬ë ¸ìŠµë‹ˆë‹¤!`);
                }
            }
            viewPost(state.viewingId);
        }

        async function addComment() {
            const val = document.getElementById('commInput').value;
            if(!val || !state.user) return alert("ë¡œê·¸ì¸ ë° ë‚´ìš©ì„ í™•ì¸í•˜ì„¸ìš”.");
            const p = state.posts.find(x => x.fId === state.viewingId);

            await db.collection("comments").add({
                postId: state.viewingId,
                author: state.user.id,
                authorUid: state.user.uid,
                text: val,
                date: Date.now()
            });
            document.getElementById('commInput').value = '';
            if(p.authorUid && p.authorUid !== state.user.uid) {
                sendNoti(p.authorUid, `'${p.title}' ê¸€ì— ìƒˆ ëŒ“ê¸€ì´ ë‹¬ë ¸ìŠµë‹ˆë‹¤.`);
            }
        }

        function loadComments(postId) {
            db.collection("comments").where("postId", "==", postId).orderBy("date", "asc").onSnapshot(snap => {
                document.getElementById('comment-list').innerHTML = snap.docs.map(d => `
                    <div class="p-2 border-bottom">
                        <b>${d.data().author}:</b> ${d.data().text}
                    </div>
                `).join('');
            });
        }

        // 7. ì•Œë¦¼ & ë¬¸ì˜ (ì—ëŸ¬ ìˆ˜ì •ë¨)
        async function sendNoti(toUid, msg) {
            if(!toUid) return;
            await db.collection("notis").add({
                to: toUid,
                msg: msg,
                read: false,
                date: Date.now()
            });
        }

        function loadNotis() {
            if(!state.user) return;
            db.collection("notis").where("to", "==", state.user.uid).orderBy("date", "desc").onSnapshot(snap => {
                const unread = snap.docs.filter(d => !d.data().read).length;
                const badge = document.getElementById('noti-count');
                badge.innerText = unread;
                badge.style.display = unread > 0 ? 'block' : 'none';

                document.getElementById('noti-list').innerHTML = snap.docs.map(d => `
                    <div class="card p-3 mb-2 ${d.data().read ? 'opacity-50' : 'border-primary'}" onclick="markRead('${d.id}')">
                        ${d.data().msg}
                    </div>
                `).join('');
            });
        }

        async function markRead(id) {
            await db.collection("notis").doc(id).update({ read: true });
        }

        async function sendInquiry() {
            const txt = document.getElementById('inqInput').value;
            if(!txt || !state.user) return alert("ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.");
            await db.collection("inquiries").add({
                userUid: state.user.uid,
                userId: state.user.id,
                content: txt,
                answer: null,
                date: Date.now()
            });
            alert("ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.");
            document.getElementById('inqInput').value = '';
        }

        function loadMyInquiries() {
            db.collection("inquiries").where("userUid", "==", state.user.uid).onSnapshot(snap => {
                document.getElementById('my-inq-list').innerHTML = snap.docs.map(d => `
                    <div class="card p-3 mb-2">
                        <b>Q: ${d.data().content}</b>
                        ${d.data().answer ? `<div class="mt-2 text-primary">A: ${d.data().answer}</div>` : '<div class="text-muted small">ë‹µë³€ ëŒ€ê¸° ì¤‘</div>'}
                    </div>
                `).join('');
            });
        }

        loadData();
    </script>
</body>
</html>
