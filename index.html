<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MASTER PIECE - INFINITY AUTH</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <style>
        :root { --primary: #4f46e5; --bg: #f8fafc; --card: #ffffff; --text: #1e293b; --danger: #ef4444; --warn: #f59e0b; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Pretendard', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: var(--text); line-height: 1.5; padding-bottom: 80px; }
        
        /* Layout */
        header { background: white; border-bottom: 1px solid #e2e8f0; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .h-wrap { max-width: 1200px; margin: 0 auto; padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; gap: 15px; }
        .logo { font-size: 22px; font-weight: 900; color: var(--primary); cursor: pointer; letter-spacing: -1px; }
        
        .search-bar { flex: 1; max-width: 500px; position: relative; }
        .search-bar input { width: 100%; padding: 10px 40px 10px 15px; border-radius: 20px; border: 1px solid #e2e8f0; background: #f1f5f9; outline: none; }
        
        .nav-bar { background: white; border-bottom: 1px solid #f1f5f9; }
        .nav-flex { max-width: 1200px; margin: 0 auto; display: flex; overflow-x: auto; scrollbar-width: none; }
        .nav-item { padding: 15px 20px; font-size: 14px; font-weight: 700; color: #64748b; cursor: pointer; white-space: nowrap; border-bottom: 3px solid transparent; transition: 0.2s; }
        .nav-item.active { color: var(--primary); border-bottom-color: var(--primary); }
        .nav-item:hover { background: #f8fafc; }

        .container { max-width: 1200px; margin: 20px auto; padding: 0 15px; display: grid; grid-template-columns: 1fr 300px; gap: 20px; }
        @media (max-width: 900px) { .container { grid-template-columns: 1fr; } .sidebar { display: none; } }

        /* Component */
        .card { background: white; border-radius: 16px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 20px; border: 1px solid #f1f5f9; }
        .btn { padding: 10px 18px; border-radius: 10px; border: none; font-weight: 700; cursor: pointer; display: inline-flex; align-items: center; gap: 5px; transition: 0.2s; }
        .btn-p { background: var(--primary); color: white; }
        .btn-p:hover { filter: brightness(1.1); }
        .btn-s { background: #f1f5f9; color: #475569; }
        .btn-danger { background: #fee2e2; color: var(--danger); }
        
        .list-item { padding: 15px; border-bottom: 1px solid #f8fafc; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: 0.1s; }
        .list-item:hover { background: #f8fafc; }
        
        .tag { padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 800; margin-right: 8px; }
        .tag-notice { background: #fee2e2; color: #b91c1c; }
        .tag-free { background: #e0e7ff; color: #4338ca; }
        
        .page { display: none; animation: fadeIn 0.3s ease; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Modal */
        .modal { display: none; position: fixed; inset: 0; background: rgba(15, 23, 42, 0.7); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(5px); padding: 15px; }
        .modal.active { display: flex; }
        .modal-content { background: white; border-radius: 20px; padding: 30px; width: 100%; max-width: 450px; position: relative; }
        input, textarea { width: 100%; padding: 12px; margin-top: 10px; border: 1px solid #e2e8f0; border-radius: 10px; outline: none; font-size: 15px; }
        
        /* Parser Style */
        .namu-area blockquote { border-left: 4px solid var(--primary); padding-left: 15px; color: #64748b; margin: 15px 0; font-style: italic; }
        .namu-area b { font-weight: 900; color: #000; }
        
        .badge { background: var(--danger); color: white; font-size: 10px; padding: 2px 6px; border-radius: 10px; position: absolute; top: -5px; right: -8px; border: 2px solid white; }
    </style>
</head>
<body>

<header>
    <div class="h-wrap">
        <div class="logo" onclick="goHome()">MASTER PIECE</div>
        <div class="search-bar">
            <input type="text" id="mainSearch" placeholder="ë¬´ì—‡ì„ ì°¾ìœ¼ì‹œë‚˜ìš”?" onkeyup="if(event.keyCode==13)execSearch()">
        </div>
        <div style="display:flex; gap:15px; align-items:center;">
            <div style="position:relative; cursor:pointer;" onclick="toggleNoti()">ğŸ””<span id="notiCount" class="badge" style="display:none;">0</span></div>
            <div id="authBtnArea"><button class="btn btn-p" onclick="openModal('authModal')">ë¡œê·¸ì¸</button></div>
            <div id="userInfoArea" style="display:none; cursor:pointer;" onclick="showPage('mypage')">
                <span id="userNickDisplay" style="font-weight:800; color:var(--primary);"></span>
            </div>
        </div>
    </div>
    <div class="nav-bar">
        <div class="nav-flex">
            <div class="nav-item active" id="m-home" onclick="goHome()">ë©”ì¸</div>
            <div class="nav-item" id="m-notice" onclick="showBoard('notice')">ê³µì§€ì‚¬í•­</div>
            <div class="nav-item" id="m-free" onclick="showBoard('free')">ììœ ê²Œì‹œíŒ</div>
            <div class="nav-item" id="m-qna" onclick="showBoard('qna')">Q&A</div>
            <div class="nav-item" id="m-inquiry" onclick="showPage('inquiry')">1:1ë¬¸ì˜</div>
            <div class="nav-item" id="m-admin" style="display:none; color:var(--danger)" onclick="showPage('admin')">ğŸš¨ ê´€ë¦¬ì</div>
        </div>
    </div>
</header>

<div class="container">
    <main>
        <section id="page-home" class="page active">
            <div class="card" style="background: linear-gradient(135deg, #4f46e5, #818cf8); color:white; border:none;">
                <h2>Welcome to Master Piece v6 ğŸ›¡ï¸</h2>
                <p>Firebase Auth í†µí•© ë³´ì•ˆ ì‹œìŠ¤í…œ ê°€ë™ ì¤‘</p>
            </div>
            <div class="card"><h3>ğŸ”¥ ì‹¤ì‹œê°„ ë² ìŠ¤íŠ¸</h3><div id="home-hot"></div></div>
            <div class="card"><h3>ğŸ†• ìµœì‹ ê¸€</h3><div id="home-recent"></div></div>
        </section>

        <section id="page-board" class="page">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h2 id="board-title">ê²Œì‹œíŒ</h2>
                <button class="btn btn-p" onclick="checkWriteAuth()">âœï¸ ê¸€ì“°ê¸°</button>
            </div>
            <div id="board-list" class="card" style="padding:0; overflow:hidden;"></div>
        </section>

        <section id="page-detail" class="page">
            <div class="card">
                <div style="display:flex; justify-content:space-between;">
                    <span id="det-tag" class="tag"></span>
                    <button class="btn btn-s" style="font-size:11px;" onclick="reportContent()">ğŸš¨ ì‹ ê³ </button>
                </div>
                <h1 id="det-title" style="margin:15px 0;"></h1>
                <div id="det-meta" style="font-size:13px; color:gray; margin-bottom:20px;"></div>
                <div id="det-content" class="namu-area" style="min-height:200px; white-space:pre-wrap;"></div>
                <div style="text-align:center; margin:30px 0;">
                    <button class="btn btn-s" id="likeBtn" onclick="handleLike()" style="padding:15px 30px; border-radius:30px;">
                        â¤ï¸ ì¢‹ì•„ìš” <span id="det-likes">0</span>
                    </button>
                </div>
                <div style="display:flex; justify-content:flex-end; gap:10px;">
                    <button id="admin-pin-btn" class="btn btn-warn" style="display:none;" onclick="togglePin()">ğŸ“Œ ê³ ì •</button>
                    <button id="owner-del-btn" class="btn btn-danger" style="display:none;" onclick="deletePost()">ì‚­ì œ</button>
                    <button class="btn btn-s" onclick="goBack()">ëª©ë¡ìœ¼ë¡œ</button>
                </div>
            </div>
            <div class="card">
                <h4>ëŒ“ê¸€ <span id="det-comm-cnt" style="color:var(--primary)">0</span></h4>
                <div id="comm-list" style="margin:15px 0;"></div>
                <div style="display:flex; gap:10px;">
                    <input type="text" id="commInput" placeholder="ëŒ“ê¸€ì„ ë‚¨ê²¨ë³´ì„¸ìš”..." style="margin:0;">
                    <button class="btn btn-p" onclick="addComment()">ë“±ë¡</button>
                </div>
            </div>
        </section>

        <section id="page-mypage" class="page">
            <div class="card" style="text-align:center;">
                <div id="my-profile-pic" style="width:80px; height:80px; background:#ddd; border-radius:50%; margin:0 auto 15px;"></div>
                <h2 id="my-name">ì‚¬ìš©ì</h2>
                <div id="my-role-tag"></div>
                <button class="btn btn-danger" style="width:100%; margin-top:20px;" onclick="handleLogout()">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
            <div class="card">
                <h3>ğŸ” ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</h3>
                <input type="password" id="newPw" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸">
                <button class="btn btn-p" style="width:100%; margin-top:10px;" onclick="changePassword()">ë³€ê²½í•˜ê¸°</button>
            </div>
        </section>

        <section id="page-inquiry" class="page">
            <div class="card">
                <h3>ğŸ“® ìš´ì˜ì§„ 1:1 ë¬¸ì˜</h3>
                <textarea id="inqInput" rows="5" placeholder="ë¬¸ì˜í•˜ì‹¤ ë‚´ìš©ì„ ìƒì„¸íˆ ì ì–´ì£¼ì„¸ìš”."></textarea>
                <button class="btn btn-p" style="width:100%; margin-top:10px;" onclick="sendInquiry()">ë¬¸ì˜ ì ‘ìˆ˜</button>
            </div>
            <div id="my-inq-list"></div>
        </section>

        <section id="page-admin" class="page">
            <div class="card"><h3>ğŸ‘¥ ìœ ì € ê´€ë¦¬</h3><div id="adm-users"></div></div>
            <div class="card"><h3>ğŸš¨ ì‹ ê³  ë‚´ì—­</h3><div id="adm-reports"></div></div>
            <div class="card"><h3>ğŸ“§ ë¬¸ì˜ ê´€ë¦¬</h3><div id="adm-inquiries"></div></div>
        </section>
    </main>

    <aside class="sidebar">
        <div class="card">
            <h4>ğŸ“Š ì‚¬ì´íŠ¸ í˜„í™©</h4>
            <div style="margin-top:10px; font-size:14px;">
                íšŒì›ìˆ˜: <b id="stat-u">0</b><br>
                ê²Œì‹œë¬¼: <b id="stat-p">0</b>
            </div>
        </div>
        <div class="card">
            <h4>ğŸ“¢ ê³µì§€ì‚¬í•­</h4>
            <div id="side-notice" style="font-size:13px; margin-top:10px;"></div>
        </div>
    </aside>
</div>

<div id="notiBox" class="card" style="display:none; position:fixed; top:75px; right:20px; width:320px; z-index:3000; max-height:400px; overflow-y:auto; box-shadow:0 10px 20px rgba(0,0,0,0.2);">
    <div style="display:flex; justify-content:space-between; border-bottom:1px solid #eee; padding-bottom:10px; margin-bottom:10px;">
        <b>ì•Œë¦¼</b>
        <small style="color:var(--primary); cursor:pointer;" onclick="clearNoti()">ì „ì²´ ì½ìŒ</small>
    </div>
    <div id="notiList" style="font-size:13px;"></div>
</div>

<div class="modal" id="authModal">
    <div class="modal-content">
        <h2 style="text-align:center; margin-bottom:20px;">MASTER PIECE</h2>
        <input type="email" id="authEmail" placeholder="ì´ë©”ì¼ ì£¼ì†Œ">
        <input type="password" id="authPw" placeholder="ë¹„ë°€ë²ˆí˜¸ (6ì ì´ìƒ)">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:20px;">
            <button class="btn btn-p" onclick="handleLogin()">ë¡œê·¸ì¸</button>
            <button class="btn btn-s" onclick="handleSignUp()">íšŒì›ê°€ì…</button>
        </div>
        <p onclick="closeModal('authModal')" style="text-align:center; margin-top:15px; cursor:pointer; font-size:12px; color:gray;">ë‹«ê¸°</p>
    </div>
</div>

<div class="modal" id="writeModal">
    <div class="modal-content" style="max-width:700px;">
        <h2>ìƒˆ ê¸€ ì‘ì„±</h2>
        <input type="text" id="wTitle" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”">
        <textarea id="wContent" rows="15" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”. (**êµµê²Œ**, --ì·¨ì†Œì„ --, > ì¸ìš©êµ¬ ì§€ì›)"></textarea>
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button class="btn btn-s" style="flex:1" onclick="closeModal('writeModal')">ì·¨ì†Œ</button>
            <button class="btn btn-p" style="flex:2" onclick="savePost()">ë“±ë¡í•˜ê¸°</button>
        </div>
    </div>
</div>

<script>
    // 1. ì´ˆê¸°í™”
    const firebaseConfig = {
        apiKey: "AIzaSyBcxvsiEOyL1lZGVr1UE2gzzZ7HQX5YfbI",
        authDomain: "code-78890.firebaseapp.com",
        projectId: "code-78890",
        storageBucket: "code-78890.firebasestorage.app",
        messagingSenderId: "30317586652",
        appId: "1:30317586652:web:d1e6fa39c319029fb7ac19"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    let state = { user: null, posts: [], viewingId: null, board: 'home', unsubComm: null };

    // 2. [ë³´ì•ˆ í•µì‹¬] Auth ìƒíƒœ ê°ì‹œ
    auth.onAuthStateChanged(async (user) => {
        if (user) {
            const doc = await db.collection("users").doc(user.uid).get();
            if(!doc.exists) { // ê°€ì… ì§í›„ ë¬¸ì„œ ìƒì„± ì „ ì²˜ë¦¬
                state.user = { uid: user.uid, id: user.email.split('@')[0], role: 'member' };
            } else {
                state.user = { uid: user.uid, ...doc.data() };
            }
            updateAuthUI();
            startNotifications();
        } else {
            state.user = null;
            resetAuthUI();
        }
        loadData();
    });

    function updateAuthUI() {
        document.getElementById('authBtnArea').style.display = 'none';
        document.getElementById('userInfoArea').style.display = 'block';
        document.getElementById('userNickDisplay').innerText = state.user.id;
        document.getElementById('m-admin').style.display = state.user.role === 'admin' ? 'block' : 'none';
        document.getElementById('my-name').innerText = state.user.id;
        document.getElementById('my-role-tag').innerHTML = `<span class="tag tag-notice">${state.user.role.toUpperCase()}</span>`;
    }

    function resetAuthUI() {
        document.getElementById('authBtnArea').style.display = 'block';
        document.getElementById('userInfoArea').style.display = 'none';
        document.getElementById('m-admin').style.display = 'none';
    }

    // 3. ë°ì´í„° ë¡œë“œ ë° ë Œë”ë§
    function loadData() {
        db.collection("posts").orderBy("date", "desc").onSnapshot(snap => {
            state.posts = snap.docs.map(d => ({ fId: d.id, ...d.data() }));
            renderHome();
            if(state.board !== 'home' && state.board !== 'search') renderBoard();
            if(state.viewingId) renderDetail();
        });
        db.collection("users").onSnapshot(s => document.getElementById('stat-u').innerText = s.size);
        db.collection("posts").onSnapshot(s => document.getElementById('stat-p').innerText = s.size);
    }

    function renderHome() {
        const hot = state.posts.filter(p => (p.likes || 0) >= 3).slice(0, 5);
        document.getElementById('home-hot').innerHTML = hot.map(p => `<div class="list-item" onclick="viewDetail('${p.fId}')"><span>${p.title}</span><b style="color:var(--danger)">+${p.likes||0}</b></div>`).join('') || 'ì¸ê¸°ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.';
        document.getElementById('home-recent').innerHTML = state.posts.slice(0, 5).map(p => `<div class="list-item" onclick="viewDetail('${p.fId}')"><span>${p.title}</span><small>${p.dateStr}</small></div>`).join('');
        document.getElementById('side-notice').innerHTML = state.posts.filter(p => p.board === 'notice').slice(0,3).map(p => `<div style="margin-bottom:8px; cursor:pointer;" onclick="viewDetail('${p.fId}')">â€¢ ${p.title}</div>`).join('');
    }

    function renderBoard(custom = null) {
        const list = custom || state.posts.filter(p => p.board === state.board);
        document.getElementById('board-list').innerHTML = list.map(p => `
            <div class="list-item" onclick="viewDetail('${p.fId}')">
                <div>
                    <span class="tag ${p.board==='notice'?'tag-notice':'tag-free'}">${p.board.toUpperCase()}</span>
                    <b>${p.isPinned?'ğŸ“Œ ':''}${p.title}</b>
                    <div style="font-size:12px; color:gray; margin-top:5px;">${p.author} | ${p.dateStr}</div>
                </div>
                <div style="color:var(--primary); font-weight:800;">â¤ï¸ ${p.likes || 0}</div>
            </div>
        `).join('') || '<p style="padding:40px; text-align:center;">ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
    }

    function viewDetail(fId) {
        state.viewingId = fId;
        showPage('detail');
        renderDetail();
    }

    function renderDetail() {
        const p = state.posts.find(x => x.fId === state.viewingId);
        if(!p) return;
        document.getElementById('det-tag').innerText = p.board.toUpperCase();
        document.getElementById('det-title').innerText = p.title;
        document.getElementById('det-meta').innerText = `${p.author} â€¢ ${p.dateStr}`;
        document.getElementById('det-content').innerHTML = parseNamu(p.content);
        document.getElementById('det-likes').innerText = p.likes || 0;

        const isOwner = state.user && (state.user.uid === p.authorUid || state.user.role === 'admin');
        document.getElementById('owner-del-btn').style.display = isOwner ? 'block' : 'none';
        document.getElementById('admin-pin-btn').style.display = (state.user?.role === 'admin') ? 'block' : 'none';

        if(state.unsubComm) state.unsubComm();
        state.unsubComm = db.collection("comments").where("postId", "==", state.viewingId).orderBy("date", "asc").onSnapshot(s => {
            document.getElementById('det-comm-cnt').innerText = s.size;
            document.getElementById('comm-list').innerHTML = s.docs.map(doc => `
                <div style="padding:10px; background:#f8fafc; border-radius:10px; margin-bottom:10px;">
                    <b>${doc.data().author}</b><br>${doc.data().text}
                </div>
            `).join('');
        });
    }

    // 4. ê¸°ëŠ¥ í•¨ìˆ˜ë“¤
    async function handleSignUp() {
        const email = document.getElementById('authEmail').value;
        const pw = document.getElementById('authPw').value;
        if(pw.length < 6) return alert("ë¹„ë²ˆ 6ì ì´ìƒ!");
        try {
            const cred = await auth.createUserWithEmailAndPassword(email, pw);
            await db.collection("users").doc(cred.user.uid).set({
                id: email.split('@')[0], role: 'member', date: Date.now()
            });
            alert("ê°€ì… ì„±ê³µ!");
            closeModal('authModal');
        } catch(e) { alert(e.message); }
    }

    async function handleLogin() {
        const email = document.getElementById('authEmail').value;
        const pw = document.getElementById('authPw').value;
        try {
            await auth.signInWithEmailAndPassword(email, pw);
            closeModal('authModal');
        } catch(e) { alert("ë¡œê·¸ì¸ ì‹¤íŒ¨: " + e.message); }
    }

    async function handleLogout() { await auth.signOut(); location.reload(); }

    async function savePost() {
        const t = document.getElementById('wTitle').value;
        const c = document.getElementById('wContent').value;
        if(!t || !c) return;
        await db.collection("posts").add({
            title: t, content: c, author: state.user.id, authorUid: state.user.uid,
            board: (state.board === 'home' || state.board === 'search') ? 'free' : state.board,
            date: Date.now(), dateStr: new Date().toLocaleDateString(), likes: 0, likedBy: [], isPinned: false
        });
        closeModal('writeModal');
    }

    async function handleLike() {
        if(!state.user) return alert("ë¡œê·¸ì¸ í•„ìš”");
        const p = state.posts.find(x => x.fId === state.viewingId);
        const ref = db.collection("posts").doc(state.viewingId);
        if(p.likedBy?.includes(state.user.uid)) {
            await ref.update({ likes: firebase.firestore.FieldValue.increment(-1), likedBy: firebase.firestore.FieldValue.arrayRemove(state.user.uid) });
        } else {
            await ref.update({ likes: firebase.firestore.FieldValue.increment(1), likedBy: firebase.firestore.FieldValue.arrayUnion(state.user.uid) });
            if(p.authorUid !== state.user.uid) sendNoti(p.authorUid, `ë‚´ ê¸€ '${p.title}'ì— ì¢‹ì•„ìš”ê°€ ë‹¬ë ¸ìŠµë‹ˆë‹¤!`);
        }
    }

    async function addComment() {
        const val = document.getElementById('commInput').value;
        if(!val || !state.user) return;
        const p = state.posts.find(x => x.fId === state.viewingId);
        await db.collection("comments").add({ postId: state.viewingId, author: state.user.id, text: val, date: Date.now() });
        document.getElementById('commInput').value = '';
        if(p.authorUid !== state.user.uid) sendNoti(p.authorUid, `'${p.title}' ê¸€ì— ëŒ“ê¸€ì´ ë‹¬ë ¸ìŠµë‹ˆë‹¤.`);
    }

    async function changePassword() {
        const np = document.getElementById('newPw').value;
        if(np.length < 6) return alert("6ì ì´ìƒ ì…ë ¥");
        try {
            await auth.currentUser.updatePassword(np);
            alert("ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ë¨! ë‹¤ì‹œ ë¡œê·¸ì¸í•˜ì„¸ìš”.");
            handleLogout();
        } catch(e) { alert("ìµœê·¼ ë¡œê·¸ì¸ ì •ë³´ê°€ í•„ìš”í•©ë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸ í›„ ì‹œë„í•˜ì„¸ìš”."); }
    }

    // ì•Œë¦¼ ì‹œìŠ¤í…œ
    async function sendNoti(to, msg) { await db.collection("notis").add({ to, msg, read: false, date: Date.now() }); }
    function startNotifications() {
        db.collection("notis").where("to", "==", state.user.uid).where("read", "==", false).onSnapshot(s => {
            document.getElementById('notiCount').innerText = s.size;
            document.getElementById('notiCount').style.display = s.size > 0 ? 'block' : 'none';
            document.getElementById('notiList').innerHTML = s.docs.map(d => `<div style="padding:10px; border-bottom:1px solid #eee;">${d.data().msg}</div>`).join('') || 'ìƒˆ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.';
        });
    }
    async function clearNoti() {
        const q = await db.collection("notis").where("to", "==", state.user.uid).get();
        const batch = db.batch(); q.forEach(d => batch.delete(d.ref)); await batch.commit();
    }

    // ê¸°íƒ€ ìœ í‹¸
    function parseNamu(t) {
        return t.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]))
                .replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/--(.*?)--/g, '<del>$1</del>').replace(/^> (.*$)/gm, '<blockquote>$1</blockquote>');
    }
    function execSearch() {
        const q = document.getElementById('mainSearch').value.toLowerCase();
        if(!q) return;
        state.board = 'search';
        const res = state.posts.filter(p => p.title.toLowerCase().includes(q) || p.content.toLowerCase().includes(q));
        document.getElementById('board-title').innerText = `ğŸ” "${q}" ê²€ìƒ‰ ê²°ê³¼`;
        showPage('board'); renderBoard(res);
    }
    function showPage(id) {
        if(id === 'admin' && state.user?.role !== 'admin') return alert("ê´€ë¦¬ì ì „ìš©");
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById('page-'+id).classList.add('active');
        window.scrollTo(0,0);
        if(id === 'admin') loadAdminData();
    }
    function goHome() { state.board = 'home'; state.viewingId = null; updateNav(); showPage('home'); }
    function showBoard(name) { state.board = name; state.viewingId = null; updateNav(); document.getElementById('board-title').innerText = name.toUpperCase(); showPage('board'); renderBoard(); }
    function updateNav() { document.querySelectorAll('.nav-item').forEach(v => v.classList.toggle('active', v.id === 'm-'+state.board)); }
    function openModal(id) { document.getElementById(id).classList.add('active'); }
    function closeModal(id) { document.getElementById(id).classList.remove('active'); }
    function checkWriteAuth() { if(!state.user) return openModal('authModal'); openModal('writeModal'); }
    function toggleNoti() { const b = document.getElementById('notiBox'); b.style.display = b.style.display === 'none' ? 'block' : 'none'; }
    function goBack() { showBoard(state.board); }

    // ê´€ë¦¬ì ë¡œì§
    async function loadAdminData() {
        const uSnap = await db.collection("users").get();
        document.getElementById('adm-users').innerHTML = uSnap.docs.map(d => `<div>${d.data().id} (${d.data().role}) <button onclick="setAdmin('${d.id}')">ì „í™˜</button></div>`).join('');
    }
    async function setAdmin(uid) { 
        const doc = await db.collection("users").doc(uid).get();
        const next = doc.data().role === 'admin' ? 'member' : 'admin';
        await db.collection("users").doc(uid).update({ role: next });
        loadAdminData();
    }
    async function deletePost() { if(confirm("ì‚­ì œ?")) { await db.collection("posts").doc(state.viewingId).delete(); goHome(); } }
    async function togglePin() { 
        const p = state.posts.find(x => x.fId === state.viewingId);
        await db.collection("posts").doc(state.viewingId).update({ isPinned: !p.isPinned });
    }
</script>
</body>
</html>
