<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MASTER PIECE - TOTAL CONTROL</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        :root { --primary: #4f46e5; --primary-soft: #eef2ff; --bg: #f8fafc; --card: #ffffff; --text: #1e293b; --danger: #ef4444; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Pretendard', -apple-system, sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: var(--text); padding-bottom: 60px; line-height: 1.5; }
        
        /* Layout & Header */
        header { background: white; border-bottom: 1px solid #e2e8f0; position: sticky; top: 0; z-index: 1000; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .h-wrap { max-width: 1100px; margin: 0 auto; padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; gap: 15px; }
        .logo { font-size: 20px; font-weight: 800; color: var(--primary); cursor: pointer; letter-spacing: -0.5px; }
        .search-container { flex: 1; max-width: 450px; position: relative; }
        .search-input { width: 100%; padding: 10px 18px; border-radius: 25px; border: 1px solid #e2e8f0; background: #f1f5f9; font-size: 15px; outline: none; transition: 0.2s; }
        .search-input:focus { background: white; border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-soft); }
        
        .nav-scroller { background: white; border-bottom: 1px solid #f1f5f9; }
        .nav-flex { max-width: 1100px; margin: 0 auto; display: flex; padding: 0 10px; overflow-x: auto; scrollbar-width: none; }
        .nav-item { padding: 14px 18px; font-size: 14px; font-weight: 700; color: #64748b; cursor: pointer; white-space: nowrap; border-bottom: 3px solid transparent; }
        .nav-item.active { color: var(--primary); border-bottom-color: var(--primary); }

        .main-grid { max-width: 1100px; margin: 20px auto; padding: 0 15px; display: grid; grid-template-columns: 1fr 280px; gap: 25px; }
        @media (max-width: 850px) { .main-grid { grid-template-columns: 1fr; } .sidebar { display: none; } }

        /* Components */
        .card { background: var(--card); border-radius: 16px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 20px; border: 1px solid #f1f5f9; }
        .btn { padding: 10px 20px; border-radius: 10px; border: none; font-weight: 700; cursor: pointer; font-size: 14px; transition: 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 6px; }
        .btn-p { background: var(--primary); color: white; }
        .btn-s { background: #f1f5f9; color: #475569; }
        .btn-danger { background: #fee2e2; color: var(--danger); }
        
        .list-item { padding: 15px; border-bottom: 1px solid #f8fafc; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: 0.1s; }
        .list-item:hover { background: #f8fafc; }
        .tag { padding: 3px 8px; border-radius: 6px; font-size: 11px; font-weight: 800; text-transform: uppercase; margin-right: 8px; }
        .tag-notice { background: #fee2e2; color: #b91c1c; }
        .tag-free { background: #e0e7ff; color: #4338ca; }

        /* Pages */
        .page { display: none; animation: slideUp 0.3s ease-out; }
        .page.active { display: block; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* NamuWiki Parser Style */
        .namu-area { line-height: 1.8; color: #334155; }
        .namu-area b { font-weight: 800; color: #000; }
        .namu-area blockquote { border-left: 5px solid #cbd5e1; padding: 10px 15px; background: #f8fafc; margin: 15px 0; border-radius: 0 8px 8px 0; }
        
        /* Modal */
        .modal { display: none; position: fixed; inset: 0; background: rgba(15, 23, 42, 0.6); z-index: 2000; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(4px); }
        .modal.active { display: flex; }
        .modal-content { background: white; border-radius: 24px; padding: 30px; width: 100%; max-width: 480px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }
        input, textarea { width: 100%; padding: 14px; margin-top: 10px; border: 1px solid #e2e8f0; border-radius: 12px; font-size: 16px; outline: none; }
        input:focus { border-color: var(--primary); }

        .badge { background: var(--danger); color: white; font-size: 10px; padding: 2px 6px; border-radius: 10px; position: absolute; top: -5px; right: -8px; border: 2px solid white; }
    </style>
</head>
<body>

<header>
    <div class="h-wrap">
        <div class="logo" onclick="goHome()">MASTER PIECE</div>
        <div class="search-container">
            <input type="text" id="mainSearch" class="search-input" placeholder="ê´€ì‹¬ ìˆëŠ” ë‚´ìš©ì„ ê²€ìƒ‰í•˜ì„¸ìš”..." onkeyup="if(event.keyCode==13)execSearch()">
        </div>
        <div style="display:flex; gap:15px; align-items:center;">
            <div style="position:relative; cursor:pointer;" onclick="toggleNotiBox()">ğŸ””<span id="notiCount" class="badge" style="display:none;">0</span></div>
            <div id="authBtnArea"><button class="btn btn-p" onclick="openModal('loginModal')">ë¡œê·¸ì¸</button></div>
            <div id="userInfoArea" style="display:none; cursor:pointer;" onclick="showPage('mypage')">
                <span id="userNick" style="font-weight:700; font-size:14px; color:var(--primary);"></span>
            </div>
        </div>
    </div>
    <div class="nav-scroller">
        <div class="nav-flex">
            <div class="nav-item active" id="m-home" onclick="goHome()">í™ˆ</div>
            <div class="nav-item" id="m-notice" onclick="showBoard('notice')">ê³µì§€ì‚¬í•­</div>
            <div class="nav-item" id="m-free" onclick="showBoard('free')">ììœ ê²Œì‹œíŒ</div>
            <div class="nav-item" id="m-qna" onclick="showBoard('qna')">ì§ˆë¬¸ë‹µë³€</div>
            <div class="nav-item" id="m-inquiry" onclick="showPage('inquiry')">1:1ë¬¸ì˜</div>
            <div class="nav-item" id="m-admin" onclick="showPage('admin')" style="display:none; color:var(--danger)">ê´€ë¦¬ë„êµ¬</div>
        </div>
    </div>
</header>

<div class="main-grid">
    <div class="content-left">
        <div id="page-home" class="page active">
            <div class="card" style="background: linear-gradient(135deg, #4f46e5, #818cf8); color: white; border:none;">
                <h2 style="margin-bottom:8px;">ì˜¤ëŠ˜ì˜ ë§ˆìŠ¤í„° í”¼ìŠ¤ ğŸ¨</h2>
                <p style="opacity:0.9; font-size:14px;">ì•ˆì „í•˜ê³  ê²¬ê³ í•˜ê²Œ ì„¤ê³„ëœ ì»¤ë®¤ë‹ˆí‹° ì‹œìŠ¤í…œì…ë‹ˆë‹¤.</p>
            </div>
            <div class="card">
                <h3 style="margin-bottom:15px;">ğŸ”¥ ì‹¤ì‹œê°„ ì¸ê¸°ê¸€</h3>
                <div id="hot-posts"></div>
            </div>
            <div class="card">
                <h3 style="margin-bottom:15px;">ğŸ†• ìµœì‹  ê²Œì‹œê¸€</h3>
                <div id="recent-posts"></div>
            </div>
        </div>

        <div id="page-board" class="page">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h2 id="board-title-text">ê²Œì‹œíŒ</h2>
                <button class="btn btn-p" onclick="checkWriteAuth()">âœï¸ ê¸€ì“°ê¸°</button>
            </div>
            <div id="board-list-area" class="card" style="padding:0; overflow:hidden;"></div>
        </div>

        <div id="page-detail" class="page">
            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                    <span id="det-tag" class="tag"></span>
                    <button class="btn btn-s" style="font-size:11px;" onclick="reportContent('post', state.viewingId)">ğŸš¨ ì‹ ê³ </button>
                </div>
                <h1 id="det-title" style="margin: 12px 0; font-size:24px; letter-spacing:-1px;"></h1>
                <div id="det-meta" style="font-size:13px; color:#64748b; margin-bottom:20px;"></div>
                <hr style="border:0; border-top:1px solid #f1f5f9; margin-bottom:20px;">
                <div id="det-content" class="namu-area" style="min-height:150px; white-space:pre-wrap;"></div>
                <div style="margin-top:40px; text-align:center;">
                    <button class="btn btn-s" id="likeBtn" onclick="toggleLike()" style="padding:12px 25px; border-radius:30px;">
                        â¤ï¸ ì¢‹ì•„ìš” <span id="det-likes">0</span>
                    </button>
                </div>
                <div style="margin-top:30px; display:flex; justify-content:flex-end; gap:10px;">
                    <button id="admin-pin-btn" class="btn btn-s" style="display:none; background:#fef3c7; color:#92400e;" onclick="setPin()">ğŸ“Œ ê³µì§€ë“±ë¡</button>
                    <button id="owner-del-btn" class="btn btn-danger" style="display:none;" onclick="deletePost()">ì‚­ì œ</button>
                </div>
            </div>
            <div class="card">
                <h4>ëŒ“ê¸€ <span id="det-comm-cnt" style="color:var(--primary)">0</span></h4>
                <div id="comm-container" style="margin:20px 0;"></div>
                <div style="display:flex; gap:10px;">
                    <input type="text" id="commInput" placeholder="ë§¤ë„ˆ ìˆëŠ” ëŒ“ê¸€ì„ ì‘ì„±í•´ì£¼ì„¸ìš”." style="margin:0;">
                    <button class="btn btn-p" onclick="submitComment()">ë“±ë¡</button>
                </div>
            </div>
        </div>

        <div id="page-mypage" class="page">
            <div class="card" style="text-align:center;">
                <div style="width:80px; height:80px; background:var(--primary-soft); border-radius:50%; margin:0 auto 15px; display:flex; align-items:center; justify-content:center; font-size:30px;">ğŸ‘¤</div>
                <h2 id="my-id-display"></h2>
                <button class="btn btn-s" onclick="handleLogout()" style="margin-top:15px; width:100%;">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
            <div class="card"><h3>ë‚´ê°€ ì“´ ê¸€</h3><div id="my-posts-list"></div></div>
        </div>

        <div id="page-inquiry" class="page">
            <div class="card">
                <h3>ğŸ“® ìš´ì˜ì§„ 1:1 ë¬¸ì˜</h3>
                <p style="font-size:13px; color:#64748b; margin-bottom:15px;">ë¬¸ì˜í•˜ì‹  ë‚´ìš©ì€ ìš´ì˜ì§„ë§Œ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                <textarea id="inqText" rows="4" placeholder="ë¬¸ì˜ ë‚´ìš©ì„ ìƒì„¸íˆ ì ì–´ì£¼ì„¸ìš”."></textarea>
                <button class="btn btn-p" style="width:100%; margin-top:10px;" onclick="submitInquiry()">ë¬¸ì˜í•˜ê¸°</button>
            </div>
            <div id="my-inq-status"></div>
        </div>

        <div id="page-admin" class="page">
            <div class="card"><h3>ğŸš¨ ì‹¤ì‹œê°„ ì‹ ê³  ë‚´ì—­</h3><div id="admin-reports"></div></div>
            <div class="card"><h3>ğŸ“§ ê³ ê° ë¬¸ì˜ ê´€ë¦¬</h3><div id="admin-inquiries"></div></div>
        </div>
    </div>

    <div class="sidebar">
        <div class="card">
            <h4>ğŸ“Š ì»¤ë®¤ë‹ˆí‹° í†µê³„</h4>
            <div id="stat-area" style="margin-top:15px; font-size:14px; color:#475569; line-height:2.2;">
                ìœ ì € ìˆ˜: <b id="stat-u" style="color:var(--text)">-</b>ëª…<br>
                ê²Œì‹œê¸€: <b id="stat-p" style="color:var(--text)">-</b>ê°œ
            </div>
        </div>
        <div class="card" style="background:#f8fafc;">
            <p style="font-size:12px; color:#94a3b8;">&copy; 2026 MASTER PIECE PRO.<br>All Rights Reserved.</p>
        </div>
    </div>
</div>

<div id="notiBox" class="card" style="display:none; position:fixed; top:75px; right:20px; width:300px; z-index:3000; box-shadow:0 10px 15px rgba(0,0,0,0.15); max-height:400px; overflow-y:auto;">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <b>ìµœì‹  ì•Œë¦¼</b>
        <small style="color:var(--primary); cursor:pointer;" onclick="markAllRead()">ì „ì²´ ì½ìŒ</small>
    </div>
    <div id="notiList" style="font-size:13px;"></div>
</div>

<div class="modal" id="loginModal">
    <div class="modal-content">
        <h2 style="letter-spacing:-1px;">ë°˜ê°€ì›Œìš”! ğŸ‘‹</h2>
        <input type="text" id="loginId" placeholder="ì•„ì´ë””">
        <input type="password" id="loginPw" placeholder="ë¹„ë°€ë²ˆí˜¸">
        <button class="btn btn-p" style="width:100%; margin-top:20px; padding:15px;" onclick="doLogin()">ë¡œê·¸ì¸</button>
        <button class="btn btn-s" style="width:100%; margin-top:10px; padding:15px;" onclick="doJoin()">íšŒì›ê°€ì…</button>
        <p style="text-align:center; margin-top:15px; font-size:12px; color:#94a3b8; cursor:pointer;" onclick="closeModal('loginModal')">ë‹¤ìŒì— í• ê²Œìš”</p>
    </div>
</div>

<div class="modal" id="writeModal">
    <div class="modal-content" style="max-width:700px;">
        <h2>ê²Œì‹œê¸€ ì‘ì„±</h2>
        <input type="text" id="w-title" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”">
        <textarea id="w-content" rows="12" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”. (**êµµê²Œ**, --ì·¨ì†Œì„ -- ì‚¬ìš© ê°€ëŠ¥)"></textarea>
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button class="btn btn-s" style="flex:1;" onclick="closeModal('writeModal')">ì·¨ì†Œ</button>
            <button class="btn btn-p" style="flex:2;" onclick="savePost()">ì‘ì„± ì™„ë£Œ</button>
        </div>
    </div>
</div>

<script>
    // 1. Firebase ì„¤ì •
    const firebaseConfig = {
        apiKey: "AIzaSyBcxvsiEOyL1lZGVr1UE2gzzZ7HQX5YfbI",
        authDomain: "code-78890.firebaseapp.com",
        projectId: "code-78890",
        storageBucket: "code-78890.firebasestorage.app",
        messagingSenderId: "30317586652",
        appId: "1:30317586652:web:d1e6fa39c319029fb7ac19"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // 2. ê¸€ë¡œë²Œ ìƒíƒœ
    let state = {
        user: JSON.parse(localStorage.getItem('mp_session')) || null,
        posts: [],
        viewingId: null,
        currentBoard: 'free',
        commUnsub: null
    };

    // 3. ë³´ì•ˆ ìœ í‹¸ë¦¬í‹°
    function escapeHtml(text) {
        const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
        return String(text).replace(/[&<>"']/g, m => map[m]);
    }

    function hashPassword(pw) {
        return CryptoJS.SHA256(pw).toString();
    }

    // 4. ì´ˆê¸°í™” í•¨ìˆ˜
    function init() {
        if(state.user) updateAuthUI();
        
        db.collection("posts").orderBy("id", "desc").onSnapshot(snap => {
            state.posts = snap.docs.map(d => ({ fId: d.id, ...d.data() }));
            renderHome();
            if(document.getElementById('page-board').classList.contains('active')) renderBoardList();
            if(state.viewingId) renderDetail(state.viewingId);
        });

        db.collection("users").onSnapshot(s => {
            document.getElementById('stat-u').innerText = s.size;
            if(state.user?.role === 'admin') renderAdminReports();
        });
        db.collection("posts").onSnapshot(s => document.getElementById('stat-p').innerText = s.size);
        
        if(state.user) setupNotificationListener();
        setupInquiryListener();
    }

    // 5. ë‚˜ë¬´ìœ„í‚¤í˜• íŒŒì„œ (XSS ë³´ì•ˆ ì ìš©)
    function namuParser(text) {
        if(!text) return "";
        let safeText = escapeHtml(text); 
        return safeText
            .replace(/\*\*(.*?)\*\*/g, '<b>$1</b>')
            .replace(/--(.*?)--/g, '<del>$1</del>')
            .replace(/> (.*)/g, '<blockquote>$1</blockquote>');
    }

    // 6. ì¸ì¦ ë¡œì§ (í•´ì‹± ì ìš©)
    async function doJoin() {
        const id = document.getElementById('loginId').value.trim();
        const pw = document.getElementById('loginPw').value.trim();
        if(!id || !pw) return alert("ë¹ˆì¹¸ì„ ì±„ì›Œì£¼ì„¸ìš”.");
        if(id.length < 4) return alert("ì•„ì´ë””ëŠ” 4ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.");
        
        const chk = await db.collection("users").where("id", "==", id).get();
        if(!chk.empty) return alert("ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì•„ì´ë””ì…ë‹ˆë‹¤.");
        
        // ë¹„ë°€ë²ˆí˜¸ë¥¼ í•´ì‹±í•˜ì—¬ ì €ì¥ (ë³´ì•ˆê°•í™”)
        await db.collection("users").add({ 
            id, 
            pw: hashPassword(pw), 
            role: 'member', 
            isBanned: false, 
            createdAt: Date.now() 
        });
        alert("ê°€ì… ì„±ê³µ! ì´ì œ ë¡œê·¸ì¸ í•´ì£¼ì„¸ìš”.");
    }

    async function doLogin() {
        const id = document.getElementById('loginId').value.trim();
        const pw = document.getElementById('loginPw').value.trim();
        // ì…ë ¥ëœ ë¹„ë°€ë²ˆí˜¸ë¥¼ í•´ì‹±í•˜ì—¬ DBì˜ í•´ì‹œê°’ê³¼ ë¹„êµ
        const hashed = hashPassword(pw);
        const res = await db.collection("users").where("id", "==", id).where("pw", "==", hashed).get();
        
        if(res.empty) return alert("ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë¦½ë‹ˆë‹¤.");
        
        const userData = res.docs[0].data();
        if(userData.isBanned) return alert("ì°¨ë‹¨ëœ ê³„ì •ì…ë‹ˆë‹¤.");
        
        state.user = userData;
        localStorage.setItem('mp_session', JSON.stringify(state.user));
        location.reload();
    }

    function handleLogout() {
        localStorage.removeItem('mp_session');
        location.reload();
    }

    function updateAuthUI() {
        document.getElementById('authBtnArea').style.display = 'none';
        document.getElementById('userInfoArea').style.display = 'block';
        document.getElementById('userNick').innerText = escapeHtml(state.user.id) + "ë‹˜";
        if(state.user.role === 'admin') document.getElementById('m-admin').style.display = 'block';
    }

    // 7. ê²Œì‹œíŒ ë¡œì§
    function showBoard(boardName) {
        state.currentBoard = boardName;
        state.viewingId = null;
        const titles = { notice: 'ğŸ“¢ ê³µì§€ì‚¬í•­', free: 'ğŸ’¬ ììœ ê²Œì‹œíŒ', qna: 'â“ ì§ˆë¬¸ë‹µë³€' };
        document.getElementById('board-title-text').innerText = titles[boardName] || 'ê²Œì‹œíŒ';
        
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        const navEl = document.getElementById('m-' + boardName);
        if(navEl) navEl.classList.add('active');
        
        showPage('board');
        renderBoardList();
    }

    function renderBoardList(customList = null) {
        const list = customList || state.posts.filter(p => p.board === state.currentBoard);
        const container = document.getElementById('board-list-area');
        container.innerHTML = list.map(p => `
            <div class="list-item" onclick="viewDetail('${p.fId}')">
                <div>
                    <span class="tag ${p.board==='notice'?'tag-notice':'tag-free'}">${escapeHtml(p.board)}</span>
                    <b style="font-size:15px;">${p.isPinned ? 'ğŸ“Œ ' : ''}${escapeHtml(p.title)}</b>
                    <div style="font-size:12px; color:#94a3b8; margin-top:4px;">${escapeHtml(p.author)} | ${escapeHtml(p.date)}</div>
                </div>
                <div style="text-align:right;">
                    <span style="color:var(--danger); font-weight:700; font-size:13px;">â¤ï¸ ${p.likes || 0}</span>
                </div>
            </div>
        `).join('') || '<div style="padding:50px; text-align:center; color:#94a3b8;">ì‘ì„±ëœ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
    }

    // 8. ìƒì„¸ ë³´ê¸° & ëŒ“ê¸€
    function viewDetail(fId) {
        state.viewingId = fId;
        showPage('detail');
        renderDetail(fId);
    }

    function renderDetail(fId) {
        const p = state.posts.find(x => x.fId === fId);
        if(!p) return;

        document.getElementById('det-tag').innerText = p.board;
        document.getElementById('det-tag').className = `tag ${p.board==='notice'?'tag-notice':'tag-free'}`;
        document.getElementById('det-title').innerText = p.title;
        document.getElementById('det-meta').innerText = `${p.author} â€¢ ${p.date}`;
        document.getElementById('det-content').innerHTML = namuParser(p.content);
        document.getElementById('det-likes').innerText = p.likes || 0;

        // ë²„íŠ¼ ì´ˆê¸°í™”
        document.getElementById('owner-del-btn').style.display = 'none';
        document.getElementById('admin-pin-btn').style.display = 'none';

        if(state.user) {
            if(state.user.id === p.author || state.user.role === 'admin') document.getElementById('owner-del-btn').style.display = 'block';
            if(state.user.role === 'admin') document.getElementById('admin-pin-btn').style.display = 'block';
        }

        if(state.commUnsub) state.commUnsub();
        state.commUnsub = db.collection("comments").where("postId", "==", fId).onSnapshot(snap => {
            let comms = snap.docs.map(d => ({ cid: d.id, ...d.data() }));
            comms.sort((a, b) => a.date - b.date); 

            document.getElementById('det-comm-cnt').innerText = comms.length;
            document.getElementById('comm-container').innerHTML = comms.map(c => `
                <div style="background:#f8fafc; padding:12px; border-radius:12px; margin-bottom:10px; font-size:14px; position:relative;">
                    <b style="color:var(--primary);">${escapeHtml(c.user)}</b> <small style="color:#cbd5e1; margin-left:8px;">${new Date(c.date).toLocaleString()}</small>
                    <div style="margin-top:5px; line-height:1.4;">${escapeHtml(c.text)}</div>
                    <span style="position:absolute; top:12px; right:12px; cursor:pointer; font-size:10px; color:#cbd5e1;" onclick="reportContent('comment', '${c.cid}')">ì‹ ê³ </span>
                </div>
            `).join('') || '<p style="color:#94a3b8; font-size:13px; text-align:center;">ì²« ëŒ“ê¸€ì„ ë‚¨ê²¨ë³´ì„¸ìš”!</p>';
        });
    }

    async function submitComment() {
        if(!state.user) return alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
        const txt = document.getElementById('commInput').value.trim();
        if(!txt) return;

        const newComm = {
            postId: state.viewingId,
            user: state.user.id,
            text: txt,
            date: Date.now()
        };

        await db.collection("comments").add(newComm);
        
        const post = state.posts.find(x => x.fId === state.viewingId);
        if(post && post.author !== state.user.id) {
            await db.collection("notis").add({
                to: post.author,
                msg: `ë‚´ ê¸€ì— ìƒˆë¡œìš´ ëŒ“ê¸€ì´ ë‹¬ë ¸ìŠµë‹ˆë‹¤: "${txt.substring(0,10)}..."`,
                read: false,
                date: Date.now()
            });
        }
        document.getElementById('commInput').value = '';
    }

    // 9. ì£¼ìš” ê¸°ëŠ¥
    async function toggleLike() {
        if(!state.user) return alert("ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.");
        const p = state.posts.find(x => x.fId === state.viewingId);
        const ref = db.collection("posts").doc(state.viewingId);
        const likedBy = p.likedBy || [];

        if(likedBy.includes(state.user.id)) {
            await ref.update({ likes: firebase.firestore.FieldValue.increment(-1), likedBy: firebase.firestore.FieldValue.arrayRemove(state.user.id) });
        } else {
            await ref.update({ likes: firebase.firestore.FieldValue.increment(1), likedBy: firebase.firestore.FieldValue.arrayUnion(state.user.id) });
        }
    }

    function execSearch() {
        const q = document.getElementById('mainSearch').value.trim().toLowerCase();
        if(!q) return goHome();
        const filtered = state.posts.filter(p => p.title.toLowerCase().includes(q) || p.content.toLowerCase().includes(q));
        state.currentBoard = 'search';
        document.getElementById('board-title-text').innerText = `ğŸ” "${escapeHtml(q)}" ê²€ìƒ‰ ê²°ê³¼`;
        showPage('board');
        renderBoardList(filtered);
    }

    async function savePost() {
        if(!state.user) return;
        const title = document.getElementById('w-title').value.trim();
        const content = document.getElementById('w-content').value.trim();
        if(!title || !content) return alert("ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        if(title.length > 100) return alert("ì œëª©ì´ ë„ˆë¬´ ê¹ë‹ˆë‹¤.");

        await db.collection("posts").add({
            id: Date.now(),
            board: state.currentBoard === 'search' ? 'free' : state.currentBoard,
            title, content, author: state.user.id,
            date: new Date().toLocaleDateString(),
            likes: 0, likedBy: [], isPinned: false
        });

        closeModal('writeModal');
        showBoard(state.currentBoard === 'search' ? 'free' : state.currentBoard);
    }

    // 10. ìœ í‹¸ë¦¬í‹° & ì•Œë¦¼
    function showPage(pageId) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById('page-' + pageId).classList.add('active');
        if(pageId === 'mypage') renderMyPage();
        window.scrollTo(0, 0);
    }

    function renderHome() {
        const hot = state.posts.filter(p => (p.likes || 0) >= 5).slice(0, 5);
        document.getElementById('hot-posts').innerHTML = hot.map(p => `
            <div class="list-item" onclick="viewDetail('${p.fId}')">
                <span>${escapeHtml(p.title)}</span> <b style="color:var(--danger);">â¤ï¸ ${p.likes}</b>
            </div>
        `).join('') || '<p style="font-size:13px; color:#94a3b8; text-align:center;">ì•„ì§ ì¸ê¸°ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        
        document.getElementById('recent-posts').innerHTML = state.posts.slice(0, 5).map(p => `
            <div class="list-item" onclick="viewDetail('${p.fId}')">
                <span>${escapeHtml(p.title)}</span> <small style="color:#94a3b8;">${escapeHtml(p.date)}</small>
            </div>
        `).join('');
    }

    async function reportContent(type, id) {
        if(!state.user) return alert("ë¡œê·¸ì¸ í•„ìš”");
        const reason = prompt("ì‹ ê³  ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
        if(!reason) return;
        await db.collection("reports").add({ type, targetId: id, reason: escapeHtml(reason), reporter: state.user.id, date: Date.now() });
        alert("ì‹ ê³ ê°€ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.");
    }

    function setupNotificationListener() {
        db.collection("notis").where("to", "==", state.user.id).where("read", "==", false)
            .onSnapshot(s => {
                const count = s.size;
                document.getElementById('notiCount').innerText = count;
                document.getElementById('notiCount').style.display = count > 0 ? 'block' : 'none';
                document.getElementById('notiList').innerHTML = s.docs.map(d => `
                    <div style="padding:10px; border-bottom:1px solid #f1f5f9; cursor:pointer;" onclick="markRead('${d.id}')">
                        ${escapeHtml(d.data().msg)}
                    </div>
                `).join('') || '<p style="padding:20px; text-align:center; color:#94a3b8;">ìƒˆë¡œìš´ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            });
    }

    async function markRead(id) { await db.collection("notis").doc(id).update({ read: true }); }
    async function markAllRead() {
        const batch = db.batch();
        const unread = await db.collection("notis").where("to", "==", state.user.id).where("read", "==", false).get();
        unread.forEach(d => batch.update(d.ref, { read: true }));
        await batch.commit();
    }

    async function submitInquiry() {
        const text = document.getElementById('inqText').value.trim();
        if(!text) return;
        await db.collection("inquiries").add({ user: state.user.id, content: text, reply: null, date: Date.now() });
        alert("ë¬¸ì˜ê°€ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.");
        document.getElementById('inqText').value = '';
    }

    function setupInquiryListener() {
        db.collection("inquiries").onSnapshot(s => {
            const all = s.docs.map(d => ({ fId: d.id, ...d.data() }));
            if(state.user) {
                const mine = all.filter(i => i.user === state.user.id);
                document.getElementById('my-inq-status').innerHTML = mine.map(m => `
                    <div class="card">
                        <b>ì§ˆë¬¸:</b> ${escapeHtml(m.content)}<br>
                        <b style="color:var(--primary);">ë‹µë³€:</b> ${m.reply ? escapeHtml(m.reply) : 'ìš´ì˜ì§„ì˜ ë‹µë³€ì„ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘ì…ë‹ˆë‹¤.'}
                    </div>
                `).join('');
            }
            if(state.user?.role === 'admin') {
                document.getElementById('admin-inquiries').innerHTML = all.map(i => `
                    <div style="padding:10px; border-bottom:1px solid #eee;">
                        <b>${escapeHtml(i.user)}:</b> ${escapeHtml(i.content)}<br>
                        <button onclick="replyInquiry('${i.fId}')" class="btn btn-s" style="font-size:10px; padding:4px 8px;">ë‹µë³€ë‹¬ê¸°</button>
                    </div>
                `).join('');
            }
        });
    }

    async function replyInquiry(fId) {
        const reply = prompt("ë‹µë³€ì„ ì…ë ¥í•˜ì„¸ìš”:");
        if(reply) await db.collection("inquiries").doc(fId).update({ reply: escapeHtml(reply) });
    }

    function renderAdminReports() {
        db.collection("reports").orderBy("date", "desc").limit(10).onSnapshot(s => {
            document.getElementById('admin-reports').innerHTML = s.docs.map(d => `
                <div style="font-size:12px; margin-bottom:10px; padding:8px; background:#fff1f2; border-radius:8px;">
                    [${escapeHtml(d.data().type)}] ì‚¬ìœ : ${escapeHtml(d.data().reason)} <br>
                    ëŒ€ìƒID: ${escapeHtml(d.data().targetId)} (ì‘ì„±ì: ${escapeHtml(d.data().reporter)})
                </div>
            `).join('') || 'ì‹ ê³  ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.';
        });
    }

    async function deletePost() {
        if(confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            await db.collection("posts").doc(state.viewingId).delete();
            goHome();
        }
    }

    async function setPin() {
        const p = state.posts.find(x => x.fId === state.viewingId);
        await db.collection("posts").doc(state.viewingId).update({ isPinned: !p.isPinned });
        alert("ê³ ì • ìƒíƒœê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.");
    }

    function renderMyPage() {
        document.getElementById('my-id-display').innerText = state.user.id;
        const mine = state.posts.filter(p => p.author === state.user.id);
        document.getElementById('my-posts-list').innerHTML = mine.map(p => `
            <div class="list-item" onclick="viewDetail('${p.fId}')">
                ${escapeHtml(p.title)} <small>${escapeHtml(p.date)}</small>
            </div>
        `).join('') || 'ì‘ì„±í•œ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.';
    }

    function goHome() {
        state.viewingId = null;
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        document.getElementById('m-home').classList.add('active');
        showPage('home');
    }

    function checkWriteAuth() {
        if(!state.user) return alert("ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.");
        if(state.currentBoard === 'notice' && state.user.role !== 'admin') return alert("ê³µì§€ì‚¬í•­ì€ ê´€ë¦¬ìë§Œ ì‘ì„± ê°€ëŠ¥í•©ë‹ˆë‹¤.");
        openModal('writeModal');
    }

    function openModal(id) { document.getElementById(id).classList.add('active'); }
    function closeModal(id) { document.getElementById(id).classList.remove('active'); }
    function toggleNotiBox() { const b = document.getElementById('notiBox'); b.style.display = b.style.display === 'none' ? 'block' : 'none'; }

    window.onload = init;
</script>
</body>
</html>
