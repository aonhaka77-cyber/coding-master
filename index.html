<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì½”ë”© ë§ˆìŠ¤í„° - ì–¼í‹°ë°‹ ì—ë””ì…˜ V2</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        :root { --primary: #4f46e5; --bg: #f3f4f6; --text: #1f2937; --danger: #ef4444; --card: #ffffff; --tag: #dbeafe; --pinned: #fffbeb; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, sans-serif; }
        body { background: var(--bg); color: var(--text); padding-bottom: 80px; } /* ëª¨ë°”ì¼ í•˜ë‹¨ ì—¬ë°± */
        
        /* í—¤ë” & ë„¤ë¹„ê²Œì´ì…˜ */
        header { background: white; border-bottom: 1px solid #e5e7eb; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .header-top { max-width: 1200px; margin: 0 auto; padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; gap: 10px; }
        .logo { font-size: 20px; font-weight: 900; color: var(--primary); cursor: pointer; white-space: nowrap; }
        
        /* ê²€ìƒ‰ì°½ */
        .search-box { flex-grow: 1; max-width: 400px; position: relative; display: flex; align-items: center; }
        .search-inp { width: 100%; padding: 8px 15px; border-radius: 20px; border: 1px solid #ddd; background: #f9fafb; font-size: 13px; }
        
        .nav-menu { max-width: 1200px; margin: 0 auto; padding: 0 15px; display: flex; gap: 15px; overflow-x: auto; border-top: 1px solid #f3f4f6; -webkit-overflow-scrolling: touch; }
        .nav-menu::-webkit-scrollbar { display: none; } /* ìŠ¤í¬ë¡¤ë°” ìˆ¨ê¹€ */
        .nav-item { padding: 12px 5px; cursor: pointer; font-size: 14px; font-weight: 700; color: #6b7280; white-space: nowrap; border-bottom: 3px solid transparent; transition: 0.2s; }
        .nav-item.active { color: var(--primary); border-bottom-color: var(--primary); }

        /* ë ˆì´ì•„ì›ƒ */
        .main-container { max-width: 1200px; margin: 20px auto; padding: 0 15px; display: grid; grid-template-columns: 1fr 300px; gap: 20px; }
        @media (max-width: 900px) { 
            .main-container { grid-template-columns: 1fr; } 
            .sidebar { display: none; } /* ëª¨ë°”ì¼ì—ì„œ ì‚¬ì´ë“œë°” ìˆ¨ê¹€ (í•„ìš”ì‹œ í•˜ë‹¨ ì´ë™ ê°€ëŠ¥) */
        }

        /* í˜ì´ì§€ ì „í™˜ íš¨ê³¼ */
        .page { display: none; }
        .page.active { display: block; animation: slideUp 0.3s ease; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* ì¹´ë“œ & ë²„íŠ¼ UI */
        .card { background: var(--card); border-radius: 16px; padding: 20px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); margin-bottom: 20px; border: 1px solid #f3f4f6; }
        .btn { padding: 10px 18px; border: none; border-radius: 10px; cursor: pointer; font-weight: 700; transition: 0.2s; font-size: 13px; display: inline-flex; align-items: center; justify-content: center; gap: 5px; }
        .btn-p { background: var(--primary); color: white; }
        .btn-p:hover { background: #4338ca; }
        .btn-s { background: #f3f4f6; color: #4b5563; }
        .btn-danger { background: #fee2e2; color: var(--danger); }
        
        /* ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œ */
        .item-row { padding: 16px; border-bottom: 1px solid #f3f4f6; display: flex; justify-content: space-between; align-items: start; cursor: pointer; transition: 0.2s; }
        .item-row:hover { background: #f9fafb; }
        .item-row.pinned { background-color: var(--pinned); border-left: 3px solid #fbbf24; } /* ê³µì§€ì‚¬í•­ ìŠ¤íƒ€ì¼ */
        .tag { display: inline-block; padding: 2px 8px; background: var(--tag); color: #1e40af; border-radius: 6px; font-size: 11px; margin-right: 4px; font-weight: 600; }
        .hot-badge { background: #ef4444; color: white; font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: bold; margin-right: 5px; vertical-align: middle; }

        /* ëª¨ë‹¬ & í¼ */
        .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:2000; align-items:center; justify-content:center; backdrop-filter: blur(3px); }
        .modal.active { display: flex; }
        .modal-content { background:white; padding:25px; border-radius:20px; width:90%; max-width:450px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); max-height: 90vh; overflow-y: auto; }
        input, textarea, select { width:100%; padding:12px; margin-top:8px; border:1px solid #e5e7eb; border-radius:10px; font-size: 14px; outline: none; transition: 0.2s; }
        input:focus, textarea:focus { border-color: var(--primary); ring: 2px var(--primary); }

        /* ë±ƒì§€ */
        .noti-badge { position: relative; cursor: pointer; padding: 5px; }
        .badge-count { position: absolute; top:0; right:0; background: var(--danger); color: white; font-size: 10px; padding: 2px 5px; border-radius: 10px; font-weight: bold; }
        .role-badge { font-size: 10px; padding: 2px 6px; border-radius: 4px; margin-left: 5px; font-weight: bold; }
        .role-admin { background: #111; color: #fbbf24; }

        /* ë‚˜ë¬´ìœ„í‚¤ ë¬¸ë²• ìŠ¤íƒ€ì¼ */
        .namu-content h2 { font-size: 1.4em; border-bottom: 2px solid #ddd; margin: 15px 0 10px; padding-bottom: 5px; }
        .namu-content b { color: #d97706; }
        .namu-content del { color: #9ca3af; }
        .namu-content a { color: var(--primary); text-decoration: none; border-bottom: 1px dashed; }
        .namu-content blockquote { border-left: 4px solid var(--primary); padding-left: 10px; color: #555; background: #f9fafb; margin: 10px 0; }
        .namu-content img { max-width: 100%; border-radius: 8px; margin: 10px 0; display: block; }
    </style>
</head>
<body>

<header>
    <div class="header-top">
        <div class="logo" onclick="goHome()">ğŸš€ CODE MASTER</div>
        <div class="search-box">
            <input type="text" id="searchInput" class="search-inp" placeholder="ì œëª©, ë‚´ìš© ê²€ìƒ‰..." onkeyup="if(window.event.keyCode==13){handleSearch()}">
        </div>
        <div style="display:flex; align-items:center; gap: 5px;">
            <div class="noti-badge" onclick="toggleNoti()">ğŸ””<span id="notiCount" class="badge-count" style="display:none;">0</span></div>
            <div id="authBtn"><button class="btn btn-p" onclick="openModal('loginModal')" style="padding: 8px 12px;">ë¡œê·¸ì¸</button></div>
            <div id="userProfile" style="display:none; align-items:center; cursor:pointer;" onclick="showPage('mypage')">
                <div style="width:32px; height:32px; background:var(--primary); color:white; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:bold;" id="userAvatar">U</div>
            </div>
        </div>
    </div>
    <nav class="nav-menu">
        <div class="nav-item active" id="menu-home" onclick="goHome()">ğŸ  í™ˆ</div>
        <div class="nav-item" id="menu-notice" onclick="showBoard('notice')">ğŸ“¢ ê³µì§€</div>
        <div class="nav-item" id="menu-free" onclick="showBoard('free')">ğŸ’¬ ììœ </div>
        <div class="nav-item" id="menu-qna" onclick="showBoard('qna')">â“ Q&A</div>
        <div class="nav-item" id="menu-inquiry" onclick="showPage('inquiry')">ğŸ“® ë¬¸ì˜</div>
        <div class="nav-item" id="menu-admin" onclick="showPage('admin')" style="display:none; color:var(--danger)">ğŸ‘® ê´€ë¦¬ì</div>
    </nav>
</header>

<div class="main-container">
    <div class="content-left">
        <div id="page-home" class="page active">
            <div class="card">
                <h3 style="margin-bottom:15px;">ğŸ”¥ ì‹¤ì‹œê°„ ì¸ê¸° ê²Œì‹œê¸€ (ì¢‹ì•„ìš” 50+)</h3>
                <div id="home-hot-posts"></div>
            </div>
            <div class="card">
                <h3>ğŸ†• ì „ì²´ ìµœì‹ ê¸€</h3>
                <div id="home-posts"></div>
            </div>
        </div>

        <div id="page-board" class="page">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h2 id="board-title">ê²Œì‹œíŒ</h2>
                <button class="btn btn-p" onclick="openWriteModal()">âœï¸ ê¸€ì“°ê¸°</button>
            </div>
            <div id="post-list" class="card" style="padding:0; overflow:hidden;"></div>
        </div>

        <div id="page-detail" class="page">
            <div class="card">
                <div style="margin-bottom:10px;">
                    <span id="det-board" class="tag"></span>
                    <h1 id="det-title" style="font-size:1.5rem; margin-top:5px;"></h1>
                </div>
                <div style="display:flex; justify-content:space-between; color:#666; font-size:13px; border-bottom:1px solid #eee; padding-bottom:15px;">
                    <span id="det-author"></span>
                    <span id="det-date"></span>
                </div>
                
                <div id="det-body" class="namu-content" style="padding: 20px 0; min-height:150px; line-height:1.7;"></div>
                
                <div style="margin-top:20px; display:flex; gap:10px; justify-content:center;">
                    <button class="btn btn-s" id="likeBtn" onclick="handleLikeToggle()">â¤ï¸ ì¢‹ì•„ìš” <span id="like-count">0</span></button>
                </div>
                <div style="margin-top:15px; display:flex; justify-content:end; gap:10px;">
                    <button class="btn btn-p" id="pinBtn" style="display:none; background:#d97706;" onclick="togglePin()">ğŸ“Œ ê³µì§€ë“±ë¡</button>
                    <button class="btn btn-danger" id="delBtn" style="display:none;" onclick="deletePost()">ğŸ—‘ ì‚­ì œ</button>
                </div>
            </div>
            
            <div class="card">
                <h4>ëŒ“ê¸€ <span id="comm-count">0</span></h4>
                <div id="comm-list" style="margin:15px 0;"></div>
                <div style="display:flex; gap:10px;">
                    <input type="text" id="commInp" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš” (ì—”í„°ë¡œ ë“±ë¡)" onkeyup="if(window.event.keyCode==13){saveComment()}">
                    <button class="btn btn-p" onclick="saveComment()">ë“±ë¡</button>
                </div>
            </div>
        </div>

        <div id="page-mypage" class="page">
            <div class="card" style="text-align:center;">
                <h2 id="my-id-display">Guest</h2>
                <p id="my-role-display" style="color:#666; font-size:13px;">ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>
                <button class="btn btn-s" style="margin-top:10px;" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
            <div class="card"><h3>ğŸ“ ë‚´ê°€ ì“´ ê¸€</h3><div id="my-posts"></div></div>
            <div class="card"><h3>ğŸ’– ì¢‹ì•„ìš” í•œ ê¸€</h3><div id="my-likes"></div></div>
        </div>

        <div id="page-inquiry" class="page">
            <div class="card">
                <h2>ğŸ“® 1:1 ë¬¸ì˜</h2>
                <p style="color:#666; font-size:13px; margin-bottom:10px;">ìš´ì˜ì§„ ì „ì›ì—ê²Œ ì „ë‹¬ë©ë‹ˆë‹¤.</p>
                <textarea id="inqInp" rows="4" placeholder="ë¬¸ì˜ ë‚´ìš©ì„ ìì„¸íˆ ì ì–´ì£¼ì„¸ìš”."></textarea>
                <button class="btn btn-p" style="width:100%; margin-top:10px;" onclick="sendInquiry()">ë¬¸ì˜ ì ‘ìˆ˜</button>
            </div>
            <div id="my-inquiry-list"></div>
        </div>

        <div id="page-admin" class="page">
            <div class="card" style="background:#1f2937; color:white;">
                <h2>ğŸ‘‘ MASTER ADMIN</h2>
                <p>íšŒì› ê´€ë¦¬ ë° ì‹ ê³  ì²˜ë¦¬ë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤.</p>
            </div>
            <div class="card">
                <h3>ğŸš¨ íšŒì› ê´€ë¦¬ (ë°´/ë®¤íŠ¸)</h3>
                <div id="admin-user-list"></div>
            </div>
            <div class="card">
                <h3>ğŸ’¬ ì „ì²´ ë¬¸ì˜í•¨ (ìš´ì˜ì§„ ê³µìœ )</h3>
                <div id="admin-inq-list"></div>
            </div>
        </div>
    </div>

    <div class="sidebar">
        <div class="card">
            <h4>ğŸ“Š ì»¤ë®¤ë‹ˆí‹° í˜„í™©</h4>
            <div id="stats" style="font-size:13px; margin-top:10px; color:#666;">ë¡œë”©ì¤‘...</div>
        </div>
        <div class="card" style="background:#e0e7ff;">
            <h4>ğŸ’¡ íŒ</h4>
            <p style="font-size:12px; margin-top:5px;">
                <b>**ë³¼ë“œ**</b>ë¡œ êµµê²Œ,<br>
                <b>--ì·¨ì†Œì„ --</b>ìœ¼ë¡œ ì§€ì›€,<br>
                <b>[[ë§í¬]]</b>ë¡œ ì—°ê²° ê°€ëŠ¥!
            </p>
        </div>
    </div>
</div>

<div id="notiBox" class="card" style="display:none; position:fixed; top:60px; right:20px; width:300px; z-index:3000; border:1px solid #ddd; max-height:300px; overflow-y:auto;">
    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
        <b>ì•Œë¦¼</b>
        <span style="font-size:11px; cursor:pointer; color:blue;" onclick="clearNoti()">ëª¨ë‘ ì½ìŒ ì²˜ë¦¬</span>
    </div>
    <div id="notiList"></div>
</div>

<div class="modal" id="loginModal">
    <div class="modal-content">
        <h2 style="margin-bottom:15px;">ë¡œê·¸ì¸</h2>
        <input type="text" id="l-id" placeholder="ì•„ì´ë””">
        <input type="password" id="l-pw" placeholder="ë¹„ë°€ë²ˆí˜¸" onkeyup="if(window.event.keyCode==13){handleLogin()}">
        <button class="btn btn-p" style="width:100%; margin-top:15px;" onclick="handleLogin()">ë¡œê·¸ì¸</button>
        <button class="btn btn-s" style="width:100%; margin-top:5px;" onclick="handleJoin()">íšŒì›ê°€ì…</button>
        <button class="btn" style="width:100%; margin-top:10px;" onclick="closeModal('loginModal')">ë‹«ê¸°</button>
    </div>
</div>

<div class="modal" id="writeModal">
    <div class="modal-content" style="max-width:600px;">
        <h2 style="margin-bottom:15px;">ê¸€ ì‘ì„±</h2>
        <input type="text" id="w-title" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”">
        <input type="text" id="w-tag" placeholder="íƒœê·¸ (ì‰¼í‘œë¡œ êµ¬ë¶„, ì˜ˆ: ì •ë³´,ì§ˆë¬¸)">
        <div style="margin-top:10px; border:1px solid #ddd; padding:5px; border-radius:8px;">
            <span style="font-size:12px; color:#666;">ğŸ“· ì´ë¯¸ì§€ ì²¨ë¶€:</span>
            <input type="file" id="w-file" accept="image/*" style="border:none;">
        </div>
        <textarea id="w-content" rows="10" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”. ë‚˜ë¬´ìœ„í‚¤ ë¬¸ë²• ì§€ì›! (**ê°•ì¡°**, --ì·¨ì†Œ--, [[ë§í¬]])"></textarea>
        <div style="display:flex; gap:10px; margin-top:15px;">
            <button class="btn btn-p" style="flex:1;" onclick="savePost()">ì‘ì„± ì™„ë£Œ</button>
            <button class="btn btn-s" onclick="closeModal('writeModal')">ì·¨ì†Œ</button>
        </div>
    </div>
</div>

<script>
    /* =========================================
       1. FIREBASE CONFIG & INIT
       ========================================= */
    const firebaseConfig = {
        apiKey: "AIzaSyBcxvsiEOyL1lZGVr1UE2gzzZ7HQX5YfbI",
        authDomain: "code-78890.firebaseapp.com",
        projectId: "code-78890",
        storageBucket: "code-78890.firebasestorage.app",
        messagingSenderId: "30317586652",
        appId: "1:30317586652:web:d1e6fa39c319029fb7ac19"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const fdb = firebase.firestore();

    /* =========================================
       2. STATE & UTILS
       ========================================= */
    let state = { users:[], posts:[], currentBoard:'free', user:null, viewingId:null };

    // ë‚ ì§œ í¬ë§·
    const formatDate = (ts) => {
        if(!ts) return '';
        const d = ts.toDate ? ts.toDate() : new Date(ts);
        return `${d.getMonth()+1}/${d.getDate()} ${d.getHours()}:${d.getMinutes()}`;
    };

    // ë‚˜ë¬´ìœ„í‚¤ ë¬¸ë²• íŒŒì„œ
    const parseNamu = (text) => {
        if(!text) return '';
        let t = text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;"); // XSS ë°©ì§€
        t = t.replace(/'''(.*?)'''/g, '<b>$1</b>'); // êµµê²Œ '''text'''
        t = t.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>'); // êµµê²Œ **text**
        t = t.replace(/--(.*?)--/g, '<del>$1</del>'); // ì·¨ì†Œì„ 
        t = t.replace(/__(.*?)__/g, '<u>$1</u>'); // ë°‘ì¤„
        t = t.replace(/\[\[(http.*?)\]\]/g, '<a href="$1" target="_blank">$1</a>'); // ì™¸ë¶€ë§í¬
        t = t.replace(/> (.*)/g, '<blockquote>$1</blockquote>'); // ì¸ìš©
        t = t.replace(/\n/g, '<br>'); // ì¤„ë°”ê¿ˆ
        // ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ (Base64)
        t = t.replace(/\[ì´ë¯¸ì§€:(.*?)\]/g, '<img src="$1">');
        return t;
    };

    /* =========================================
       3. CORE LOGIC (DB LISTENERS)
       ========================================= */
    function init() {
        // Users ë¦¬ìŠ¤ë„ˆ
        fdb.collection("users").onSnapshot(s => {
            state.users = s.docs.map(d => ({fId: d.id, ...d.data()}));
            checkUserStatus(); // ë‚´ ìƒíƒœ(ë°´ ì—¬ë¶€) í™•ì¸
            if(state.user) renderMyPage();
            if(document.getElementById('page-admin').style.display === 'block') renderAdmin();
            updateStats();
        });

        // Posts ë¦¬ìŠ¤ë„ˆ
        fdb.collection("posts").orderBy("id", "desc").onSnapshot(s => {
            state.posts = s.docs.map(d => ({fId: d.id, ...d.data()}));
            refreshUI();
        });

        // Inquiry ë¦¬ìŠ¤ë„ˆ (ë¬¸ì˜)
        fdb.collection("inq").orderBy("date", "desc").onSnapshot(s => {
            const inqs = s.docs.map(d => ({fId: d.id, ...d.data()}));
            renderInquiries(inqs);
        });
    }

    function refreshUI() {
        if(document.getElementById('page-home').classList.contains('active')) renderHome();
        if(document.getElementById('page-board').classList.contains('active')) renderPostList();
        if(state.viewingId) renderDetail(state.viewingId); // ì¢‹ì•„ìš” ë“± ì‹¤ì‹œê°„ ê°±ì‹ 
        if(document.getElementById('page-mypage').classList.contains('active')) renderMyPage();
        updateStats();
    }

    /* =========================================
       4. AUTH & USER MANAGEMENT
       ========================================= */
    async function handleLogin() {
        const id = document.getElementById('l-id').value.trim();
        const pw = document.getElementById('l-pw').value.trim();
        
        // ë§ˆìŠ¤í„° ê³„ì • (í•˜ë“œì½”ë”©ëœ ë°±ë„ì–´ - ì‹¤ì œ ì„œë¹„ìŠ¤ì—” ì œê±° ê¶Œì¥)
        if(id === 'ê³„ì†ë°˜ë³µ' && pw === 'akdhs') {
            state.user = { id:'ê³„ì†ë°˜ë³µ', role:'admin', isMuted:false, isBanned:false };
            loginSuccess(); return;
        }

        const found = state.users.find(u => u.id === id && u.pw === pw);
        if(!found) return alert('ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë¦½ë‹ˆë‹¤.');
        if(found.isBanned) return alert('ğŸš« ìš´ì˜ì •ì±… ìœ„ë°˜ìœ¼ë¡œ ì´ìš©ì´ ì •ì§€ëœ ê³„ì •ì…ë‹ˆë‹¤.');

        state.user = found;
        loginSuccess();
    }

    async function handleJoin() {
        const id = document.getElementById('l-id').value.trim();
        const pw = document.getElementById('l-pw').value.trim();
        if(!id || !pw) return alert('ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
        if(state.users.find(u => u.id === id)) return alert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì•„ì´ë””ì…ë‹ˆë‹¤.');
        
        await fdb.collection("users").add({ 
            id, pw, role:'member', isMuted:false, isBanned:false, joinDate: new Date() 
        });
        alert('ê°€ì… ì„±ê³µ! ë¡œê·¸ì¸ í•´ì£¼ì„¸ìš”.');
    }

    function loginSuccess() {
        closeModal('loginModal');
        document.getElementById('authBtn').style.display = 'none';
        const profile = document.getElementById('userProfile');
        profile.style.display = 'flex';
        document.getElementById('userAvatar').innerText = state.user.id.substring(0,1).toUpperCase();
        
        if(state.user.role === 'admin') document.getElementById('menu-admin').style.display = 'block';
        setupNotiListener();
        showPage('home');
    }

    function logout() {
        state.user = null;
        window.location.reload();
    }

    function checkUserStatus() {
        if(state.user && state.user.id !== 'ê³„ì†ë°˜ë³µ') {
            const fresh = state.users.find(u => u.id === state.user.id);
            if(fresh) {
                state.user = fresh; // ì •ë³´ ê°±ì‹ 
                if(fresh.isBanned) { alert('ê´€ë¦¬ìì— ì˜í•´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.'); logout(); }
            }
        }
    }

    /* =========================================
       5. BOARD & POST FUNCTIONS
       ========================================= */
    function showBoard(b) {
        state.currentBoard = b;
        document.getElementById('board-title').innerText = 
            (b==='notice'?'ğŸ“¢ ê³µì§€ì‚¬í•­':(b==='free'?'ğŸ’¬ ììœ ê²Œì‹œíŒ':(b==='qna'?'â“ ì§ˆë¬¸&ë‹µë³€':'ğŸ” ê²€ìƒ‰ê²°ê³¼')));
        showPage('board');
        renderPostList();
    }

    function renderPostList(customList = null) {
        let list = customList || state.posts.filter(p => p.board === state.currentBoard);
        
        // ê³µì§€ì‚¬í•­ ìƒë‹¨ ê³ ì • (í•€)
        const pins = list.filter(p => p.isPinned);
        const normals = list.filter(p => !p.isPinned);
        list = [...pins, ...normals];

        const html = list.map(p => `
            <div class="item-row ${p.isPinned ? 'pinned' : ''}" onclick="viewPost('${p.fId}')">
                <div style="flex:1;">
                    <div style="font-size:15px; font-weight:bold; margin-bottom:4px;">
                        ${p.isPinned ? '<span class="tag" style="background:gold; color:black;">ê³µì§€</span>' : ''}
                        ${(p.likes>=50) ? '<span class="hot-badge">HOT</span>' : ''}
                        ${p.title}
                    </div>
                    <div style="font-size:12px; color:#888;">
                        ${(p.tags||[]).map(t=>`<span class="tag">#${t}</span>`).join('')}
                        ${p.author} Â· ì¡°íšŒ ${p.views||0}
                    </div>
                </div>
                <div style="text-align:right; min-width:50px;">
                    <span style="color:var(--danger); font-weight:bold; font-size:13px;">â¤ï¸ ${p.likes||0}</span>
                    <br><span style="color:#aaa; font-size:11px;">${formatDate(p.date).split(' ')[0]}</span>
                </div>
            </div>
        `).join('');
        document.getElementById('post-list').innerHTML = html || '<div style="padding:20px; text-align:center; color:#999;">ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
    }

    function renderHome() {
        // ì¸ê¸°ê¸€: ì¢‹ì•„ìš” 50ê°œ ì´ìƒë§Œ
        const hot = state.posts.filter(p => (p.likes||0) >= 50).sort((a,b)=>b.likes-a.likes).slice(0,5);
        document.getElementById('home-hot-posts').innerHTML = hot.length ? hot.map(p => `
            <div class="item-row" onclick="viewPost('${p.fId}')">
                <div><b>${p.title}</b> <small style="color:#666;">(${p.author})</small></div>
                <div style="color:red;">â¤ï¸ ${p.likes}</div>
            </div>
        `).join('') : '<div style="padding:10px; color:#999; font-size:13px;">ì•„ì§ ì¸ê¸°ê¸€ì´ ì—†ìŠµë‹ˆë‹¤. (ì¢‹ì•„ìš” 50ê°œ ë„ì „!)</div>';

        // ìµœì‹ ê¸€
        const recent = state.posts.slice(0, 7);
        document.getElementById('home-posts').innerHTML = recent.map(p => `
            <div class="item-row" onclick="viewPost('${p.fId}')">
                <div>
                    ${p.isPinned ? 'ğŸ“Œ ' : ''}${p.title}
                </div>
                <small>${formatDate(p.date)}</small>
            </div>
        `).join('');
    }

    async function savePost() {
        if(!state.user) return alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        if(state.user.isMuted) return alert('ğŸ¤ í˜„ì¬ "ë®¤íŠ¸" ìƒíƒœì—¬ì„œ ê¸€ì„ ì“¸ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        if(state.currentBoard === 'notice' && state.user.role !== 'admin') return alert('ê³µì§€ì‚¬í•­ì€ ìš´ì˜ìë§Œ ì‘ì„± ê°€ëŠ¥í•©ë‹ˆë‹¤.');

        const title = document.getElementById('w-title').value;
        const content = document.getElementById('w-content').value;
        const tags = document.getElementById('w-tag').value.split(',').filter(t=>t.trim()).map(t=>t.trim());
        const fileInp = document.getElementById('w-file');
        
        if(!title || !content) return alert('ì œëª©ê³¼ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.');

        let finalContent = content;
        
        // íŒŒì¼ ì²˜ë¦¬ (Base64ë¡œ ë³€í™˜í•˜ì—¬ ë³¸ë¬¸ì— íƒœê·¸ ì‚½ì…)
        if(fileInp.files && fileInp.files[0]) {
            const reader = new FileReader();
            reader.onload = async function(e) {
                const imgTag = `\n[ì´ë¯¸ì§€:${e.target.result}]`; 
                // ìš©ëŸ‰ ì œí•œ ê²½ê³  (Firestore ë¬¸ì„œëŠ” 1MB ì œí•œ)
                if(e.target.result.length > 800000) return alert('ì´ë¯¸ì§€ ìš©ëŸ‰ì´ ë„ˆë¬´ í½ë‹ˆë‹¤. ë” ì‘ì€ ì´ë¯¸ì§€ë¥¼ ì‚¬ìš©í•´ì£¼ì„¸ìš”.');
                
                await doSave(title, content + imgTag, tags);
            };
            reader.readAsDataURL(fileInp.files[0]);
        } else {
            await doSave(title, content, tags);
        }
    }

    async function doSave(title, content, tags) {
        await fdb.collection("posts").add({
            id: Date.now(),
            board: state.currentBoard,
            title, content, tags,
            author: state.user.id,
            date: new Date(),
            likes: 0, views: 0, likedBy: [], isPinned: false
        });
        closeModal('writeModal');
        document.getElementById('w-title').value='';
        document.getElementById('w-content').value='';
        document.getElementById('w-file').value='';
    }

    /* =========================================
       6. DETAIL & INTERACTION
       ========================================= */
    async function viewPost(fId) {
        state.viewingId = fId;
        // ì¡°íšŒìˆ˜ ì¦ê°€
        fdb.collection("posts").doc(fId).update({ views: firebase.firestore.FieldValue.increment(1) });
        showPage('detail');
        renderDetail(fId);
    }

    function renderDetail(fId) {
        const p = state.posts.find(x => x.fId === fId);
        if(!p) return;

        document.getElementById('det-board').innerText = p.board.toUpperCase();
        document.getElementById('det-title').innerText = p.title;
        document.getElementById('det-author').innerText = p.author;
        document.getElementById('det-date').innerText = formatDate(p.date);
        document.getElementById('det-body').innerHTML = parseNamu(p.content);
        document.getElementById('like-count').innerText = p.likes;

        // ì¢‹ì•„ìš” ë²„íŠ¼ ìƒíƒœ
        const liked = state.user && p.likedBy && p.likedBy.includes(state.user.id);
        const lBtn = document.getElementById('likeBtn');
        lBtn.className = liked ? 'btn btn-danger' : 'btn btn-s';
        lBtn.innerHTML = liked ? `â¤ï¸ ì¢‹ì•„ìš” ì·¨ì†Œ ${p.likes}` : `ğŸ¤ ì¢‹ì•„ìš” ${p.likes}`;

        // ê´€ë¦¬ì/ì‘ì„±ì ë²„íŠ¼
        const isAdmin = state.user && state.user.role === 'admin';
        const isAuthor = state.user && state.user.id === p.author;
        
        document.getElementById('delBtn').style.display = (isAdmin || isAuthor) ? 'block' : 'none';
        
        // í•€ ë²„íŠ¼ (ìš´ì˜ìë§Œ)
        const pinBtn = document.getElementById('pinBtn');
        if(isAdmin) {
            pinBtn.style.display = 'block';
            pinBtn.innerText = p.isPinned ? 'ğŸ“Œ ê³µì§€ í•´ì œ' : 'ğŸ“Œ ê³µì§€ ë“±ë¡';
            pinBtn.style.background = p.isPinned ? '#ccc' : '#d97706';
        } else {
            pinBtn.style.display = 'none';
        }

        loadComments(fId);
    }

    async function handleLikeToggle() {
        if(!state.user) return alert('ë¡œê·¸ì¸í•˜ì„¸ìš”.');
        const p = state.posts.find(x => x.fId === state.viewingId);
        const ref = fdb.collection("posts").doc(state.viewingId);
        const liked = p.likedBy && p.likedBy.includes(state.user.id);

        if(liked) {
            await ref.update({ likes: firebase.firestore.FieldValue.increment(-1), likedBy: firebase.firestore.FieldValue.arrayRemove(state.user.id) });
        } else {
            await ref.update({ likes: firebase.firestore.FieldValue.increment(1), likedBy: firebase.firestore.FieldValue.arrayUnion(state.user.id) });
        }
    }

    async function togglePin() {
        const p = state.posts.find(x => x.fId === state.viewingId);
        await fdb.collection("posts").doc(state.viewingId).update({ isPinned: !p.isPinned });
        alert(p.isPinned ? 'ê³µì§€ê°€ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ë©”ì¸ í™ˆì— ê³µì§€ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
    }

    async function deletePost() {
        if(confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            await fdb.collection("posts").doc(state.viewingId).delete();
            goHome();
        }
    }

    async function saveComment() {
        if(!state.user) return alert('ë¡œê·¸ì¸í•˜ì„¸ìš”.');
        if(state.user.isMuted) return alert('ë®¤íŠ¸ ìƒíƒœì…ë‹ˆë‹¤.');
        const text = document.getElementById('commInp').value;
        if(!text) return;

        await fdb.collection("comments").add({ postId: state.viewingId, user: state.user.id, text, date: new Date().toLocaleString() });
        document.getElementById('commInp').value = '';
        
        // ì•Œë¦¼ ì „ì†¡
        const p = state.posts.find(x => x.fId === state.viewingId);
        if(p.author !== state.user.id) {
            fdb.collection("notis").add({ to: p.author, msg: `ë‚´ ê¸€ì— ëŒ“ê¸€: ${text.substring(0,15)}...`, read: false });
        }
    }

    async function loadComments(pid) {
        const s = await fdb.collection("comments").where("postId","==",pid).get();
        const cs = s.docs.map(d=>d.data());
        document.getElementById('comm-count').innerText = cs.length;
        document.getElementById('comm-list').innerHTML = cs.map(c => 
            `<div style="padding:10px; background:#f9fafb; margin-bottom:5px; border-radius:8px; font-size:13px;">
                <b>${c.user}</b>: ${c.text} <span style="color:#aaa; font-size:10px; margin-left:5px;">${c.date}</span>
            </div>`
        ).join('');
    }

    /* =========================================
       7. ADMIN & INQUIRY
       ========================================= */
    function renderAdmin() {
        if(!state.user || state.user.role !== 'admin') return goHome();

        // ìœ ì € ê´€ë¦¬ ë¦¬ìŠ¤íŠ¸
        document.getElementById('admin-user-list').innerHTML = state.users.map(u => {
            if(u.id === 'ê³„ì†ë°˜ë³µ') return ''; // ë§ˆìŠ¤í„°ëŠ” ì œì™¸
            return `
            <div style="display:flex; justify-content:space-between; align-items:center; padding:10px; border-bottom:1px solid #eee; font-size:13px;">
                <div>
                    <b>${u.id}</b> (${u.role}) 
                    ${u.isBanned ? '<span style="color:red">[BANNED]</span>' : ''}
                    ${u.isMuted ? '<span style="color:orange">[MUTED]</span>' : ''}
                </div>
                <div style="display:flex; gap:5px;">
                    <button class="btn btn-s" style="padding:5px 10px; font-size:11px;" onclick="admAction('${u.fId}', 'mute', ${!u.isMuted})">${u.isMuted?'ì–¸ë®¤íŠ¸':'ë®¤íŠ¸'}</button>
                    <button class="btn btn-danger" style="padding:5px 10px; font-size:11px;" onclick="admAction('${u.fId}', 'ban', ${!u.isBanned})">${u.isBanned?'ì–¸ë°´':'ë°´(Kick)'}</button>
                </div>
            </div>`;
        }).join('');
    }

    async function admAction(uid, type, val) {
        if(type === 'mute') await fdb.collection("users").doc(uid).update({ isMuted: val });
        if(type === 'ban') await fdb.collection("users").doc(uid).update({ isBanned: val });
    }

    async function sendInquiry() {
        if(!state.user) return alert('ë¡œê·¸ì¸í•˜ì„¸ìš”.');
        const c = document.getElementById('inqInp').value;
        if(!c) return;
        await fdb.collection("inq").add({ user: state.user.id, content: c, date: new Date(), reply: null });
        alert('ë¬¸ì˜ê°€ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤. ìš´ì˜ì§„ì´ í™•ì¸ í›„ ë‹µë³€í•©ë‹ˆë‹¤.');
        document.getElementById('inqInp').value = '';
    }

    function renderInquiries(list) {
        // ë‚´ ë¬¸ì˜ (ì¼ë°˜ ìœ ì €)
        if(state.user) {
            const mine = list.filter(i => i.user === state.user.id);
            document.getElementById('my-inquiry-list').innerHTML = mine.map(i => `
                <div class="card" style="padding:15px; border:1px solid #eee;">
                    <div style="font-weight:bold; margin-bottom:5px;">Q. ${i.content}</div>
                    ${i.reply ? `<div style="background:#ecfdf5; padding:10px; border-radius:8px; color:#047857; font-size:13px;">A. ${i.reply}</div>` : '<span style="color:#d97706; font-size:12px;">ë‹µë³€ ëŒ€ê¸°ì¤‘...</span>'}
                </div>
            `).join('');
        }
        
        // ê´€ë¦¬ììš© (ì „ì²´ ë¬¸ì˜ ë³´ê¸°)
        if(state.user && state.user.role === 'admin') {
            document.getElementById('admin-inq-list').innerHTML = list.map(i => `
                <div class="card" style="padding:15px; background:#fffbeb;">
                    <div><b>${i.user}</b>: ${i.content}</div>
                    <div style="margin-top:10px;">
                        ${i.reply ? `âœ… ë‹µë³€: ${i.reply}` : `
                        <input id="rep-${i.fId}" placeholder="ë‹µë³€ ì…ë ¥" style="width:70%; display:inline-block;">
                        <button class="btn btn-p" style="padding:8px;" onclick="replyInq('${i.fId}')">ë“±ë¡</button>`}
                    </div>
                </div>
            `).join('');
        }
    }

    async function replyInq(fid) {
        const r = document.getElementById('rep-'+fid).value;
        await fdb.collection("inq").doc(fid).update({ reply: r });
    }

    /* =========================================
       8. MISC (Search, MyPage, Noti)
       ========================================= */
    function handleSearch() {
        const q = document.getElementById('searchInput').value.trim();
        if(!q) return;
        // í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ ê²€ìƒ‰ (ì œëª©+ë‚´ìš©)
        const res = state.posts.filter(p => p.title.includes(q) || p.content.includes(q));
        state.currentBoard = 'search';
        showPage('board');
        document.getElementById('board-title').innerText = `'${q}' ê²€ìƒ‰ ê²°ê³¼ (${res.length})`;
        renderPostList(res);
    }

    function renderMyPage() {
        if(!state.user) return;
        document.getElementById('my-id-display').innerText = state.user.id;
        document.getElementById('my-role-display').innerText = state.user.role === 'admin' ? 'ğŸ‘‘ ê´€ë¦¬ì' : 'ğŸŒ± ì¼ë°˜ ë©¤ë²„';
        
        const myP = state.posts.filter(p => p.author === state.user.id);
        const myL = state.posts.filter(p => p.likedBy && p.likedBy.includes(state.user.id));
        
        document.getElementById('my-posts').innerHTML = myP.map(p => 
            `<div class="item-row" onclick="viewPost('${p.fId}')">${p.title} <span style="font-size:12px; color:#888;">${p.likes}â¤ï¸</span></div>`
        ).join('') || 'ì‘ì„±í•œ ê¸€ ì—†ìŒ';
        
        document.getElementById('my-likes').innerHTML = myL.map(p => 
            `<div class="item-row" onclick="viewPost('${p.fId}')">${p.title}</div>`
        ).join('') || 'ì¢‹ì•„ìš” í•œ ê¸€ ì—†ìŒ';
    }

    function setupNotiListener() {
        if(!state.user) return;
        fdb.collection("notis").where("to","==",state.user.id).where("read","==",false).onSnapshot(s => {
            const list = s.docs.map(d => ({fId:d.id, ...d.data()}));
            const nCnt = document.getElementById('notiCount');
            nCnt.innerText = list.length;
            nCnt.style.display = list.length > 0 ? 'block' : 'none';
            document.getElementById('notiList').innerHTML = list.map(n => `<div style="padding:10px; border-bottom:1px solid #eee;">${n.msg}</div>`).join('');
        });
    }

    async function clearNoti() {
        const s = await fdb.collection("notis").where("to","==",state.user.id).get();
        s.forEach(d => d.ref.update({read:true}));
        toggleNoti();
    }

    function toggleNoti() { const b=document.getElementById('notiBox'); b.style.display = (b.style.display==='none'?'block':'none'); }
    function openModal(id) { document.getElementById(id).classList.add('active'); }
    function closeModal(id) { document.getElementById(id).classList.remove('active'); }
    function openWriteModal() { if(!state.user) return alert('ë¡œê·¸ì¸í•˜ì„¸ìš”.'); openModal('writeModal'); }
    function goHome() { showPage('home'); renderHome(); }
    function showPage(p) {
        document.querySelectorAll('.page').forEach(e => e.classList.remove('active'));
        document.getElementById('page-'+p).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
        const m = document.getElementById('menu-'+p);
        if(m) m.classList.add('active');
        if(p==='admin') renderAdmin();
    }
    function updateStats() { document.getElementById('stats').innerText = `ì´ ê²Œì‹œê¸€: ${state.posts.length}ê°œ | ì´ íšŒì›: ${state.users.length}ëª…`; }

    // ì‹œì‘
    window.onload = init;
</script>
</body>
</html>
