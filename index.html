<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coding Master | Admin & Community</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">

    <style>
        :root { --primary: #4f46e5; --bg: #f8fafc; }
        body { background: var(--bg); font-family: 'Pretendard', sans-serif; color: #1e293b; }
        .navbar { background: white; border-bottom: 1px solid #e2e8f0; }
        .sidebar-link { border-radius: 12px; margin-bottom: 4px; transition: 0.2s; cursor: pointer; text-decoration: none; color: #64748b; display: block; padding: 12px 16px; }
        .sidebar-link:hover { background: #f1f5f9; color: var(--primary); }
        .sidebar-link.active { background: var(--primary) !important; color: white !important; font-weight: 600; }
        .card { border: none; border-radius: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.03); }
        .post-card { transition: 0.3s; border: 1px solid transparent; }
        .post-card:hover { transform: translateY(-5px); border-color: #e2e8f0; }
        .badge-notice { background: #fee2e2; color: #ef4444; }
        .badge-qna { background: #fef3c7; color: #d97706; }
        .badge-free { background: #e0f2fe; color: #0ea5e9; }
        .noti-badge { position: absolute; top: -2px; right: -2px; font-size: 0.7rem; border: 2px solid white; }
        /* XSS ë°©ì§€ë¥¼ ìœ„í•œ í…ìŠ¤íŠ¸ ì²˜ë¦¬ ìŠ¤íƒ€ì¼ */
        .content-area { white-space: pre-wrap; word-break: break-all; line-height: 1.7; }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg sticky-top mb-4">
        <div class="container">
            <a class="navbar-brand fw-bold text-primary" onclick="showPage('home')" style="cursor:pointer">ğŸš€ Coding Master</a>
            <div class="d-flex align-items-center">
                <div id="auth-zone" class="me-3"></div>
                <div class="position-relative" onclick="showPage('noti')" style="cursor:pointer">
                    <span style="font-size: 1.5rem;">ğŸ””</span>
                    <span id="noti-count" class="badge rounded-pill bg-danger noti-badge" style="display:none">0</span>
                </div>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="row">
            <div class="col-md-3 mb-4">
                <div class="card p-3 shadow-sm sticky-top" style="top: 90px;">
                    <div class="list-group list-group-flush">
                        <small class="text-muted px-3 mb-2 fw-bold">BOARD</small>
                        <a class="sidebar-link active" id="menu-all" onclick="filterCategory('all')">ğŸ  ì „ì²´ ê²Œì‹œê¸€</a>
                        <a class="sidebar-link" id="menu-notice" onclick="filterCategory('notice')">ğŸ“¢ ê³µì§€ì‚¬í•­</a>
                        <a class="sidebar-link" id="menu-free" onclick="filterCategory('free')">ğŸŒ± ììœ ê²Œì‹œíŒ</a>
                        <a class="sidebar-link" id="menu-qna" onclick="filterCategory('qna')">â“ Q&A / ê±´ì˜</a>
                        <hr>
                        <a class="sidebar-link" onclick="handleWriteAccess()">âœï¸ ìƒˆ ê¸€ ì‘ì„±</a>
                        <a class="sidebar-link" onclick="showPage('inquiry')">ğŸ’¬ 1:1 ë¬¸ì˜</a>
                        <div id="admin-menu" style="display:none">
                            <hr>
                            <small class="text-danger px-3 mb-2 fw-bold">ADMIN PANEL</small>
                            <a class="sidebar-link text-danger" onclick="showPage('admin')">âš™ï¸ ê´€ë¦¬ì ì„¼í„°</a>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-9">
                <div id="page-home" class="page-content">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h4 class="fw-bold m-0" id="board-title">ì»¤ë®¤ë‹ˆí‹° ê´‘ì¥</h4>
                        <div class="dropdown">
                            <button class="btn btn-white btn-sm shadow-sm dropdown-toggle" data-bs-toggle="dropdown">ìµœì‹ ìˆœ</button>
                        </div>
                    </div>
                    <div id="post-list" class="row g-4"></div>
                </div>

                <div id="page-write" class="page-content" style="display:none">
                    <div class="card p-4">
                        <h4 class="fw-bold mb-4">âœï¸ í¬ìŠ¤íŠ¸ ì‘ì„±</h4>
                        <select id="postCategory" class="form-select mb-3 border-0 bg-light p-3">
                            <option value="free">ììœ ê²Œì‹œíŒ</option>
                            <option value="qna">Q&A (ì§ˆë¬¸/ê±´ì˜)</option>
                            <option value="notice" id="opt-notice" style="display:none">ê³µì§€ì‚¬í•­ (ìš´ì˜ì)</option>
                        </select>
                        <input id="postTitle" class="form-control mb-3 p-3 border-0 bg-light" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”">
                        <textarea id="postContent" class="form-control mb-3 p-3 border-0 bg-light" rows="12" placeholder="ì½”ë“œë‚˜ ì§€ì‹ì„ ê³µìœ í•´ ì£¼ì„¸ìš”..."></textarea>
                        <div class="mb-4">
                            <label class="form-label small fw-bold">ğŸ“ íŒŒì¼ ì²¨ë¶€</label>
                            <input type="file" id="postFile" class="form-control border-0 bg-light">
                        </div>
                        <button id="uploadBtn" class="btn btn-primary w-100 fw-bold p-3" onclick="uploadPost()">ê²Œì‹œë¬¼ ë“±ë¡</button>
                    </div>
                </div>

                <div id="page-view" class="page-content" style="display:none">
                    <div class="card p-4 mb-4">
                        <div id="post-detail"></div>
                        <hr class="my-4">
                        <h5 class="fw-bold mb-4">ëŒ“ê¸€ <span id="comment-total" class="text-primary">0</span></h5>
                        <div id="comment-list" class="mb-4"></div>
                        <div class="input-group shadow-sm">
                            <input id="commInput" class="form-control border-0 p-3 bg-light" placeholder="ë”°ëœ»í•œ ëŒ“ê¸€ì„ ë‚¨ê²¨ì£¼ì„¸ìš”.">
                            <button class="btn btn-primary px-4" onclick="addComment()">ë“±ë¡</button>
                        </div>
                    </div>
                </div>

                <div id="page-admin" class="page-content" style="display:none">
                    <h4 class="fw-bold mb-4 text-danger">âš™ï¸ ê´€ë¦¬ì: 1:1 ë¬¸ì˜ ê´€ë¦¬</h4>
                    <div id="admin-inquiry-list"></div>
                </div>

                <div id="page-noti" class="page-content" style="display:none">
                    <h4 class="fw-bold mb-4">ğŸ”” ë‚´ ì•Œë¦¼</h4>
                    <div id="noti-list"></div>
                </div>

                <div id="page-inquiry" class="page-content" style="display:none">
                    <div class="card p-4 mb-4">
                        <h4 class="fw-bold">ğŸ’¬ ìš´ì˜ì§„ ë¬¸ì˜</h4>
                        <p class="text-muted small">ê¸°ëŠ¥ ì¶”ê°€ ì œì•ˆì´ë‚˜ ë²„ê·¸ ë¦¬í¬íŠ¸ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”.</p>
                        <textarea id="inqInput" class="form-control mb-3 border-0 bg-light" rows="3" placeholder="ë‚´ìš©ì„ ì‘ì„±í•˜ì„¸ìš”."></textarea>
                        <button class="btn btn-dark w-100 p-3 fw-bold" onclick="sendInquiry()">ë¬¸ì˜ ì ‘ìˆ˜í•˜ê¸°</button>
                    </div>
                    <h5 class="fw-bold mb-3">ë‚´ ë¬¸ì˜ ê¸°ë¡</h5>
                    <div id="my-inq-list"></div>
                </div>

                <div id="page-auth" class="page-content" style="display:none">
                    <div class="card p-5 mx-auto text-center" style="max-width: 450px;">
                        <h3 class="fw-bold mb-4">Welcome!</h3>
                        <input id="authEmail" class="form-control mb-3 p-3" placeholder="ì´ë©”ì¼ ì£¼ì†Œ">
                        <input id="authPassword" type="password" class="form-control mb-3 p-3" placeholder="ë¹„ë°€ë²ˆí˜¸">
                        <button class="btn btn-primary w-100 p-3 fw-bold mb-3" onclick="handleLogin()">ë¡œê·¸ì¸</button>
                        <button class="btn btn-link text-decoration-none text-muted" onclick="handleSignUp()">ì´ë©”ì¼ë¡œ íšŒì›ê°€ì…</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // 1. Firebase Config (ìœ ì§€)
        const firebaseConfig = {
            apiKey: "AIzaSyBcxvsiEOyL1lZGVr1UE2gzzZ7HQX5YfbI",
            authDomain: "code-78890.firebaseapp.com",
            projectId: "code-78890",
            storageBucket: "code-78890.appspot.com",
            messagingSenderId: "33834164177",
            appId: "1:33834164177:web:866380c541434386266f81"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        // 2. ì „ì—­ ìƒíƒœ
        let state = { user: null, posts: [], currentCat: 'all', viewingId: null };

        // 3. ë³´ì•ˆ: í…ìŠ¤íŠ¸ ì´ìŠ¤ì¼€ì´í”„ (XSS ë°©ì§€)
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // 4. ì¸ì¦ ë° ìš´ì˜ì ì²´í¬
        auth.onAuthStateChanged(async (user) => {
            const authZone = document.getElementById('auth-zone');
            if (user) {
                // DBì—ì„œ role í™•ì¸ (ì‚¬ìš©ìê°€ ì˜¬ë¦° ì´ë¯¸ì§€ì˜ role: "member"/"admin" ì°¸ì¡°)
                const userDoc = await db.collection("users").doc(user.uid).get();
                const userData = userDoc.exists ? userDoc.data() : { id: user.email.split('@')[0], role: 'member' };
                
                state.user = { uid: user.uid, ...userData };
                
                authZone.innerHTML = `
                    <span class="me-2 fw-bold small text-secondary">${state.user.role === 'admin' ? 'ğŸ›¡ï¸ ê´€ë¦¬ì ' : ''}${escapeHtml(state.user.id)}ë‹˜</span>
                    <button class="btn btn-sm btn-outline-secondary border-0" onclick="auth.signOut()">ë¡œê·¸ì•„ì›ƒ</button>
                `;
                
                if(state.user.role === 'admin') {
                    document.getElementById('admin-menu').style.display = 'block';
                    document.getElementById('opt-notice').style.display = 'block';
                }
                loadNotis();
            } else {
                state.user = null;
                authZone.innerHTML = `<button class="btn btn-sm btn-primary px-3" onclick="showPage('auth')">ë¡œê·¸ì¸</button>`;
                document.getElementById('admin-menu').style.display = 'none';
                document.getElementById('opt-notice').style.display = 'none';
            }
        });

        // 5. í˜ì´ì§€ ì „í™˜ ë° ê¶Œí•œ ì œì–´
        function showPage(pageId) {
            document.querySelectorAll('.page-content').forEach(p => p.style.display = 'none');
            document.getElementById('page-' + pageId).style.display = 'block';
            
            if(pageId === 'admin') {
                if(state.user?.role !== 'admin') { alert("ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤."); showPage('home'); return; }
                loadAdminInquiries();
            }
            if(pageId === 'inquiry' && state.user) loadMyInquiries();
            window.scrollTo(0,0);
        }

        function handleWriteAccess() {
            if(!state.user) { alert("ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤."); showPage('auth'); return; }
            showPage('write');
        }

        function filterCategory(cat) {
            state.currentCat = cat;
            document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
            document.getElementById('menu-' + cat).classList.add('active');
            renderPosts();
            showPage('home');
        }

        // 6. ë°ì´í„° ë¡œë”© (ì¸ë±ìŠ¤ ì—ëŸ¬ ê°ì§€ í¬í•¨)
        function loadData() {
            db.collection("posts").orderBy("date", "desc").onSnapshot(snap => {
                state.posts = snap.docs.map(d => ({ fId: d.id, ...d.data() }));
                renderPosts();
                if(state.viewingId) renderDetail();
            }, err => {
                console.error(err);
                if(err.message.includes("index")) {
                    alert("ì¸ë±ìŠ¤ ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤. ì½˜ì†”ì°½ì˜ ë§í¬ë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”.");
                }
            });
        }

        function renderPosts() {
            const list = document.getElementById('post-list');
            // ì¹´í…Œê³ ë¦¬ ì—†ëŠ” ê¸°ì¡´ ë°ì´í„°ëŠ” 'free'ë¡œ ê¸°ë³¸ê°’ ì„¤ì •
            const filtered = state.currentCat === 'all' 
                ? state.posts 
                : state.posts.filter(p => (p.category || 'free') === state.currentCat);
            
            if(filtered.length === 0) {
                list.innerHTML = `<div class="text-center py-5 text-muted">ì•„ì§ ë“±ë¡ëœ ê²Œì‹œê¸€ë¬¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
                return;
            }

            list.innerHTML = filtered.map(p => `
                <div class="col-md-6">
                    <div class="card h-100 p-4 post-card" onclick="viewPost('${p.fId}')" style="cursor:pointer">
                        <div class="mb-3 d-flex justify-content-between">
                            <span class="badge badge-${p.category || 'free'} small">
                                ${p.category === 'notice' ? 'ğŸ“¢ ê³µì§€' : p.category === 'qna' ? 'â“ Q&A' : 'ğŸŒ± ììœ '}
                            </span>
                            ${p.fileUrl ? '<span class="text-muted small">ğŸ“ ì²¨ë¶€íŒŒì¼</span>' : ''}
                        </div>
                        <h5 class="fw-bold mb-2 text-truncate">${escapeHtml(p.title)}</h5>
                        <p class="text-muted small text-truncate-2" style="min-height:2.8rem">${escapeHtml(p.content.substring(0, 90))}</p>
                        <div class="d-flex justify-content-between align-items-center mt-3 pt-3 border-top">
                            <span class="small text-secondary fw-bold">ğŸ‘¤ ${escapeHtml(p.authorId)}</span>
                            <span class="text-danger small fw-bold">â¤ï¸ ${p.likes || 0}</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // 7. ê²Œì‹œê¸€ ìƒì„¸ ë° CRUD
        async function uploadPost() {
            if(!state.user) return alert("ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.");
            const title = document.getElementById('postTitle').value.trim();
            const content = document.getElementById('postContent').value.trim();
            const category = document.getElementById('postCategory').value;
            const file = document.getElementById('postFile').files[0];
            const btn = document.getElementById('uploadBtn');

            if(!title || !content) return alert("ì œëª©ê³¼ ë‚´ìš©ì„ ëª¨ë‘ ì…ë ¥í•´ ì£¼ì„¸ìš”.");
            
            btn.disabled = true; btn.innerText = "ë°ì´í„° ì²˜ë¦¬ ì¤‘...";

            try {
                let fileUrl = null, fileName = null;
                if(file) {
                    const ref = storage.ref(`uploads/${Date.now()}_${file.name}`);
                    await ref.put(file);
                    fileUrl = await ref.getDownloadURL();
                    fileName = file.name;
                }

                await db.collection("posts").add({
                    title, content, category, fileUrl, fileName,
                    authorId: state.user.id, authorUid: state.user.uid,
                    date: Date.now(), likes: 0, likedBy: []
                });
                
                alert("ê²Œì‹œê¸€ì´ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!");
                location.reload();
            } catch(e) { 
                alert("ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜: " + e.message); 
                btn.disabled = false; btn.innerText = "ê²Œì‹œë¬¼ ë“±ë¡";
            }
        }

        function viewPost(id) {
            state.viewingId = id; showPage('view'); renderDetail(); loadComments(id);
        }

        function renderDetail() {
            const p = state.posts.find(x => x.fId === state.viewingId);
            if(!p) return;
            const isLiked = p.likedBy?.includes(state.user?.uid);
            
            document.getElementById('post-detail').innerHTML = `
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <h2 class="fw-bold m-0">${escapeHtml(p.title)}</h2>
                    ${(p.authorUid === state.user?.uid || state.user?.role === 'admin') ? 
                        `<button class="btn btn-sm btn-outline-danger" onclick="deletePost('${p.fId}')">ì‚­ì œí•˜ê¸°</button>` : ''}
                </div>
                <div class="mb-4 text-muted small">
                    <span class="fw-bold text-dark">${escapeHtml(p.authorId)}</span> <span class="mx-2">|</span> ${new Date(p.date).toLocaleString()}
                </div>
                <div class="content-area mb-5">${escapeHtml(p.content)}</div>
                ${p.fileUrl ? `
                    <div class="p-3 bg-light rounded-4 d-flex justify-content-between align-items-center mb-5 border">
                        <span class="small fw-bold">ğŸ“ ì²¨ë¶€íŒŒì¼: ${escapeHtml(p.fileName)}</span>
                        <a href="${p.fileUrl}" target="_blank" class="btn btn-sm btn-dark px-3">ë‹¤ìš´ë¡œë“œ</a>
                    </div>
                ` : ''}
                <div class="text-center">
                    <button class="btn ${isLiked ? 'btn-danger' : 'btn-outline-danger'} px-5 py-2 rounded-pill fw-bold" onclick="handleLike()">
                        â¤ï¸ ì¢‹ì•„ìš” ${p.likes || 0}
                    </button>
                </div>
            `;
        }

        async function deletePost(id) {
            if(confirm("ì •ë§ë¡œ ì´ ê²Œì‹œê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                await db.collection("posts").doc(id).delete();
                alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                showPage('home');
            }
        }

        // 8. 1:1 ë¬¸ì˜ & ê´€ë¦¬ì ê¸°ëŠ¥
        async function sendInquiry() {
            const txt = document.getElementById('inqInput').value.trim();
            if(!txt || !state.user) return alert("ë‚´ìš©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.");
            await db.collection("inquiries").add({
                userUid: state.user.uid, userId: state.user.id,
                content: txt, answer: null, date: Date.now()
            });
            alert("ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜ê°€ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.");
            document.getElementById('inqInput').value = '';
            loadMyInquiries();
        }

        async function loadAdminInquiries() {
            const snap = await db.collection("inquiries").orderBy("date", "desc").get();
            const list = document.getElementById('admin-inquiry-list');
            list.innerHTML = snap.docs.map(d => {
                const data = d.data();
                return `
                    <div class="card p-4 mb-3">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="badge bg-secondary">From: ${escapeHtml(data.userId)}</span>
                            <span class="small text-muted">${new Date(data.date).toLocaleDateString()}</span>
                        </div>
                        <div class="fw-bold mb-3 fs-5">ì§ˆë¬¸: ${escapeHtml(data.content)}</div>
                        ${data.answer ? `<div class="p-3 bg-light text-primary rounded-3 small fw-bold">ë‹µë³€: ${escapeHtml(data.answer)}</div>` : `
                            <div class="input-group">
                                <input id="ans-${d.id}" class="form-control p-2" placeholder="ë‹µë³€ ë‚´ìš©ì„ ì‘ì„±í•˜ì„¸ìš”">
                                <button class="btn btn-primary px-4" onclick="answerInquiry('${d.id}', '${data.userUid}')">ë‹µë³€ë“±ë¡</button>
                            </div>
                        `}
                    </div>
                `;
            }).join('');
        }

        async function answerInquiry(id, userUid) {
            const ans = document.getElementById(`ans-${id}`).value;
            if(!ans) return;
            await db.collection("inquiries").doc(id).update({ answer: ans });
            sendNoti(userUid, `ğŸ’¬ ë¬¸ì˜í•˜ì‹  ë‚´ìš©ì— ëŒ€í•œ ìš´ì˜ìì˜ ë‹µë³€ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            loadAdminInquiries();
        }

        function loadMyInquiries() {
            db.collection("inquiries").where("userUid", "==", state.user.uid).orderBy("date", "desc").onSnapshot(snap => {
                document.getElementById('my-inq-list').innerHTML = snap.docs.map(d => `
                    <div class="card p-3 mb-2 border-0 shadow-sm">
                        <div class="small fw-bold mb-1">Q: ${escapeHtml(d.data().content)}</div>
                        <div class="mt-2 p-2 rounded bg-light small ${d.data().answer ? 'text-primary' : 'text-muted'}">
                            ${d.data().answer ? 'âœ… ë‹µë³€: ' + escapeHtml(d.data().answer) : 'â³ ë‹µë³€ ëŒ€ê¸° ì¤‘ì…ë‹ˆë‹¤.'}
                        </div>
                    </div>
                `).join('');
            });
        }

        // 9. ì•Œë¦¼, ì¢‹ì•„ìš”, ëŒ“ê¸€ (ìœ ì§€)
        async function sendNoti(to, msg) {
            await db.collection("notis").add({ to, msg, read: false, date: Date.now() });
        }

        function loadNotis() {
            db.collection("notis").where("to", "==", state.user.uid).orderBy("date", "desc").onSnapshot(snap => {
                const unread = snap.docs.filter(d => !d.data().read).length;
                const badge = document.getElementById('noti-count');
                badge.innerText = unread;
                badge.style.display = unread > 0 ? 'block' : 'none';
                
                document.getElementById('noti-list').innerHTML = snap.docs.map(d => `
                    <div class="card p-3 mb-2 ${d.data().read ? 'opacity-50' : 'border-primary'}" 
                         onclick="db.collection('notis').doc('${d.id}').update({read:true})">
                        ${escapeHtml(d.data().msg)}
                    </div>
                `).join('');
            });
        }

        async function handleLike() {
            if(!state.user) return alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
            const p = state.posts.find(x => x.fId === state.viewingId);
            const ref = db.collection("posts").doc(state.viewingId);
            if(p.likedBy?.includes(state.user.uid)) {
                await ref.update({ likes: firebase.firestore.FieldValue.increment(-1), likedBy: firebase.firestore.FieldValue.arrayRemove(state.user.uid) });
            } else {
                await ref.update({ likes: firebase.firestore.FieldValue.increment(1), likedBy: firebase.firestore.FieldValue.arrayUnion(state.user.uid) });
                if(p.authorUid !== state.user.uid) sendNoti(p.authorUid, `â¤ï¸ ëˆ„êµ°ê°€ ë‚´ ê¸€ '${p.title.substring(0,10)}...'ì„ ì¢‹ì•„í•©ë‹ˆë‹¤.`);
            }
        }

        async function addComment() {
            const val = document.getElementById('commInput').value.trim();
            if(!val || !state.user) return;
            const p = state.posts.find(x => x.fId === state.viewingId);
            await db.collection("comments").add({ postId: state.viewingId, author: state.user.id, text: val, date: Date.now() });
            document.getElementById('commInput').value = '';
            if(p.authorUid !== state.user.uid) sendNoti(p.authorUid, `ğŸ’¬ '${p.title.substring(0,10)}...' ê¸€ì— ìƒˆ ëŒ“ê¸€ì´ ë‹¬ë ¸ìŠµë‹ˆë‹¤.`);
        }

        function loadComments(postId) {
            db.collection("comments").where("postId", "==", postId).orderBy("date", "asc").onSnapshot(snap => {
                document.getElementById('comment-total').innerText = snap.size;
                document.getElementById('comment-list').innerHTML = snap.docs.map(d => `
                    <div class="p-3 mb-2 rounded-4 bg-light small">
                        <div class="fw-bold text-primary mb-1">${escapeHtml(d.data().author)}</div>
                        <div>${escapeHtml(d.data().text)}</div>
                    </div>
                `).join('');
            });
        }

        // 10. ë¡œê·¸ì¸/ê°€ì… (ìœ ì§€)
        async function handleLogin() {
            const email = document.getElementById('authEmail').value;
            const pw = document.getElementById('authPassword').value;
            try { await auth.signInWithEmailAndPassword(email, pw); showPage('home'); } catch(e) { alert("ê³„ì • ì •ë³´ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤."); }
        }
        
        async function handleSignUp() {
            const email = document.getElementById('authEmail').value;
            const pw = document.getElementById('authPassword').value;
            if(!email || pw.length < 6) return alert("ì˜¬ë°”ë¥¸ ì´ë©”ì¼ê³¼ 6ìë¦¬ ì´ìƒì˜ ë¹„ë²ˆì„ ì…ë ¥í•˜ì„¸ìš”.");
            try {
                const cred = await auth.createUserWithEmailAndPassword(email, pw);
                await db.collection("users").doc(cred.user.uid).set({
                    id: email.split('@')[0], role: 'member', date: Date.now()
                });
                alert("ê°€ì…ì„ ì¶•í•˜ë“œë¦½ë‹ˆë‹¤!"); showPage('home');
            } catch(e) { alert(e.message); }
        }

        // ì‹¤í–‰
        loadData();
    </script>
</body>
</html>
